---
word_document: default
author: "Cody Szuwalski"
date: "Sept 16, 2016"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 6
  word_document: default
number_sections: yes
csl: fish-and-fisheries.csl
toc: yes
title: "A stock assessment for eastern Bering Sea snow crab"
---

\newpage

# Executive summary

```{r,echo=F,message=FALSE}
library(knitr)
library(ggplot2)
library(PBSmodelling)
library(pander)

# directory in which all of the scenario folder reside and names of the scenario folders
TakeDir     <-"C:/SnowCrab/"
Scenarios   <-c("Base 5 Francis","Model 2a MatPrior","Model 3b SmoothMat_Disc50")
#==This gets the counters that are constant from scenario to scenario
# Read data file
DATfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.DAT",sep=""))

# length of data types
tmp<-grep("number of years of retained fishery data",DATfile)
CatchYrN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of survey data",DATfile)
SurvYrN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of fishery discard",DATfile)
DiscYrFN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of fishery male discard",DATfile)
DiscYrMN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of trawl discard",DATfile)
TrawlYrN <-as.numeric(DATfile[tmp+1])

# observed retained catch
tmp<-grep("retained catch in numbers",DATfile)
ObsCatchNumbers<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]
tmp<-grep("retained catch in pounds",DATfile)
ObsCatchPounds<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]
tmp<-grep("years for fishery data",DATfile)
RetCatchYrs<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))

# observed discard
tmp<-grep("Discard Catch from observer",DATfile)
ObsDiscF<-as.numeric(DATfile[(tmp+2):(tmp+1+CatchYrN)])[1:CatchYrN]
tmp<-grep("discard catch males",DATfile)
ObsDiscM<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]

# observed trawl
tmp<-grep("trawl bycatch numbers by geartype",DATfile)
TrawlBycatch<-as.numeric(DATfile[(tmp+2):(tmp+1+CatchYrN)])[1:CatchYrN]

# survey numbers
tmp<-grep("survey numbers by year",DATfile)
SurveyNumbers<-as.numeric(DATfile[(tmp+1):(tmp+SurvYrN)])
tmp<-grep("years for survey data",DATfile)
SurveyYrs<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))

#==make a list of the scenario names
##==save all of the output from the scenarios
snowad.rep<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  snowad.rep[[x]]  <-readList(paste(TakeDir,Scenarios[x],"/R_input.txt",sep=""))

REPfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.REP",sep=""))

 source("C:/SnowCrab/SnowCrabCode/Rscripts/error_bar.R")
 source("C:/SnowCrab/SnowCrabCode/Rscripts/plot.sizcomps.r.nosp.R")
 source("C:/SnowCrab/SnowCrabCode/Rscripts/plot.bubble.residuals.addn.R")

tmp<-grep("length bins",DATfile)[[5]]
LengthBins<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))
LengthBins<-LengthBins[!is.na(LengthBins)]

#==read in files that will be needed
```
1. Stock: Eastern Bering Sea snow crab, *Chionoecetes opilio*.

2. Catches: trends and current levels

Retained catches increased from relatively low levels in the early 1980s (e.g. retained catch of `r round(snowad.rep[[1]]$"Observed retained catch biomass"[4],2)` t during 1981) to historical highs in the early and mid-nineties (retained catch during 1991, 1992, and 1998 were `r round(snowad.rep[[1]]$"Observed retained catch biomass"[14],2)`, `r round(snowad.rep[[1]]$"Observed retained catch biomass"[15],2)`, and `r round(snowad.rep[[1]]$"Observed retained catch biomass"[21],2)` t, respectively).  The stock was declared overfished in 1999 at which time retained catches dropped to levels similar to the early 1980s (e.g. retained catch during 2000 was `r round(snowad.rep[[1]]$"Observed retained catch biomass"[23],2)` t). Retained catches have slowly increased since 1999 as the stock rebuilt with a retained catch of `r round(snowad.rep[[1]]$"observed male discard mortality biomass"[37],2)` during 2016. 

Discard mortality is the next largest source of mortality after the retained catch and approximately tracks the retained catch. The highest estimated discard mortality occurred during 1993 at `r round(snowad.rep[[1]]$"observed male discard mortality biomass"[15],2)` t which was `r round(as.numeric(round(snowad.rep[[1]]$"observed male discard mortality biomass"[15],2)) / as.numeric(round(snowad.rep[[1]]$"Observed retained catch biomass"[15],2)),2)`% of the retained catch.
The most recent estimated mortality was `r round(snowad.rep[[1]]$"observed male discard mortality biomass"[37],2)` t which was `r round(as.numeric(round(snowad.rep[[1]]$"observed male discard mortality biomass"[37],2)) / as.numeric(round(snowad.rep[[1]]$"Observed retained catch biomass"[37],2)),2)`% of the retained catch.

3. Stock Biomass: 

Observed mature male biomass (MMB) at the time of the survey has increased from an average of `r round(mean(snowad.rep[[1]]$"Observed survey male spawning biomass"[1:10]),2)` t in the early to mid-1980s to historical highs in the early and mid-nineties (observed MMB during 1990, 1991, and 1997 were `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[13],2)`, `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[14],2)`, and `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[20],2)` t, respectively).  The stock was declared overfished in 1999 in response to the total mature biomass dropping below the minimum stock size threshold.  MMB in that year decreased to `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[22],2)` t. Observed MMB has slowly increased since 1999 as the stock rebuilt with an observed value of MMB of `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[SurvYrN],2)` t during `r SurveyYrs[SurvYrN]`. The stock was declared rebuilt in 2011 when estimated MMB at mating was above B35%.

MODEL ESTIMATES TRACKING.

4. Recruitment

Estimated recruitment shifts from a period of high recruitment to a period of low recruitment in the mid 1990s (late 1980s when lagged to fertilization). Recent estimated recruitments have been above the average of the 'low' period , but are still beneath the average of the 'high' recruitment period. Suvey length frequencey data in 2016 indicate THIS KIND OF RECRUITMENT. 

5. Management 

*Historical status and catch specifications for snow crab (1,000t).*
```{r,echo=F}

ManTable <-read.csv("C:/SnowCrab/ManagementTable.csv")
PlotTab<- data.frame(ManTable)
colnames(PlotTab)<-c("Year","MSST","Biomass (MMB)","TAC","Retained catch","Total catch", "OFL","ABC")

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10)

# PoundTab<-PlotTab
# PoundTab[,c(2,3,4,5,6,7,8)]<-as.numeric(PoundTab[,c(2,3,4,5,6,7,8)])*2.20462
# pander(PoundTab,split.cells=10)
```

*Historical status and catch specifications for snow crab (millions of lbs).*
```{r,echo=F}
ManTable <-read.csv("C:/SnowCrab/ManagementTable.csv")
PlotTab<- data.frame(ManTable)
colnames(PlotTab)<-c("Year","MSST","Biomass (MMB)","TAC","Retained catch","Total catch", "OFL","ABC")

PlotTab[,c(2,3,4,5,6,7,8)]<-round((PlotTab[,c(2,3,4,5,6,7,8)])*2.20462,2)
pander(PlotTab,split.cells=10)
```
6.  Basis for the OFL 

The OFL for `r SurveyYrs[SurvYrN]` for the chosen model was INSERT CODE t fishing at FOFL = INSERT CODE (INSERT CODE % of the estimated F35%, INSERT CODE).  The calculated OFL was an/a DECREASE/INCREASE from the `r SurveyYrs[SurvYrN-1]` OFL of `r ManTable[nrow(ManTable),7]` t.  The MMB at mating projected for `r SurveyYrs[SurvYrN]` when removing the OFL was INSERT CODE, which was INSERT CODE % of B35% (INSERT CODE).   

7.	Probability Density Function of the OFL

The probabillity density function of the OFL was characterized by using a Markov Chain Monte Carlo algorithm to generate a posterior distribution of the OFL.  This allows all uncertainty in the model to be propagated forward into the OFL calculation. 

8.	Basis for ABC 

The ABC was specified as INSERT CODE by calculating the 49th quantile of the posterior distribution of the OFL.  The total estimated catch, INSERT CODE, was estimated at 90% of the OFL (recommend by the SSC).  

\newpage
# A.  Summary of Major Changes 

1. Management: None 

2. Input data: 

Data added to the assessment included:  `r SurveyYrs[SurvYrN]` Bering Sea survey biomass and length frequency data;  `r SurveyYrs[SurvYrN-1]` directed fishery retained and discard catch and length frequencies for retained and discard catch;  and groundfish discard length frequency and discard catch from `r SurveyYrs[SurvYrN-1]`. Five additional data points for growth increment were also included and weight at length parameters for mature females were revised.

3. Assessment methodology: 

Four models are presented in this assessment with several incremental steps each illustrated. Model 0 represents the 2015 model with minor structural changes suggested by the CPT implemented and serves as a basis for comparison between previous years' assessments.  Model 1 addresses the way in which fishing mortality in the trawl fleet is estimated. MODEL 2 removes the priors on maturity. MODEL 3 changes the way maturity is estimated.  Model 3a was the selected model for which MCMC was implemented and on which presented management quantities are based because estimating discard selectivity for females resulted in a model in which no females were selected for discard.

4. Assessment results

Comment on changes in MMB from last year and recruitment estimates.

\newpage
# B. CPT May 2016 comments, SSC comments, and author response:
## CPT and SSC comments

CPT comments were divided into two categories and there were no significant comments from the SSC.

* Changes to model structure and presentation of results
    + show fits to the pot CPUE data
    + Provide a retrospective analysis
    + Implement Francis weighting method and report weights
    + Provide plots of the observed and model-predicted mean lengths
    + Ensure catchability for all surveys is bounded at one
    + Document the jittering approach

* Model scenarios to be explored:
    + Model 0: (Base) A model with only the small structural changes from above implemented to provide a comparison to last year's model
    + Model 1: (TrawlF) A model modifying the way in which the fishing mortality in the groundfish trawl fishery is modeled, including the following changes:
        * Estimate average F for the groundfish trawl, rather than specifying it,
        * Remove penalties on F from 1992 to present
        * Estimate a separate vector of F_devs for 1978-90 and 1991-present
        * Estimate a constant of proportionality between fishing effort in the pot fishery and F for the females in the pot fishery
    + Model 2: (MaturePrior) A model in which the priors on probabillity of maturing for males and females are removed (in addition to the changes made in Model 1)
    + Model 3: (MatureSmooth) A model in which I:
        * Increase the weight on the second difference penalty for the probability of maturity 
        * Estimate the 50% selectivity parameter for female discard 

Several other changes were made to the code, including: rearranging the code to improve readability and functionality (e.g. deleting legacy code and adding space in arrays to allow for calculation of reference points, alllowing the weight at length parameters to be input, rather than included in the .DAT file as a prespecified vector), migrating constants to control file, correcting the conversion for tonnes to million pounds, and adding a rec_dev for the end year.

All changes were undertaken in a stepwise fashion and the resulting changes in the estimated MMB and parameters were recorded (Table X).  Only scenarios for which large changes in estimated parameters and MMB resulted from a given change in the model are presented in the figures and text.

## Authors response

All requests by the CPT were fulfilled and described below. Model scenarios include all CPT recommended models, except estimating a constant of proportionality between fishing effort in the pot fishery and fishing mortality in the trawl fishery because this is a stepbackwards from estimating a vector of deviations.

\newpage
# C. INTRODUCTION

Snow crab (Chionoecetes opilio) are distributed on the continental shelf of the Bering Sea, Chukchi Sea, and in the western Atlantic Ocean as far south as Maine.  In the Bering Sea, snow crab are common at depths less than about 200 meters.  The eastern Bering Sea population within U.S. waters is managed as a single stock; however, the distribution of the population may extend into Russian waters to an unknown degree. 

## Distribution
Map with stock boundary and the actual distribtion. Evidence of stock structure

## Life history characteristics
### Weight to size relationship
Weight at length is calculated by a power function (see equation XX).  Parameters were recalculated by the Kodiak lab in August 2016 and are specified here as INSERT CODE for juvenile females, INSERT CODE for mature females, and INSERT CODE for all males.  These parameter values changed from: a = 0.00000253 and b = 2.56472 (juvenile females), a = 0.000675 and b = 2.943352 (mature females), and a = 0.00000023 and b = 3.12948 (all males).  

## Maturity 
### Make a figure comparing observed and estimated maturity

How were data parsed into mature vs. immature?
How was maturity treated within the model? 

Maturity for both sexes is estimated within the model; the data that inform this process include the length frequencies for the survey, which are divided into mature and immature for each sex when fitting.  Maturity by sex by year can also be determined empirically using the survey data. Female maturity was determined by the shape of the abdomen, by the presence of brooded eggs, or egg remnants. Morphometric maturity for males is determined by chela height measurements, which are available starting from the 1989 survey (Otto 1998). Mature male biomass referenced throughout this document refers to a morphometrically mature male.  

One maturity curve for males was estimated using the average fraction mature based on chela height data and applied to all years of survey data to estimate mature survey numbers (Figure 48c).  The separation of mature and immature males by chela height at small widths may not be adequately refined given the current measurement to the nearest millimeter.  Chela height measured to the nearest tenth of a millimeter (by Canadian researchers on North Atlantic snow crab) shows a clear break in chela height at small and large widths and shows fewer mature animals at small widths than the Bering Sea data measured to the nearest millimeter.  Measurements taken in 2004-2005 on Bering Sea snow crab chela to the nearest tenth of a millimeter show a similar break in chela height to the Canadian data (Rugolo et al. 2005).  

The probability of a new shell crab maturing was estimated in the model at a smooth function to move crab from immature to mature (Figure 48).  The probability of maturing was estimated to match the observed fraction mature for all mature males and females observed in the survey data.  The probability of maturing by size for female crab was about 50% at about 48 mm and increased to 100% at 60mm (Figure 49).  The probability of maturing for male crab was about 15% to 20% at 60 mm to 90mm and increased sharply to 50% at about 98mm, and 100% at 108 mm.

## Natural Mortality

Nevissi, et al. (1995) used radiometric techniques to estimate shell age from last molt (Table 7).  The total sample size was 21 male crabs (a combination of Tanner and snow crab) from a collection of 105 male crabs from various hauls in the 1992 and 1993 NMFS Bering Sea survey.  Fishing mortality rates before and during the time period when these crab were collected were relatively high, and therefore maximum age would represent Z (total mortality) rather than M.  Representative samples for the 5 shell condition categories were collected that made up the 105 samples.  The oldest looking crab within shell conditions 4 and 5 were selected from the total sample of SC4 and SC5 crabs to radiometrically age (Orensanz, Univ. of Washington, pers comm.).  Shell condition 5 crab (SC5 = very, very old shell) had a maximum age of 6.85 years (s.d. 0.58, 95% CI approximately 5.69 to 8.01 years).  The average age of 6 crabs with SC4 (very old shell) and SC5, was 4.95 years.  The range of ages was 2.70 to 6.85 years for those same crabs.  Given the small sample size, this maximum age may not represent the 1.5% percentile of the population that is approximately equivalent to Hoenig’s method (1983).  Maximum life span defined for a virgin stock is reasonably expected to be longer than these observed maximum ages from exploited populations.  Radiometric ages estimated by Nevissi, et al. (1995) may be underestimated by several years, due to the continued exchange of material in crab shells even after shells have hardened (Craig Kastelle, pers. comm., Alaska Fisheries Science Center, Seattle, WA).  
Tag recovery evidence from eastern Canada reveal observed maximum ages in exploited populations of 17-19 years (Nevissi, et al. 1995, Sainte-Marie 2002).  A maximum time at large of 11 years for tag returns of terminally molted mature male snow crab in the North Atlantic has been recorded since tagging started about 1993 (Fonseca, et al. 2008).  Fonseca, et al. (2008) estimated a maximum age of 7.8 years post terminal molt using data on dactal wear.  

We reasoned that in a virgin population of snow crab, longevity would be at least 20 years.  Hence, we used 20 years as a proxy for longevity and assumed that this age would represent the 99th percentile of the distribution of ages in an unexploited population if observable.  Under negative exponential depletion, the 99th percentile corresponding to age 20 of an unexploited population corresponds to a natural mortality rate of 0.23.  Using Hoenig’s (1983) method an M=0.23 corresponds to a maximum age of 18 years (Table 8).  M=0.23 was used for all female crab in the model.  Male natural mortality estimated in the model with a prior constraint of mean M=0.23 with a se = 0.054 estimated from using the 95% CI of  +-1.7 years on maximum age estimates from dactal wear and tag return analysis in Fonseca, et al. (2008).

## Molting probability

Bering Sea male snow crab appear to have a terminal molt to maturity based on data on hormone level data (Tamone et al. 2005) and findings from molt stage analysis via setagenesis.  The models presented here assume a terminal molt for both males and females. Many papers have dealt with the question of terminal molt for Atlantic Ocean mature male snow crab (e.g., Dawe, et al. 1991).  

Male snow crabs that do not molt (old shell) may be important in reproduction.  Paul et al. (1995) found that old shell mature male Tanner crab out-competed new shell crab of the same size in breeding in a laboratory study.  Recently molted males did not breed even with no competition and may not breed until after about 100 days from molting (Paul et al. 1995).  Sainte-Marie et al. (2002) states that only old shell males take part in mating for North Atlantic snow crab.  If molting precludes males from breeding for a three month period, then males that are new shell at the time of the survey (June to July), would have molted during the preceding spring (March to April), and would not have participated in mating.  The fishery targets new shell males, resulting in those animals that molted to maturity and to a size acceptable to the fishery of being removed from the population before the chance to mate.  Animals that molt to maturity at a size smaller than what is acceptable to the fishery may be subjected to fishery mortality from being caught and discarded before they have a chance to mate.  However, new shell males will be a mixture of crab less than 1 year from terminal molt and 1+ years from terminal molt due to the inaccuracy of shell condition as a measure of shell age.

Crabs in their first few years of life may molt more than once per year, however, the smallest crabs included in the model are approximately 3 to 4 years old and would be expected to molt annually. The growth transition matrix was applied to animals that grow, resulting in new shell animals.  Those animals that don’t molt become old shell animals.  Animals that are classified as new shell in the survey are assumed to have molted during the last year.  The assumption is that shell condition (new and old) is an accurate measure of whether animals have molted during the previous year.  The relationship between shell condition and time from last molt needs to be investigated further.  

## Mating ratio and reproductive success

Full clutches of unfertilized eggs may be extruded and appear normal to visual examination, and may be retained for several weeks or months by snow crab.  Resorption of eggs may occur if not all eggs are extruded resulting in less than a full clutch.  Female snow crab at the time of the survey may have a full clutch of eggs that are unfertilized, resulting in overestimation of reproductive potential.  Male snow crab are sperm conservers, using less than 4% of their sperm at each mating.  Females also will mate with more than one male.  The amount of stored sperm and clutch fullness varies with sex ratio (Sainte-Marie 2002).  If mating with only one male is inadequate to fertilize a full clutch, then females will need to mate with more than one male, necessitating a sex ratio closer to 1:1 in the mature population, than if one male is assumed to be able to adequately fertilize multiple females.

The fraction barren females and clutch fullness observed in the survey increased in the early 1990s then decreased in the mid- 1990s then increased again in the late 1990s (Figures 49 and 50).  The highest levels of barren females coincides with the peaks in catch and exploitation rates that occurred in 1992 and 1993 fishery seasons and the 1998 and 1999 fishery seasons.  While the biomass of mature females was high in the early 1990s, the rate of production from the stock may have been reduced due to the spatial distribution of the catch and the resulting sex ratio in areas of highest reproductive potential.   

Laboratory analysis determined that female snow crab collected in waters colder than 1.5 o C from the Bering Sea were biennial spawners (REFERENCE).  Future recruitment may be affected by the fraction of biennial spawning females in the population as well as the estimated fecundity of females, which may depend on water temperature. 

An index of reproductive potential for crab stocks needs to be defined that includes spawning biomass, fecundity, fertilization rates and frequency of spawning.  In most animals, spawning biomass is a sufficient index of reproductive potential because it addresses size related impacts on fecundity, and because the fertilization rates and frequency of spawning are relatively constant over time.  This is not necessarily the case for snow crab.

(Cold pool?)

The clutch fullness and fraction of unmated females however, may not account for the fraction of females that may have unfertilized eggs, since these cannot be detected by the naked eye at the time of the survey.   The fraction of barren females observed in the survey may not be an accurate measure of fertilization success because females may retain unfertilized eggs for months after extrusion.  To examine this hypothesis, RACE personnel sampled mature females from the Bering Sea in winter and held them in tanks until their eggs hatched in March of the same year (Rugolo et al. 2005).  All females then extruded a new clutch of eggs in the absence of males.  All eggs were retained until the crabs were sacrificed near the end of August.  Approximately 20% of the females had full clutches of unfertilized eggs.  The unfertilized eggs could not be distinguished from fertilized eggs by visual inspection at the time they were sacrificed.  Indices of fertilized females based on the visual inspection method of assessing clutch fullness and percent unmated females may overestimate fertilized females and not an accurate index of reproductive success.    

McMullen and Yoshihara (1969) examined female red king crab around Kodiak Island in 1968 and found high percentages of females without eggs in areas of most intense fishing (up to 72%).  Females that did not extrude eggs and mate were found to resorb their eggs in the ovaries over a period of several months.  One trawl haul captured 651 post-molt females and nine male red king crab during the period April to May 1968.  Seventy-six percent of the 651 females were not carrying eggs.  Ten females were collected that were carrying eggs and had firm post-molt shells.  The eggs were sampled 8 and 10 days after capture and were examined microscopically.  All eggs examined were found to be infertile.  This indicates that all ten females had extruded and held egg clutches without mating.   Eggs of females sampled in October of 1968 appear to have been all fertile from a table of results in McMullen and Yoshihara(1969), however the results are not discussed in the text, so this is unclear.  This may mean that extruded eggs that are unfertilized are lost between May and October.      

## Growth

Little information exists on growth for Bering Sea snow crab. Tagging experiments were conducted on snow crab in 1980 with recoveries occurring in the Tanner crab (Chionoecetes bairdi) fishery in 1980 to 1982 (Mcbride 1982).  However, data from the McBride study was not used due to uncertainty about the effect of tagging on growth. Currently, 40 data points from 5 studies are used to estimate the post-molt length from pre-molt length for females and males, several of which were used in Somerton's 2013 study on growth.  The studies include:

1.  Transit study (Rugolo unpublished data, 2003); 14 crab
2.	Cooperative seasonality study (Rugolo); 6 crab
3.	Dutch harbor holding study; 9 crab
4.	NMFS Kodiak holding study held less than 30 days;  6 crab
5.  NMFS Kodiak holding study 2016; 5 crab

In the "Transit study", pre- and post-molt measurements of 14 male crabs hat molted soon after being captured were collected.  The crabs were measured when shells were still soft because all died after molting, so measurements are probably underestimates of postmolt width (Rugolo, pers. com.).  The holding studies include only data for crab held less than 30 days because growth of crabs held until the next spring's molting was much lower. Females molting to maturity were excluded from all data sets, since the molt increment is usually smaller.  Crab missing more than two limbs were excluded due to other studies showing lower growth.  Crab from Rugolo’s seasonal study were excluded that were measured less than 3 days after molting due to difficulty in measuring soft crab accurately. In general, growth of snow crab in the Bering Sea appears to be greater than growth of some North Atlantic snow crab stocks (Sainte-Marie 1995).   


## Management history

## ADFG harvest strategy
Parameters for stocks with an approved harest strategy should be provided in tables in both t and lbs.

## History of BMSY

## Fishery history

Snow crab were harvested in the Bering Sea by the Japanese from the 1960s until 1980 when the Magnuson Act prohibited foreign fishing.  Retained catch in the domestic fishery increased in the late 1980s to a high of about 149,110 t in 1991, declined to 29,820 t in 1996, increased to 110,410 t in 1998 then declined to 15,200 t in the 1999/2000 fishery (Table 1, Figure 1).  Due to low abundance and a reduced harvest rate, retained catches from 2000/01 to 2006/07 ranged from a low of about 10,860 t to 16,780 t.  In the 2014/15 fishery retained catch was 30,820 t and total catch was estimated at 34,300 t (0.30 mortality for pot fishery discard and 0.80 mortality for groundfish discard).  Total catch in the 2013/14 fishery was 27,700 t.
 
Discard from the directed pot fishery was estimated from observer data since 1992 and ranged from 11% to 64% (average 33%) of the retained catch of male crab biomass (Table 1).  Discard of male crab in the directed fishery increased in the last two years to 44% (2013/14) and 38% (2014/15) of the retained catch (no mortality applied).  Female discard catch is very low compared to male discard catch and not a significant source of mortality.  In 1991/92 trawl discard was about 1,950 t (no mortality applied), increased to about 3,550 t in 1994/95, then declined and ranged between 900 t and 1,500 t until 1998/99.  Trawl bycatch in 2012/13 and 2013/14 was 220 t and 120 t respectively.  Discard of snow crab in groundfish fisheries from highest to lowest is the yellowfin sole trawl fishery, flathead sole trawl fishery, Pacific cod bottom trawl fishery, rock sole trawl fishery, and the Pacific cod hook-and-line and pot fisheries.

Size frequency data and catch per pot have been collected by observers on snow crab fishery vessels since 1992.  Observer coverage has been 10% on catcher vessels larger than 125 ft (since 2001), and 100% coverage on catcher processors (since 1992). 

The average size of retained crabs has remained fairly constant over time ranging between 105 mm and 118 mm Carapace Width (CW), and most recently about 110 mm to 111 mm CW.  The percent new shell animals in the catch has varied between 69% (2002 fishery) to 98% (1999), and was 87% for the 2005/6 fishery and 93% in the 2007/8 fishery.  In the 2007/8 fishery 94% of the new shell males >101mm CW were retained, while 78% of the old shell males >101mm CW were retained.  Only 3% of crab were retained between 78mm and 101 mm CW.  The average weight of retained crab has varied between 0.5 kg (1983-1984) and 0.73 kg (1979), and 0.59 kg in the recent fisheries.

Several modifications to pot gear have been introduced to reduce bycatch mortality.  In the 1978/79 season, pots used in the snow crab fishery first contained escape panels to prevent ghost fishing.  Escape panels consisted of an opening with one-half the perimeter of the tunnel eye laced with untreated cotton twine.  The size of the cotton laced panel to prevent ghost fishing was increased in 1991 to at least 18 inches in length.  No escape mechanisms for undersized crab were required until the 1997 season when at least one-third of one vertical surface had to contain not less than 5 inches stretched mesh webbing or have no less than four circular rings of no less than 3 3/4 inches inside diameter.  In the 2001 season the escapement for undersize crab was increased to at least eight escape rings of no less than 4 inches placed within one mesh measurement from the bottom of the pot, with four escape rings on each side of the two sides of a four-sided pot, or one-half of one side of the pot must have a side panel composed of not less than 5 1/4 inch stretched mesh webbing.  

## Harvest rates

The harvest rate used to set the Guideline Harvest Level (GHL) of retained crab only previous to 2000 was 58% of the number of male crab over 101 mm CW estimated from the survey.  The minimum legal size limit for snow crab is 78 mm, however, the snow crab market generally accepts animals greater than 101 mm.  In 2000, due to the decline in abundance and the declaration of the stock as overfished, the harvest rate for calculation of the GHL was reduced to 20% of male crab over 101 mm.  After 2000, a rebuilding strategy was developed based on simulations by Zheng (2002).

The realized retained catch typically exceeded the GHL historically, resulting in exploitation rates for the retained catch on males >101mm ranging from about 10% to 80%  (Figure 2).  The exploitation rate for total catch divided by mature male biomass ranged from  6% to 46% and was estimated at 21% in 2014/15 (Table 6 and Figure 2).
 
Prior to adoption of Amendment 24, BMSY (921.6 million lbs (418,150 t)) was defined as the average total mature biomass (males and females) estimated from the survey for the years 1983 to 1997 (NPFMC 1998).  MSST was defined as 50% of the BMSY value (MSST=460 million lbs of total mature biomass (209,074 t)).  The harvest strategy since 2000/01 used a retained crab harvest rate on the mature male biomass of 0.10 on levels of total mature biomass greater than ½ MSST (230 million lbs), increasing linearly to 0.225 when biomass is equal to or greater than BMSY (921.6 million lbs) (Zheng et al. 2002).  The GHL was actually set as the number of retained crab allowed in the harvest, calculated by dividing the GHL in lbs by the average weight of a male crab > 101 mm.  If the GHL in numbers was greater than 58% of the estimated number of new shell crabs greater than 101 mm plus 25% of the old shell crab greater than 101 mm, the GHL is capped at 58%.  If natural mortality is 0.2, then this actually results in a realized exploitation rate cap for the retained catch of 66% at the time of the fishery, occurring approximately 7 months after the survey (if survey Q=1).  The fishing mortality rate that results from this harvest strategy depends on the relationship between mature male numbers less than 101 mm compared to greater than 101 mm.  

# D. DATA 

## New Data

## Catch data

Catch data and size frequencies of retained crab from the directed snow crab pot fishery from 1978/79 to the `r SurveyYrs[SurvYrN-1]` season were used in this analysis.  Observers were placed on directed crab fishery vessels starting in 1990.  Size frequency data on the total catch (retained plus discarded) in the directed crab fishery were available from 1992/93 to `r SurveyYrs[SurvYrN-1]`.   Total discarded catch was estimated from observer data from 1992 to `r SurveyYrs[SurvYrN-1]` (Table 1).  The discarded male catch was estimated for 1978 to 1991 in the model using the estimated fishery selectivities based on the observer data for the period 1992 to `r SurveyYrs[SurvYrN-1]`.  The discard catch estimate was multiplied by the assumed mortality of discards from the pot fishery.  The mortality of discarded crab was 30% for all model scenarios.  This estimate differs from the current rebuilding harvest strategy used since 2001 to the present by ADFG to set the TAC, which assumes a discard mortality of 25% (Zheng, et al. 2002).   The discards prior to 1992 may be underestimated due to the lack of escape mechanisms for undersized crab in the pots before 1997.


The following table contains the various data components used in the model,

```{r,echo=FALSE,warning=FALSE,message=F}
Data<-c("Retained male crab pot fishery size frequency by shell condition",
         "Discarded Males and female crab pot fishery size frequencey",
         "Trawl fishery bycatch size frequencies by sex",
         "Survey size frequencies by sex and shell condition",
        "Retained catch estimates",
        "Discard catch estimates from crab pot fishery",
        "Trawl bycatch estimates",
        "Total survey biomass estimates and coefficients of variation",
        "2009 study area biomass estimates, CVs, and size frequencey for BSFRF and NMFS tows",
        "2010 study area biomass estimates, CVs, and size frequencey for BSFRF and NMFS tows"
         )
DataYears<-c(paste("1978/79 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1992/93 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1991/92 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1978 - ",SurveyYrs[SurvYrN],sep=""),
             paste("1978/79 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1992/93 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1973 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1978 - ",SurveyYrs[SurvYrN],sep=""),
             "2009",
             "2010")

PlotTab<- data.frame(Data,DataYears)
colnames(PlotTab)<- c("Data component","Years")
rownames(PlotTab)<- NULL
kable(PlotTab)

```

## Survey biomass

Abundance is estimated from the annual eastern Bering Sea (EBS) bottom trawl survey conducted by NMFS (see Rugolo et al. 2003 for design and methods).  Since 1989, the survey has sampled stations farther north than previous years (61.2o N previous to 1989).  In 1982 the survey net was changed resulting in a change in catchability.  Juvenile crabs tend to occupy more inshore northern regions (up to about 63o N) and mature crabs deeper areas to the south of the juveniles (Zheng et al. 2001).
  
All survey data in this assessment use measured net widths instead of the fixed 50 ft net width used in the September 2009 snow crab assessment (variable net width data were shown for comparison in the September 2009 assessment).  Snow crab assessments prior to and including September 2009 used survey biomass estimates for all crab based on an assumed 50 ft net width.  In 2009, Chilton et al. (2009) provided new survey estimates based on measured net width. The average measured net width for all tows in the 2009 survey was 17.08 meters which is about 112% of 50ft (15.24 meters) (Chilton et al. 2009).   The 2009 mature male survey biomass was 162,890 t using the fixed 50 ft net width and 141,300 t using the measured net width for each tow.  The difference between the survey male mature biomass estimates calculated with the fixed 50 ft width and the measured net width is small in the early part of the time series, and then is an average ratio of 0.86 (range 0.81 to 0.90) from 1998 to 2009. 

The total mature biomass (all sizes of morphometrically mature males and females) estimated from the survey declined to a low of 82,100 t in 1985, increased to a high of 809,600 t in 1991 (includes northern stations after 1989), then declined to 140,900 t in 1999, when the stock was declared overfished (Table 3 and Figure 4).  The mature biomass increased in 2000 and 2001, mainly due to a few large catches of mature females.   The survey estimate of total mature biomass increased from 291,200 t in 2013 to 369,400 t in 2014, then declined to 207,100 t in 2015.
 
Survey mature male biomass increased from 96,100 t in 2013 to 156,900 t in 2014, then declined to 79,000 t in 2015.  The observed survey estimate of males greater than 101 mm increased from 73.6 million in 2013 to 138.9 million in 2014, then declined to 57.2 million in 2015 (Table 3).  Survey mature female biomass increased from 195,100 t in 2013 to 212,500 t in 2014, then declined to 128,100 t in 2015.

The term mature for male snow crab in this assessment means morphometrically mature.  Morphometric maturity for males refers to a marked change in chelae size (thereafter termed “large claw”), after which males are assumed to be effective at mating.  Males are functionally mature at smaller sizes than when they become morphometrically mature, although the contribution of these “small-clawed” males to annual reproductive output is negligible.  The minimum legal size limit for the snow crab fishery is 78 mm, however the size for males that are generally accepted by the fishery is >101mm.  The historical quotas were based on the survey abundance of large males (>101mm).  

## Survey catch-at-length

Carapace width is measured on snow crab and shell condition recorded in the survey and the fishery.  Snow crab cannot be aged at present (except by radiometric aging of the shell since last molt) however, shell condition has been used as a proxy for age. Based on protocols adopted in the NMFS EBS trawl survey, shell condition class and presumptive age are as follows: soft shell (SC1) (less than three months from molting), new shell (SC2) (three months to less than one year from molting), old shell (SC3) (two years to three years from molting), very old shell (SC4) (three years to four years form molting), and very very old shell (SC5) (four years or longer from molting).  Radiometric aging of shells from terminal molt male crabs (after the last molt of their lifetime) elucidated the relationship between shell condition and presumptive age, which will be discussed in a later section (Nevissi et al. 1995). 

Survey abundance by size for males and females indicate a moderate level of recruitment moving through the stock and resulting in the small increase in abundance in 2015 (Figures 6 - 8).  In 2009 small crab (<50mm) increased in abundance relative to 2008.  The 2010 length frequency data showed high abundance in the 40 to 50 mm range.  The recruitment progressed into the mature female abundance in 2011 and also can be seen in male abundance in the 50-65mm range in 2011(Figure 8).  However, in 2012 and 2013, the progress of the recruitment is not evident.  High numbers of small crab in the late 1970’s survey data did not follow through the population to the mid-1980’s.  The high numbers of small crab in the late 1980’s resulted in the high biomass levels of the early 1990’s and subsequent high catches.  Moderate increase in numbers can also be seen in the mid 1990’s.   The 2015 survey length composition data indicate a possible large recruitment to the model in 2015 (2010 lag 5 years to fertilization year).

## Spatial distribution of catch and survey abundance

The majority of the fishery catch occurs south of 58.5o N., even in years when ice cover did not restrict the fishery moving farther north.  In past years, most of the fishery catch occurred in the southern portion of the snow crab range possibly due to ice cover and proximity to port and practical constraints of meeting delivery schedules.  The directed fishery catch in 2012/13 is shown in Figure 9 showing some catch from east of the Pribilof Islands, however, the majority of catch is west and north of the Pribilof Islands.  The majority of catch in 2014/15 has shifted to east of the Pribilof Islands (Figure 11).

CPUE of survey catch by tow for 2014 to 2015 are shown in Figures 12 through 25.  Immature female and small male (<78mm) distributions in 2014 and 2015 were farther south than in previous years with higher tows just north of the Pribilof Islands (Figures 12, 15, 20 and 22).  Legal males (>77mm) and large males (>101mm) are distributed farther south and east of the Pribilof Islands than in previous years (Figures 13, 14, 19, and 21).  Mature females with less than or equal to half clutch of eggs were mostly in the northern part of the survey area above 58 o N (Figures 18 and 24). 

The difference between the summer survey distribution of large males and the fishery catch distribution indicates that survey catchability may be less than 1.0 and/or some movement occurs between the summer survey and the winter fishery.  However, the exploitation rate on males south of 58.5o N latitude may exceed the target rate, possibly resulting in localized depletion of males from the southern part of their range.  Snow crab larvae probably drift north and east after hatching in spring.  Snow crab appear to move south and west as they age, however, no tagging studies have been conducted to fully characterize the ontogenetic or annual migration patterns of this stock(Murphy et al. 2010).  High exploitation rates in the southern area may have resulted in a northward shift in snow crab distribution.  The last few years of survey data indicate a shift to the south in distribution of snow crab, which reverses the trends seen in early 2000s.

Ernst, et al. (2005) found the centroids of survey summer distributions have moved to the north over time (Figures 26 and 27).  In the early 1980’s the centroids of mature female distribution were near 58.5 o N, in the 1990s the centroids were about 59.5 o N.  The centroids of old shell male distribution was south of 58 o N in the early 1980s, moved north in the late 1980s and early 1990s then shifted back to the south in the late 1990s.  The distribution of males>101 mm was about at 58 o N in the early 1980s, then was farther north (58.5 to 59 o N) in the late 1980s and early 1990s, went back south in 1996 and 1997 then has moved north with the centroid of the distribution in 2001 just north of 59 o N..  The centroids of the catch are generally south of 58 o N, except in 1987.  The centroids of catch also moved north in the late 1980s and most of the 1990s.  The centroids of the catch were about at 56.5 o N in 1997 and 1998, then moved north to above 58.5 o in 2002.

## 2009 and 2010 Study Area Data Additional survey data 

Bering Sea Fisheries Research Foundation (BSFRF) conducted a survey of 108 tows in 27 survey stations (10,827 nm2, hereafter referred to as the “study area”) in the Bering Sea in summer 2009 (Figure 28, see Somerton et al 2010 for more details).  The abundance estimated by the BSFRF survey in the study area was 66.9 million male crab >=100 mm compared to 36.7 million for the NMFS tows (Table 4).  The NMFS abundance of females >=50mm (121.5 million) was greater than the BSFRF abundance estimate in the study area (113.6 million) (Table 4).

The abundance of male crab in the entire Bering Sea survey for 2009 was greatest in the 30 – 60mm size range (Figures 29 and 30).  The abundance of crab in the 35 to 60mm size range for the BSFRF net in the study area was very low compared to the abundance of the same size range for the NMFS entire Bering Sea survey.  The differences in abundance by size for the NMFS entire Bering Sea survey and the BSFRF study area were due to availability of crab in the study area as well as capture probability.   While the abundance of larger male crab for the NMFS net in the study area is less than for the BSFRF, the abundance of females >45 mm is greater for the NMFS net than the BSFRF (Figure 29).  This difference may be due to different towing locations for the two nets within the study area, or to higher catchability of females possibly due to aggregation behavior.  The ratio of abundance of the NMFS net and BSFRF net in the study area are quite different for males and females (Figure 31).  The ratio of abundance indicates a catchability for mature females (mainly 45 – 65 mm) that is greater than 1.0 for the NMFS net.

The largest tows for small (<78mm) male crab in the entire Bering Sea area were north of the study area near St. Matthew Island (Figure 12 and 20).  Some higher tows for large males (>=100mm) and for mature females occurred in the study area as well as outside the study areas (Figures 5-18 and 22-24).  These distributions indicate that availability of crab of different sizes and sex varies spatial throughout the Bering Sea. The numbers by length and mature biomass by sex for the BSFRF tows and the NMFS tows within the study area were added to the model as an additional survey.

The 2009 estimated snow crab abundance by length in the study area had very low numbers of both male and female crab in the 35 mm to 70 mm range than observed in the Bering sea wide survey(Figures 29 and 30).   The ratio of abundance (NMFS/BSFRF) by length for 2009 was 0.2 at about 45 mm increasing gradually to 0.4 at 95mm then increasing steeply to 0.9 to 1.25 above 115 mm (Figure 31).  The mean size of crab retained by the fishery is about 110 mm, with minimum size retained about 102mm.  Ratios of abundance for female crab were above 1.0 from 45mm to 60mm then declined to 0.5 to 0.8 above 60mm to 80mm.  There were very few female crab above 80mm in the population.  

The 2010 study area covered a larger portion of the distribution of snow crab than the 2009 study area.  The abundance by length for the 2010 study area is very different from the 2009 data, with higher abundance in 2010 of small crab (Figure 32).  The expanded estimate (expanded to the study area) of male abundance from BSFRF data is higher than the Bering Sea wide abundance for length from 50mm to about 110mm. Female abundance shows a similar relationship (Figure 33).  The ratio of male abundance by length (NMFS/BSFRF) in 2010 increased to 0.6 at 40mm then decreased to about 0.2 at 65-70mm then increased and ranged between 0.3 and 0.4 up to about 112mm (Figure 34).  The ratios increased from 0.4 at 112 to about 0.7 at 122mm then to 1.55 at 132mm.  The ratio of female abundance by length in 2010 was 0.6 at about 45mm and declined to 0.4 at about 67mm then declined below 0.1 above about 77mm. 

Several processes influence net performance.  Somerton et al. (2010) accounted for area swept, sediment type, depth and crab size.  However, they did not correct for the probability of encountering crab.  The 2010 study area data have a number of paired tows where BSFRF caught no crab (within a particular size bin) or where NMFS caught no crab.   This creates problems with simply taking the ratio of catches since a number of ratios will be infinity (dividing by 0).  This occurs because the paired tows although near in space were not fishing on the same density of crab.  In addition, the BSFRF tow covered about 10% of the area of the NMFS tow, due to the narrower net width and the 5 minute tow duration compared to the 30 minute NMFS tow duration.   To analyze these data, first the ratio of the “NMFS density” (numbers per nm2) to the “sum of the density” of NMFS and BSFRF were calculated (Figure 35 males and Figure 38 females).  These values range from 0 to 1.0. The simple mean of these values was estimated by length bin and then transformed to estimate mean catchability by length bin (Figure 39 males Figure 40 females).  A value of 0.5 for the ratio of the “NMFS density” to the “sum of density” is equivalent to a catchability of 1.0, and a value of the ratio of 0.33 is equivalent to a catchability of 0.5. The size of the catch for each observation is plotted in Figure 36 (same data as Figure 35).  

The BSFRF study provides a rich data set to evaluate net performance.  In this survey the sample is the paired tows and the goal would be to evaluate net performance over a wide range of densities, sediment types and depths.  Somerton et al. (February 2011 Modeling Workshop) used catch to weight observations for estimation of the selectivity curve.  This assumes that trawl performance is influenced by local density of crab (an untested assumption).  No weighting of the observations assumes that there is no relationship between catch and the selectivity of crab.  If selectivity changes depending on whether catches are high or low, then further study and analysis is needed.  Further analysis needs to be done on whether data should be weighted in the initial estimation of the selectivity curve. The unweighted mean values by length bin are higher than the values estimated by Somerton et al..  Somerton weights again by survey abundance and adjusts for depth and sediment type in a separate step in the analysis to estimate a Bering Sea wide survey selectivity.  Simulation studies are needed to determine the influence of weighting (whether bias is introduced) and whether the distributional assumptions and likelihood equations used in the analysis of the paired tow data are correct and unbiased. 

The overall distribution of the ratio of “NMFS density” to the “sum of the densities” is skewed with about 140 - 0.0 values and 110 - 1.0 values (Figure 41).  The percentage of observations where NMFS caught crab and no crab were caught by the BSFRF tow increases by size bin for male crab (Figures 41 through 46).

Catches of male crab decrease with size simply because they are lower in abundance in the population.  At sizes of male crab greater than about 90 mm the fraction of observations where the ratio of NMFS density to the sum of densities was 1.0 and 1 crab was caught in the net was about 10% to 30%.  In other, words the majority of the tows involved more than 1 crab caught.

The mean values of the ratio of NMFS density to the sum of densities for female crab transformed to catchability increase from less than 0.1 at 25mm to about 0.5 at 55mm then decrease slightly above 70mm (Figures 38 and 40).  

## Selectivity

# E. ANALYTIC APPROACH

## History of modeling approaches for the stock

Catch trends historically followed survey abundance estimates of large males, as the survey estimates were the basis for calculating the Guideline Harvest Level (GHL ) for retained catch.  The TAC is currently set (starting in 2009) by Alaska Department of Fish and Game (ADFG) using the ADFG harvest strategy.  Retained catches increased from about 3,040 t at the beginning of the directed fishery in 1973 to a peak of 149,110 t in 1991, declined thereafter, then increased to another peak of 110,410 t in 1998.  Retained catch in the 1999/2000 fishery was reduced to 15,200 t due to the low abundance estimated by the 1999 survey.  A harvest strategy (Zheng et al. 2002) was developed using an earlier generation simulation model that pre-dated the current stock assessment model.  This early generation model has been used to set the GHL (TAC since 2009) since the 2000/01 fishery.  Retained catch in the 2014/15 fishery increased to 30,820 t from the 2013/14 fishery retained catch of 24,480 t.  The total catch in the 2014/15 fishery was estimated at 34,300 t (30% mortality on directed discards) and was well below the OFL of 69,000 t.  Discard in the directed fishery was 11,700 t (no mortality applied) in 2014/15, similar to the 10,880 t (no mortality applied) in 2013/14.

Estimated discard mortality (mostly undersized males and old shell males) in the directed pot fishery has averaged about 31% (no mortality applied) of the retained catch biomass since 1992 when observers were first placed on crab vessels.  Discards prior to 1992 were estimated based on fishery selectivities estimated for the period with observer data and the full selection fishing mortality estimated using the retained catch and retained fishery selectivities. 

## Model description

The model structure was developed following Fournier and Archibald’s (1982) methods, with many similarities to Methot (1990).  The model was implemented using automatic differentiation software developed as a set of libraries under C++ (ADModel Builder).  ADModel Builder can estimate a large number of parameters in a non-linear model using automatic differentiation software extended from Greiwank and Corliss (1991) and developed into C++ class libraries.  This software provides the derivative calculations needed for finding the objective function via a quasi-Newton function minimization routine (e.g., Press et al. 1992).   The model implementation language (ADModel Builder) gives simple and rapid access to these routines and provides the ability to estimate the variance-covariance matrix for all parameters of interest. 

The model estimates the abundance by length bin and sex in the first year (1978) as parameters rather than estimating the recruitments previous to 1978.  This results in 44 estimated parameters.   

List assumed time of fishery, survey, etc.


## Model selection and evaluation
List the scenarios that are considered
This should include the model from the previous year as the 'base' model and then whatever other runs were requested after that.


## Results

### Model 1

### Model 2

### Model 3

Write the code such that each scenario has it's own section
Does everyone get its own MCMC?
Then there is a section that compares them all at the end.
Or is there a 'base' model to which all of the others are compared?

# F. Calculation of the ABC

# H. Rebuilding analyses

# I. Data gaps and research priorities

# K. Literature cited



\newpage
# APPENDIX A: MODEL STRUCTURE

NEEDS:

 * List and description of all likelihood components
 * How many parameters are estimated
 * Description of how the stat of hte population at the start of the first year of the assessment period is determined
 * Size range of the model
 * List all of hte parameters esetimaed outside of the assessment and how they were estimated
 * List all of hte eparameters estimated conditionally on those above and indicate bounds and priors
 * List any constraints iposed on estimated parameters
 * Justify including fewere years for average recruitment
 * Define model outputs
    + biomass measures
    + recruitment
    + fishing mortalityi (exploitation rate vs instantaneous)
    
The population dynamics model used here tracks the number of crab of sex *s*, shell condition *v*, maturity state *m*, in year *y* at length *l*, N~*s,v,m,y,l*~. A terminal molt occurs in which crab move from immature to mature, and then do not molt again.  The dynamics are described by:

  $$ N_{s,v,m,y+1,l} = 
  \begin{cases}
  \Omega_{s,l}  \kappa_{s,l'} Q_{s,imat,y,l'} X_{s,l',l} & \text{if v = new; m = mat} \\[2ex] 
  1-\Omega_{s,l} \kappa_{s,l'} Q_{s,imat,y,l'} X_{s,l',l} + R e^\epsilon_y Pr_{l} & \text{if v = new; m = imat} \\[2ex]
  Q_{s,mat,y,l'} & \text{if v = old; m = mat} \\[2ex]
  (1-\kappa_{s,l'}) Q_{s,imat,y,l'} & \text{if v = old; m = imat} 
  \end{cases}
  $$

Where $\Omega_{s,l}$ is the probability of maturing at length *l* for sex *s*, $\kappa_{s,l'}$ is the probability of molting for an immature crab of sex *s* at length *l'*,  and X~*s,l,l'*~ is the size transition matrix describing the probability of transitioning from size *l* to size *l'* for sex *s*. Q~*s,m,y,l'*~ is the number of crab of sex *s*, maturity state *m*, and length *l'* surviving natural and fishing mortality during year *y*:

 \begin{equation}
  Q_{s,m,y,l} = \sum_v N_{s,v,m,y,l}e^{Z_{s,v,m,y,l}} 
 \end{equation}
 
 Where N~*s,v,m,y,l*~ is the numbers, *N*, of sex *s* during year *y* of shell condition *v* and maturity state *m* at length *l*. Z~*x,v,m,y,l*~ represents the total mortality experienced by the population and consists of the sum of instantaneous rates of natural mortality by sex and maturity state (M~*s,m~*) and fishing mortality (F~*s,f,y,l*~) from each fishery. Each fishing mortality is subject to seletivity by length *l*, which varies between sexes *s* and fisheries *f* (and sometimes by year *y*) .
 
 \begin{equation} Z_{s,v,m,y,l} = M_{s,m} + \sum_f S_{s,f,y,l} F_{s,f,y,l} \end{equation}
 
Selectivities in the directed and bycatch fisheries are specified as logistic functions of size.  Different selectivities are estimated for females and males in the directed fisheries (S~*fem,dir,l*~ and S~*male,dir,l*~, respectively), a single selectivity for both sexes is estimated for bycatch in the groundfish trawl fishery (S~{trawl,l}), and a retention selectivity is estimated for the directed fishery for males (R~*dir,l*~; all females are discarded).
 
  \begin{align}
  S_{male,dir,l} = & \frac {1}{1+e^{-S_{slope,m,d}(L_{l}-S_{50,m,d}}}) \\
  S_{fem,dir,l} = & \frac {1}{1+e^{-S_{slope,f,d}(L_{l}-S_{50,f,d}}}) \\
  S_{trawl,l} = & \frac {1}{1+e^{-S_{slope,t}(L_{l}-S_{50,t}}}) \\
  R_{dir,l} = & \frac {1}{1+e^{-S_{slope,m,d}(L_{l}-S_{50,m,d}}})
  \end{align}

Where S~*slope,s,f*~ is the slope of the logistic curve for sex *s* in fishery *f* and S~*50,s,f*~ is the length at 50% selection for sex *s* in fishery *f*.  Catch in each fishery *f* during each year *y* is calculated as the fraction of the total fishing mortality, F~*s,f,y,l*~, applied to a given sex *s* in a given fishery *f* times the biomass removed by all fisheries for that sex.

 \begin{align}
 C_{male,dir,y}  = & \sum_{l} \sum_{v} \sum_{m} w_{male,l} \frac {R_l F_{male,dir,y,l}}{F_{male,dir,y,l + F_{trawl,y,l}}} N_{male,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{male,dir,y,l}+F_{trawl,y,l})}) \\
 C_{male,tot,y}  = & \sum_{l} \sum_{v} \sum_{m} w_{male,l} \frac {F_{male,dir,y,l}}{F_{male,dir,y,l + F_{trawl,y,l}}} N_{male,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{male,dir,y,l}+F_{trawl,y,l})}) \\
 C_{fem,dir,y}   = & \sum_{l} \sum_{v} \sum_{m} w_{fem,l} \frac {F_{fem,dir,y,l}}{F_{fem,dir,y,l + F_{trawl,y,l}}} N_{fem,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{fem,dir,y,l}+F_{trawl,y,l})})  \\
 C_{m+f,trawl,y}  = & \sum_{s} \sum_{l} \sum_{v} \sum_{m} w_{s,l} N_{s,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{trawl,y,l})})
 \end{align}
 
Where $\delta_y$ is the mid point of the fishery (all fisheries are assumed to occur concurrently and the midpoint is based on the directed fishery, which accounts for the vast majority of the fishing mortality), w~*s,l*~ is the weight at length *l* for sex *s*. 
 
Molting and growth occur before the survey.  Immmature crab are assumed to molt every year with a probabillity of molting to maturity based on length *l*. For crab that do molt, the growth increment within the size-transition matrix, X~*s,l,l'*~, is based on a linear relationship between pre- and post-molt length and the variabillity around that relationship is characterized by a normalized gamma function. 

 \begin{equation} X_{s,l,l'} = \frac{Y_{s,l,l'}}{ \sum_{l'} Y_{s,l,l'}}\end{equation}

 \begin{equation} Y_{s,l,l'} = (\Delta_{l,l'})^{\frac {\hat{L_{s,l}}-(\bar{L}_{l}-2.5)}{ \beta_{s}}} \end{equation}

 \begin{equation} \hat{L}_{s,l} = \gamma^1_s + \gamma^w_s \bar{L}_{l} \end{equation}
 
 \begin{equation} \Delta_{l,l'} = \bar{L}_{l'} + 2.5 - L_{l} \end{equation}
 
 Where EXPLAIN THINGS ABOVE THAT NEED EXPLAINING.
 
 An average recruitment for the entire assessment period and yearly deviations around this average are estimated within the assessment.  The sex ratio of recruitment is assumed to be 50/50 male to female.  Each year's estimated recruitment is allocated to length bins based on a discretized and renormalized gamma function.
 
 \begin{equation} Re_{y} = e^(Re_{avg} + Re_{dev,y}) \end{equation}
 \begin{equation} Pr_l = \frac {(\Delta_{1,l})^{v^1/v^2}e^{-\Delta_{1,l'}/v^2}}{\sum_{l'} (\Delta_{1,l'})^{v^1/v^2}e^{(-\Delta_{1,l'}/v^2)}} \end{equation}
 
 Numbers of a given sex *s* of shell condition *v* and maturity state *m* at length *l* in the initial year of the assessment, N~*s,v,m,y=1,l*}, are calculated from an estimated vector of numbers at length *l* by sex *s* and maturity state *m*, $\gamma_{s,v,l}$. 
 
\begin{equation} N_{s,v,m,y=1,l} = 
  \begin{cases}
  \Omega_{s,l} \lambda_{s,v,l} & \text{if v = new; m = mat} \\
  1-\Omega_{s,l} \lambda_{s,v,l} & \text{if v = new; m = imat} \\
  \lambda_{s,v,l} & \text{if v = old; m = mat} \\
  0 & \text{if v = old; m = imat} 
  \end{cases}
  \end{equation}

LIKELIHOOD COMPONENTS 
 
  
 \begin{align}
 L_{1,a} = & \lambda_{1,a} \sum_{y} N^{eff}_{1,y} \sum_{l} p^{obs}_{1,y,l} ln( \hat {p}_{1,y,l}/p^{obs}_{1,y,l}) \\
 L_{1,b} = & \lambda_{1,a} \sum_{y} N^{eff}_{2,y} \sum_{l} p^{obs}_{2,y,l} ln( \hat {p}_{2,y,l}/p^{obs}_{2,y,l}) \\
 L_{1,c} = & \lambda_{1,a} \sum_{y} N^{eff}_{3,y} \sum_{l} p^{obs}_{3,y,l} ln( \hat {p}_{3,y,l}/p^{obs}_{3,y,l}) \\
 L_{1,d} = & \lambda_{1,a} \sum_{s} \sum_{y} N^eff_{4,s,y} \sum_{l} p^{obs}_{4,y,s,l} ln(\hat {p}_{4,y,s,l}/p^{obs}_{4,y,s,l}) 
 \end{align}
  
where,

R~0~    log mean recruitment
pr~t~   proportion of recruits for each lenght bin
tao~t~  recruitment deviations by year

Recruitment is estimated equal for males and females in the model.

Crab were distributed into 5mm CW bins based on a pre-molt to post-molt transition matrix.  For immature crab, the number of crabs in length bin l in year t-1 that remain immature in year t is given by,

\newpage

# APPENDIX B: PROJECTION MODEL STRUCTURE

Previous
Current (MCMCMCMCMCMC)

\newpage

# Tables 

```{r,echo=FALSE,warning=FALSE,message=F}

# format all the above into a tabular format
tmpMat<-matrix(ncol=6,nrow=SurvYrN)
tmpMat[,1]<-SurveyYrs
tmpMat[match(RetCatchYrs,SurveyYrs),2]<-ObsCatchNumbers/10000
tmpMat[match(RetCatchYrs,SurveyYrs),3]<-ObsCatchPounds/10000
tmpMat[match(RetCatchYrs,SurveyYrs),4]<-ObsDiscF/10000
tmpMat[match(RetCatchYrs,SurveyYrs),5]<-ObsDiscM/10000
tmpMat[match(RetCatchYrs,SurveyYrs),6]<-TrawlBycatch/10000


PlotTab<- data.frame(round(tmpMat,2))
colnames(PlotTab)<- c("Survey year","Retained catch (numbers)","Retained catch (lbs)",
                      "Discarded females","Discarded males","Trawl bycatch (numbers)")

## break apart catch and survey numbers
## add cvs for survey

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10)
#TRY PANDER
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

# format all the above into a tabular format
tmpMat<-matrix(ncol=5,nrow=SurvYrN)
tmpMat[,1]<-SurveyYrs
tmpMat[,2]<-snowad.rep[[1]]$"Observed survey female spawning biomass"[1:SurvYrN]
tmpMat[,4]<-snowad.rep[[1]]$"Observed survey male spawning biomass"[1:SurvYrN]
tmpMat[,3]<-snowad.rep[[1]]$"survey CV"[1,]
tmpMat[,5]<-snowad.rep[[1]]$"survey CV"[2,]
PlotTab<- data.frame(round(tmpMat,2))
colnames(PlotTab)<- c("Survey year","Female mature biomass","Female CV",
                      "Mature male biomass","Male CV")
## break apart catch and survey numbers
## add cvs for survey

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}
RefPoints <-as.numeric(unlist(strsplit(REPfile[1],split=" ")))
B35       <-RefPoints[2]
MMB_mate  <-RefPoints[3]
MMB_fish  <-RefPoints[4]
F35       <-RefPoints[5]
FOFL      <-RefPoints[6]
OFL       <-RefPoints[7]

#==================================
# Growth data
tmp       <-grep("growth data female",DATfile)
GrowthNfem<-as.numeric(DATfile[(tmp+1)])
tmp1      <-grep("growth data male",DATfile)
GrowthNm  <-as.numeric(DATfile[(tmp1+1)])
GrowthData<-matrix(NA,ncol=4,nrow=max(GrowthNm,GrowthNfem))

GrowthData[1:GrowthNfem,1]  <-as.numeric(unlist(strsplit(DATfile[(tmp+2)],split="\t")))
GrowthData[1:GrowthNfem,2] <-as.numeric(unlist(strsplit(DATfile[(tmp+3)],split="\t")))

GrowthData[1:GrowthNm,3]  <-as.numeric(unlist(strsplit(DATfile[(tmp1+2)],split="\t")))
GrowthData[1:GrowthNm,4] <-as.numeric(unlist(strsplit(DATfile[(tmp1+3)],split="\t")))

PlotTab<-data.frame(GrowthData)
colnames(PlotTab)<-c("Female premolt length (mm)","Female postmolt length (mm)",
                     "Male premolt length (mm)","Male postmolt length (mm)")
pander(PlotTab,split.cells=13)
```

\newpage

# Figures
## Fits to data sources

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=6.5,fig.height=6,fig.cap="Model fits to the observed mature biomass at survey"}
##=======FITS TO THE DATA SOURCES=========================
#==mature male biomass==============
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,
     pch=20,ylab="Mature Male Biomass (1000 t)",
     xlab="Year",las=1,ylim=c(0,600),
     xaxt='n');

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j],
		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j])
}
for(x in 1:length(Scenarios))
 lines(as.numeric(unlist(snowad.rep[[x]]$"Predicted Male survey mature Biomass"))[1:SurvYrN]~SurveyYrs,type="l",lty=x,lwd=1)
legend("topleft",bty='n',"Males")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)


#==mature female biomass==============
plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20,ylab="Mature Female Biomass (1000 t)",xlab="Year",las=1,ylim=c(0,700));

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j],
		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j])
}

for(x in 1:length(Scenarios))
 lines(as.numeric(unlist(snowad.rep[[x]]$"Predicted Female survey mature Biomass"))[1:SurvYrN]~SurveyYrs,type="l",lty=x,lwd=1)
legend("topleft",bty='n',"Females")
mtext(side=2,outer=T,text=c("Mature biomass at survey (1000 t)"),line=3)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=8,fig.cap="Model fits to the growth data"}

#==Growth data
   flength <- (snowad.rep[[1]]$"af"+snowad.rep[[1]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
              (snowad.rep[[1]]$"af2"+snowad.rep[[1]]$"bf1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");
   mlength <- (snowad.rep[[1]]$"am"+snowad.rep[[1]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
              (snowad.rep[[1]]$"am2"+snowad.rep[[1]]$"b1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");

flength<-rep(list(list()),length(Scenarios))
mlength<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
{
  tempF<-(snowad.rep[[x]]$"af"+snowad.rep[[x]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[x]]$"delta male") / snowad.rep[[x]]$"st_gr")) + (snowad.rep[[x]]$"af2"+snowad.rep[[x]]$"bf1"*(20:135))*pnorm(((20:135) -snowad.rep[[x]]$"delta male")/snowad.rep[[x]]$"st_gr")
  flength[[x]]<-tempF
  tempM<-(snowad.rep[[1]]$"am"+snowad.rep[[1]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male") / snowad.rep[[1]]$"st_gr"))+ (snowad.rep[[1]]$"am2"+snowad.rep[[1]]$"b1"*(20:135))*pnorm(((20:135) -snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr")
  mlength[[x]]<-tempM
  
}

par(mfrow=c(2,1),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
Finc<-GrowthData[,2]-GrowthData[,1]
plot(Finc~GrowthData[,1],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey',xaxt='n')
legend(bty='n',"topleft","Female")

for(x in 1:length(Scenarios))
 lines(flength[[x]]-c(20:135)~c(20:135),lty=x)

Minc<-GrowthData[,4]-GrowthData[,3]
plot(Minc~GrowthData[,3],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey')
legend(bty='n',"topleft","Male")
mtext(side=2,"Growth increment (mm)",outer=T,line=2)
mtext(side=1,"Premolt length (mm)",outer=T,line=2)
for(x in 1:length(Scenarios))
 lines(mlength[[x]]-c(20:135)~c(20:135),lty=x)
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="Model fits to catch data"}
#==retained catch biomass
par(mfrow=c(4,1),mar=c(.1,.1,.3,.1),oma=c(4,4.5,1,1))
plot(snowad.rep[[1]]$"Observed retained catch biomass"~RetCatchYrs,las=1,ylab="Retained catch biomass (t)", xaxt="n")
for(x in 1:length(Scenarios))
 lines(snowad.rep[[x]]$"Predicted retained catch biomas"~RetCatchYrs,lty=x)
legend("topright",bty='n',pch=c(NA,1),lty=c(1,NA),legend=c("Predicted","Observed"))
legend("topleft",bty='n',"Retained")

#===discard female biomass
plot(snowad.rep[[1]]$"observed female discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n")
for(x in 1:length(Scenarios))
  lines(snowad.rep[[x]]$"predicted female discard mortality biomass"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Discard (female)")

#===discard male biomass
plot(snowad.rep[[1]]$"observed male discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n",ylim=c(0,23))
for(x in 1:length(Scenarios))
 lines(snowad.rep[[x]]$"predicted discard male catch biomass"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Discard (male)")

#===trawl catch biomass
plot(snowad.rep[[1]]$"observed trawl catch biomass"[1:CatchYrN]~RetCatchYrs,las=1,ylab="Trawl bycatch (t)",xlab="Year")
for(x in 1:length(Scenarios))
  lines(snowad.rep[[x]]$"predicted trawl catch biomass"[1:CatchYrN]~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Trawl")
mtext(side=2,outer=T,line=3,"Biomass (t)")
mtext(side=1,outer=T,line=2.5,"Year")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

```

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=6,fig.cap="Model fits to pot CPUE data"}
plot(snowad.rep[[1]]$"observed pot fishery cpue"~ SurveyYrs[1:(length(SurveyYrs)-1)],ylim=c(0,450),las=1,ylab="",xlab="")
for(x in 1:length(Scenarios))
lines(snowad.rep[[x]]$"predicted pot fishery cpue"~SurveyYrs[1:(length(SurveyYrs)-1)],lty=x)
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j]  +   1.96*5,
		y1=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j] - 1.96*5)
}

mtext(side=1,"Year",line=2)
mtext(side=2,"CPUE",line=2)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Model fits to side by side survey experiments (2009 & 2010)"}

#===industry survey
ObsIndustry2009<-c(snowad.rep[[1]]$"Observed industry survey mature biomass",snowad.rep[[1]]$"observed trawl catch biomass")
ObsIndustry2010<-c(snowad.rep[[1]]$"Observed 2010 industry survey mature biomass",snowad.rep[[1]]$"observed trawl catch biomass")

#==length proportions from side by side surveys (2009, 2010)
par(mfrow=c(2,2))
par(mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
setYlim<-.2
plot(LengthBins,snowad.rep[[1]]$"bserved Prop industry survey female",ylim=c(0,setYlim),ylab="",pch=15,las=1,xaxt='n')
for(x in 1:length(Scenarios))
 lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry survey female",lty=x);
par(new=T)

plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry survey male",xaxt='n',ylab="",ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
   lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry survey male",lty=x,col=2);
legend("topleft",bty='n',"Industry 2009")

plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry nmfs survey female",ylim=c(0,setYlim),yaxt='n',ylab="",pch=15,las=1,xaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry nmfs survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry nmfs survey male",xaxt='n',ylab="",yaxt='n',ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"redicted Prop industry nmfs survey male",lty=x,col=2);
legend("topleft",bty='n',"NMFS 2009")
legend("topright",bty='n',col=c(1,2),pch=c(15,16),legend=c("Females","Males"))

plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry survey female",ylim=c(0,setYlim),ylab="",pch=15,las=1)
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry survey male",xaxt='n',ylab="",ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry survey male",lty=x,col=2);
legend("topleft",bty='n',"Industry 2010")

plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry nmfs survey female",ylim=c(0,setYlim),yaxt='n',ylab="",pch=15,las=1)
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry nmfs survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry nmfs survey male",xaxt='n',ylab="",yaxt='n',ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry nmfs survey male",lty=x,col=2);
legend("topleft",bty='n',"NMFS 2010")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="Model fits to female survey length proportion data"}

#==survey proportions (mature and immature by sex)
#==PUT THE SAMPLE SIZE IN THE FIGURE SOMEHOW==

PlotLenProps<-function(obs,obs2=NA,pred,pred2=NA,inYears,xquant,chopX,chopY,pointsize=1,YaxisN,XaxisN)
{
 Nobs<-nrow(obs)
 inRow<-ceiling(sqrt(Nobs))
 incol<-floor(sqrt(Nobs))
 par(mfcol=c(inRow,incol),mar=c(0.1,.1,.1,.1),oma=c(4,4,1,1))
 for(x in 1:Nobs)
 {
  plot(obs[x,]~xquant,pch=15,ylim=c(0,chopY),xlim=c(xquant[1],chopX),xaxt='n',yaxt='n',cex=pointsize)
   if(x==YaxisN)
     axis(side=2,las=1)
   if(x==XaxisN)
     axis(side=1,las=1)
  for(y in 1:length(Scenarios))
   lines(pred[[y]][x,-1]~xquant,lty=y)
  if(!is.na(obs2))
  {
   points(obs2[x,]~xquant,pch=16,col=2,cex=pointsize)
  for(y in 1:length(Scenarios))
   lines(pred2[[y]][x,-1]~xquant,lty=y,col=2)
  }
  legend("topright",legend=inYears[x],bty='n')
 }
}
 
#==this sucks, butwriting a function to do this has too many moving parts....
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion survey immature new female" + snowad.rep[[x]]$"Predicted proportion survey immature old female"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion survey mature new female" + snowad.rep[[x]]$"Predicted proportion survey mature old female"

PlotLenProps(obs =(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")[,-1],
             obs2=(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")[,-1],
             pred =inPred,
             pred2=inPred2,
             inYears = SurveyYrs,
             xquant = LengthBins,
             chopX = 80,
             chopY = 0.18,
             XaxisN = 7,
             YaxisN = 7)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Females","Immature","Mature"),bty='n')
                          plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
             
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for immature female survey length proportion data"}
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))

tempInObs<-(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey immature new female" + snowad.rep[[1]]$"Predicted proportion survey immature old female"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=12,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for mature female survey length proportion data"}
tempInObs<-(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey mature new female" + snowad.rep[[1]]$"Predicted proportion survey mature old female"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=12,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="Model fits to male survey proportion at length data"}


#==this sucks, butwriting a function to do this has too many moving parts....
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion survey immature new male" + snowad.rep[[x]]$"Predicted proportion survey immature old male"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion survey mature new male" + snowad.rep[[x]]$"Predicted proportion survey mature old male"

PlotLenProps(obs =(snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male")[,-1],
             obs2=(snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male")[,-1],
             pred =inPred,
             pred2=inPred2,
             inYears = SurveyYrs,
             xquant = LengthBins,
             chopX = 140,
             chopY = 0.08,
             pointsize = .7,
             XaxisN = 7,
             YaxisN = 7)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Males","Immature","Mature"),bty='n')
             plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
             
             
             
             
             
             
             
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for fits to immature male survey proportion at length data"}
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))
tempInObs<-snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male"
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey immature new male" + snowad.rep[[1]]$"Predicted proportion survey immature old male"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=22,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for fits to mature male survey proportion at length data"}
tempInObs<-snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male"
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey mature new male" + snowad.rep[[1]]$"Predicted proportion survey mature old male"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=22,sampsize=rep(200,12),maxres=10)
```               
           
\newpage
  
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="Observed and predicted average size in the survey composition data"}
## check things are summing as theyshould be
tempFimm<-(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")[,-1]
Fi<-apply(tempFimm,1,sum)
tempFmat<-(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")[,-1]
FM<-apply(tempFmat,1,sum)
tempMimm<-(snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male")[,-1]
Mi<-apply(tempMimm,1,sum)
tempMmat<-(snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male")[,-1]
MM<-apply(tempMmat,1,sum)

# Fi+FM+Mi+MM

tempFimm<-(snowad.rep[[1]]$"Predicted proportion survey immature new female" + snowad.rep[[1]]$"Predicted proportion survey immature old female")[,-1]
Fi<-apply(tempFimm,1,sum)
tempFmat<-(snowad.rep[[1]]$"Predicted proportion survey mature new female" + snowad.rep[[1]]$"Predicted proportion survey mature old female")[,-1]
FM<-apply(tempFmat,1,sum)
tempMimm<-(snowad.rep[[1]]$"Predicted proportion survey immature new male" + snowad.rep[[1]]$"Predicted proportion survey immature old male")[,-1]
Mi<-apply(tempMimm,1,sum)
tempMmat<-(snowad.rep[[1]]$"Predicted proportion survey mature new male" + snowad.rep[[1]]$"Predicted proportion survey mature old male")[,-1]
MM<-apply(tempMmat,1,sum)

par(mfrow=c(3,2),mar=c(.1,.1,.1,.1),oma=c(4,6,2,1))
for(x in c(1,2,5,6,7,8))
 {
  plot(snowad.rep[[2]]$"Observed Lbar"[x,]~SurveyYrs, pch=16,col=1,las=1,ylim=c(20,100),xaxt='n',yaxt='n')
  if(x==7 | x==1 |x==5)
    axis(side=2,las=1)

  if(x==7 | x==8)
    axis(side=1)
 for(y in 1:length(Scenarios))
 {
  inputPreds<-rbind(snowad.rep[[y]]$"Predicted Lbar new shell",snowad.rep[[y]]$"Predicted Lbar old shell")
  if(length(inputPreds)>0)
  {
    inputPreds<-inputPreds[c(1,2,5,6,3,4,7,8),]
    lines(inputPreds[x,]~SurveyYrs,lty=y)
  }
 }
} 
mtext(outer=T,side=2,"Average size (mm)",line=2.5,adj=.5)
mtext(outer=T,side=3,adj=.25,"Females")
mtext(outer=T,side=3,adj=.75,"Males")
mtext(outer=T,side=1,"Year",line=2)
mtext(outer=TRUE,side=2,adj=.1,"New shell immature",line=4)
mtext(outer=TRUE,side=2,adj=.5,"New shell mature",line=4)
mtext(outer=TRUE,side=2,adj=.9,"Old shell mature",line=4)

legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="Model predicted mature male biomass at mating time"}
#=========================================================
#  Plot derived quantities
#=========================================================
# estimated male, female, mature male, total and effective mature biomass (indicate proxy bmsy)
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"Mature male biomass at mating"[1:SurvYrN]~SurveyYrs,type="l",ylim=c(0,350),las=1,xaxt='n')
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"Mature male biomass at mating"[1:SurvYrN]~SurveyYrs,type="l",lty=x)
legend("topleft",bty='n',"Males")

plot(snowad.rep[[1]]$"Mating time Female Spawning Biomass"[1:SurvYrN]~SurveyYrs,type="l",ylim=c(0,550),las=1)
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"Mating time Female Spawning Biomass"[1:SurvYrN]~SurveyYrs,type="l",lty=x)
legend("topleft",bty='n',"Females")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=9,fig.cap="Model predicted fishing mortalities and selectivities for all sources of mortality"}
## estimated quanties
# fishing mortality and fishery selectivities
par(mfrow=c(3,2),mar=c(.1,.1,.3,.1),oma=c(4,5,2,4))
plot(snowad.rep[[1]]$"estimated annual total fishing mortality"~RetCatchYrs, type="l",las=1,xaxt='n',xlim=c(min(RetCatchYrs),max(RetCatchYrs)),ylim=c(0,4))
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual total fishing mortality"~RetCatchYrs,lty=x)
legend("topright",bty='n',"Directed")

plot(snowad.rep[[1]]$"selectivity fishery retained old male"[1,]~LengthBins,type='l',yaxt='n',xaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity fishery retained old male"[1,]~LengthBins,lty=x)
axis(side=4,las=1)
for(x in 1:length(Scenarios))
  {
   lines(snowad.rep[[x]]$ "selectivity fishery total new male"[1,]~LengthBins,lty=x,col=2) 
   lines(snowad.rep[[x]]$ "retention curve new male" ~LengthBins,lty=x,col=3) 
   }
legend("topleft",lty=c(1,2),bty='n',c("Total","Retained")) ## CHANGE THIS

 
plot(snowad.rep[[1]]$"estimated annual fishing mortality trawl bycatch"~RetCatchYrs,type="l",las=1,xaxt='n',xlim=c(min(RetCatchYrs),max(RetCatchYrs)))
legend("topright",bty='n',"Trawl")
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual fishing mortality trawl bycatch"~RetCatchYrs,lty=x)
plot(snowad.rep[[1]]$"selectivity trawl female"~LengthBins,type='l',yaxt='n',xaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity trawl female"~LengthBins,lty=x)
axis(side=4,las=1)
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

plot(snowad.rep[[1]]$"estimated annual fishing mortality females pot"~RetCatchYrs, type="l",las=1,xlim=c(min(RetCatchYrs),max(RetCatchYrs)))
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual fishing mortality females pot"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Female discard")
plot(snowad.rep[[1]]$"selectivity discard female"[1,]~LengthBins,type='l',yaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity discard female"[1,]~LengthBins,lty=x)
axis(side=4,las=1)

mtext(side=2,outer=T,expression(y^-1),line=3.25)
mtext(side=4,outer=T,"Probability",line=2.5)
mtext(side=3,outer=T,"Estimated fishing mortality",adj=.1)
mtext(side=3,outer=T,"Selectivity",adj=.8)
mtext(side=1,outer=T,"Year",adj=.2,line=2)
mtext(side=1,outer=T,"Length (mm)",adj=.8,line=2)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="Estimated survey selectivity"}
#=========================================================
# survey selectivities, molting probability, weight at length
#=======================================================
par(mfrow=c(3,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"selectivity survey female Era 1"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 1"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 1"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}

legend("topleft",legend=c("1978-1981"),bty='n')
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

plot(snowad.rep[[1]]$"selectivity survey female Era 2"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 2"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 2"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",legend=c("1982-1988"),bty='n')
legend("bottomright",col=c(1,2),legend=c("Female","Male"),bty='n',pch=16)


plot(snowad.rep[[1]]$"selectivity survey female Era 3"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="")
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 3"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 3"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",legend=c("1989-present"),bty='n')
mtext(side=1,"Length (mm)",line=2)
mtext(side=2,"Survey selectivity",line=2.5,outer=T)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=6,fig.cap="Predicted probability of maturity"}

# molting probabillities, weight at length
par(mfrow=c(1,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))

plot(snowad.rep[[1]]$"Predicted probability of maturing female"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"Predicted probability of maturing female"~LengthBins, col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"Predicted probability of maturing male"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",col=c(1,2),legend=c("Female","Male"),bty='n',pch=16)
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)


# plot(snowad.rep[[1]]$"Molting probability female"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
# for(x in 1:length(Scenarios))
# {
# lines(snowad.rep[[1]]$"Molting probability femal"~LengthBins, col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
# lines(snowad.rep[[1]]$"Molting probability male"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
# }
# legend("bottomleft",col=c(1,2),legend=c("Female","Male"),"Molting",bty='n')
# legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Model fits to catch data"}
# estimated fishing mortality vs estimated spawning stock biomass (kobe plot)
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))
plot(-100000,type="l",las=1,
     ylim=c(0,max(snowad.rep[[1]]$"estimated annual total fishing mortality")),
     xlim=c(0,max(snowad.rep[[1]]$"Mature male biomass at mating"[1:CatchYrN])),
     ylab="",xlab="")
text(labels=RetCatchYrs, y=snowad.rep[[1]]$"estimated annual total fishing mortality",x=snowad.rep[[1]]$"Mature male biomass at mating"[1:CatchYrN],cex=.5)
mtext(side=1,"Mature male biomass at mating (t)",line=2)
mtext(side=2,"Fully-selected fishing mortality",line=2.3)
abline(h=F35,lty=2)
abline(v=B35,lty=2)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=6,fig.height=9,fig.cap="Estimated recruitment, fits to stcok recruit curve (MMB lagged 4 years), and estimated proportions recruiting to length bin"}
# fit of stock recruitment relationship
par(mfrow=c(3,1),mar=c(4,4,1,1),oma=c(1,2,1,1))
LagRecs<-4

plot(snowad.rep[[1]]$"estimated number of recruits female"/10000~SurveyYrs[1:length(SurveyYrs)-1],ylab="",type="l",las=1,xlab="")
 mtext(side=1,"Year",line=3)
 mtext(side=2,"Recruits (10000)",line=3)

if(length(Scenarios)>1)
for(y in 2:length(Scenarios))
 lines(snowad.rep[[y]]$"estimated number of recruits female"/10000~SurveyYrs[1:length(SurveyYrs)-1],lty=y)

 Recruits<-matrix(ncol=(CatchYrN-LagRecs+1),nrow=length(Scenarios))
 inMMB<-matrix(ncol=(CatchYrN-LagRecs+1),nrow=length(Scenarios))
 
 for(y in 1:length(Scenarios))
{
Recruits[y,]<-snowad.rep[[y]]$"estimated number of recruits female"[LagRecs:length(snowad.rep[[y]]$"estimated number of recruits female")]
inMMB[y,]<-snowad.rep[[y]]$"Mature male biomass at mating"[1:(CatchYrN-LagRecs+1)]
 }
 
 plot(Recruits[1,]~inMMB[1,],
     ylab="",xlab="",
     ylim=c(0,max(Recruits)),
     xlim=c(0,max(inMMB)),
     las=1,pch=16)
mtext(side=1,"Mature male biomass (t)",line=3)
mtext(side=2,"Recruits (10000)",line=3)

for(y in 2:length(Scenarios))
   points(Recruits[y,]~inMMB[y,],col=y,pch=16)

legend("topright",bty='n',col=seq(1,length(Scenarios)),pch=16,legend=Scenarios)

#==fit a stock recruit relationship
Ricker<-function(x,SpBio,Rec)
{
  alpha<-abs(x[1])
  beta<-abs(x[2])
  sigma<-abs(x[3])
  Pred<-SpBio*exp(alpha-beta*SpBio)
  loglike<- log(1/(sqrt(2*3.1415*sigma^2))) - ((log(Pred)-log(Rec))^2)/(2*sigma^2)
  return(sum(-1*loglike))
}

for(y in 1:length(Scenarios))
{
x<-c(1,1,0.5)
outs<-nlminb(x,Ricker,SpBio=inMMB[y,],Rec=Recruits[y,])
x<-outs$par
  alpha<-abs(x[1])
  beta<-abs(x[2])
  sigma<-abs(x[3])
  plotSpbio<-seq(1,max(inMMB),10)
  Pred<-plotSpbio*exp(alpha-beta*plotSpbio)
  lines(Pred~plotSpbio,lty=y)
}

for(y in 1:length(Scenarios))
{
  if(y==1)
 {
  plot(snowad.rep[[y]]$"distribution of recruits to length bins"~LengthBins,yaxt='n',type='l',xlab="",ylab='n')
  axis(side=2,las=1)
  mtext(side=1,"Length (mm)",line=3)
  mtext(side=4,line=2.5,"Proportion recruiting")
 }
 if(y>1)
  lines(snowad.rep[[y]]$"distribution of recruits to length bins"~LengthBins,lty=y)
}
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)


```  
    
\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=9,fig.cap="Model predicted ratio of catch to mature male biomass"}
#=========================================================
#  Plot derived quantities
#=========================================================
# estimated male, female, mature male, total and effective mature biomass (indicate proxy bmsy)
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"estimated total catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs, type="l",ylim=c(0,.6),las=1,xaxt='n')
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
legend("topleft",bty='n',"Total catch")
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"estimated total catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs,type="l",lty=x)

plot(snowad.rep[[1]]$"estimated retained catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs, type="l",ylim=c(0,.6),las=1)

for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"estimated retained catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs,type="l",lty=x)
legend("topleft",bty='n',"Retained catch")
mtext(outer=T,side=2,"Proportion",line=2.5)
```
                                                          
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=6,fig.cap="Retrospective pattern in MMB for chosen model"}

 RetroN<-4
 Chosen<-"Model 3a SmoothMat_Weight"
 # pull out MMB (or other quantities)
 RetroMMB<-matrix(ncol=length(SurveyYrs)-1,nrow=RetroN+1)
 REPfile <-readLines(paste(TakeDir,Chosen,"/2016sc.REP",sep=""))
 tmp<-grep("male spawning biomass at matetime",REPfile)[2]
 tmpMMB<-as.numeric(unlist(strsplit(REPfile[tmp+1]," ")))
 RetroMMB[1,]<-tmpMMB[!is.na(tmpMMB)]
 for(x in 1:RetroN)
 { 
  REPfile <-readLines(paste(TakeDir,Chosen,"/Retro_",x,"/2016sc.REP",sep=""))
  tmp<-grep("male spawning biomass at matetime",REPfile)[2]
  tmpMMB<-as.numeric(unlist(strsplit(REPfile[tmp+1]," ")))
  tmpMMB<-tmpMMB[!is.na(tmpMMB)]
  for(y in 1:(length(tmpMMB)-x))
   RetroMMB[x+1,y]<-tmpMMB[y]
 }

 # plot quantities
plot(RetroMMB[1,]~SurveyYrs[-length(SurveyYrs)],type="l",las=1,ylab='MMB (t)',xlab="Year")
for(x in 2:nrow(RetroMMB))
 lines(RetroMMB[x,]~SurveyYrs[-length(SurveyYrs)],col=x)


#  DO ALL OF THE MCMC AND THE RETROSPECTIVE PATTERN PLOTS HERE
# sdfile      <-read.table(paste(TakeDir,"2016sc.std",sep=""))
# corfile     <-readLines(paste(TakeDir,"2016sc.cor",sep=""),skip=1)
# recruitsd   <-sdfile[sdfile[,2]=="recm_sd",]

#==MCMC stuff==========================

#PSV <- file(paste(TakeDir,"/2016sc.psv",sep=""), "rb")
#nopar1 <- readBin(PSV, what=integer(), n=1)
#mcmc1 <- readBin(PSV, what=numeric(), n=nopar1 * 10000)
#mcmc1 <- matrix(mcmc1, byrow=TRUE, ncol=nopar1)

# VariableNames<-rep(0,nopar1)
# for(x in 1:nopar1)
# {
#  temp<-unlist(strsplit((corfile[x+2]),split=" "))
#  if(x<10)
#  VariableNames[x]<-temp[9]
#  if(x>=10&x<100)
#   VariableNames[x]<-temp[8]
#  if(x>100)
#   VariableNames[x]<-temp[7]
# }
# 
# colnames(mcmc1)<-VariableNames

PlotTrace<-function(input)
{
Trace<-rep(0,length(input))
for(x in 1:length(Trace))
  Trace[x]<-as.numeric(unlist(strsplit(as.character(input[[x]][1]),split=" "))[1])
return(Trace[!is.na(Trace)])
}

REPfileEnd      <-readLines(paste("C:/SnowCrab/",Chosen,"/2016sc.REP",sep=""))
MgmtQuants      <-as.numeric(unlist(strsplit(as.character(REPfileEnd[1]),split=" ")))
names(MgmtQuants)<-c("F","BMSY","Surv_MMB","Fish_MMB","Mate_MMB","F35","FOFL","OFL")

mcEval      <-readLines(paste("C:/SnowCrab/",Chosen,"/eval.csv",sep=""))
EvalOuts    <-rep(list(list()),4000)
EvalCounter <-seq(1,length(mcEval),17)

for(x in 1:length(EvalOuts))
 for(y in 0:16)
  EvalOuts[[x]][y+1]<-mcEval[EvalCounter[x]+y]

par(mfrow=c(2,1),mar=c(2,2,.1,.1))
plot(PlotTrace(EvalOuts))
acf(PlotTrace(EvalOuts))

inChop<-8
outChop<-2900
useEval<-EvalOuts[inChop:outChop]

par(mfrow=c(2,1),mar=c(2,2,.1,.1))
plot(PlotTrace(useEval))
acf(PlotTrace(useEval))

Thin<-14
inSeq<-c(seq(1,length(useEval),Thin))
useEval<-useEval[inSeq]

par(mfrow=c(2,1),mar=c(2,2,.1,.1))
plot(PlotTrace(useEval))
acf(PlotTrace(useEval))



#==B35 posterior==
B35<-rep(0,length(inSeq))
for(x in 1:length(useEval))
  B35[x]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][1]),split=" "))[2])

#==F35 posterior==
F35<-rep(0,length(inSeq))
for(x in 1:length(useEval))
  F35[x]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][1]),split=" "))[3])


#==FOFL posterior==
FOFL<-rep(0,length(inSeq))
for(x in 1:length(useEval))
  FOFL[x]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][1]),split=" "))[4])

#==OFL posterior==
OFL<-rep(0,length(inSeq))
for(x in 1:length(useEval))
  OFL[x]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][1]),split=" "))[5])


par(mfrow=c(2,2),mar=c(3,.1,.1,.1),oma=c(2,2,1,1))
hist(B35,main="",las=1,ylab="",xlab="",yaxt='n',col="lightgrey")
abline(v=median(B35),lty=2,col=2)
abline(v=MgmtQuants[2],col=4,lty=2)
legend("topleft","B35",bty='n')

hist(F35,main="",las=1,ylab="",xlab="",yaxt='n',col="lightgrey")
abline(v=median(F35),lty=2,col=2)
abline(v=MgmtQuants[6],col=4,lty=2)
legend("topleft","F35",bty='n')

hist(FOFL,main="",las=1,ylab="",xlab="",yaxt='n',col="lightgrey")
abline(v=median(FOFL),lty=2,col=2)
abline(v=MgmtQuants[7],col=4,lty=2)
legend("topleft","FOFL",bty='n')

hist(OFL,main="",las=1,ylab="",xlab="",yaxt='n',col="lightgrey")
abline(v=median(OFL),lty=2,col=2)
abline(v=MgmtQuants[8],col=4,lty=2)
legend("topleft","OFL",bty='n')

# pdf("C:/SnowCrab/posteriors.pdf")
# for(x in 1:ncol(mcmc1))
#  hist(mcmc1[,x],main=colnames(mcmc1)[x])
# dev.off()

#parameters
#time series of catch divided by biomass
 
# marginal distributions for fits to the compositional data
# time series of implied effective sample sizes
# RMSE for indices
# q q plots and historgrams of residuals to justify sampling distributions for the data


# 
# retrospective analysis

```

































