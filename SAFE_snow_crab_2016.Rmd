---
author: "Cody Szuwalski"
date: "Sept 16, 2016"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 6
number_sections: yes
csl: fish-and-fisheries.csl
toc: yes
title: "A stock assessment for eastern Bering Sea snow crab"
---

\newpage

# Executive summary

```{r,echo=F,message=FALSE,warning=F}
library(knitr)
library(ggplot2)
library(PBSmodelling)
library(pander)

# directory in which all of the scenario folder reside and names of the scenario folders
TakeDir     <-"C:/SnowCrab/"
Scenarios   <-c("Model 0","Model 1c TrawlF_2vec_200","Model 2a MatPrior_200","Model 3b SmoothMat_Disc50_200")
ScenarioNames<-c("Base","Model 1 (TrawlF)","Model 2 (Maturity)","Model 3 (Maturity and weighting)")

Scenarios   <-c("Model 0","Model 1c TrawlF_2vec_200","Model 1c TrawlF_2vec","Model 2a MatPrior_200","Model 2a MatPrior","Model 3b SmoothMat_Disc50_200","Model 3b SmoothMat_Disc50")
ScenarioNames<-c("0","1","1a","2","2a","3","3a")
ChosenModel<-c("Model 3b SmoothMat_Disc50_200")
ChosenInd<-which(Scenarios==ChosenModel)
# Scenarios   <-c("Model 1c TrawlF_2vec_200","Model 2a MatPrior","Model Xa FreeSurv3sel")
# ScenarioNames<-c("Model 1 TrawlF","Model 2 (Maturity)","Model X ")

#==This gets the counters that are constant from scenario to scenario
# Read data file
DATfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.DAT",sep=""))

# length of data types
tmp<-grep("number of years of retained fishery data",DATfile)
CatchYrN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of survey data",DATfile)
SurvYrN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of fishery discard",DATfile)
DiscYrFN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of fishery male discard",DATfile)
DiscYrMN <-as.numeric(DATfile[tmp+1])
tmp<-grep("number of years of trawl discard",DATfile)
TrawlYrN <-as.numeric(DATfile[tmp+1])

# observed retained catch
tmp<-grep("retained catch in numbers",DATfile)
ObsCatchNumbers<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]
tmp<-grep("retained catch in pounds",DATfile)
ObsCatchPounds<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]
tmp<-grep("years for fishery data",DATfile)
RetCatchYrs<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))

# observed discard
tmp<-grep("Discard Catch from observer",DATfile)
ObsDiscF<-as.numeric(DATfile[(tmp+2):(tmp+1+CatchYrN)])[1:CatchYrN]
tmp<-grep("discard catch males",DATfile)
ObsDiscM<-as.numeric(DATfile[(tmp+1):(tmp+CatchYrN)])[1:CatchYrN]

# observed trawl
tmp<-grep("trawl bycatch numbers by geartype",DATfile)
TrawlBycatch<-as.numeric(DATfile[(tmp+2):(tmp+1+CatchYrN)])[1:CatchYrN]

# survey numbers
tmp<-grep("survey numbers by year",DATfile)
SurveyNumbers<-as.numeric(DATfile[(tmp+1):(tmp+SurvYrN)])
tmp<-grep("years for survey data",DATfile)
SurveyYrs<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))

#==make a list of the scenario names
##==save all of the output from the scenarios
snowad.rep<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  snowad.rep[[x]]  <-readList(paste(TakeDir,Scenarios[x],"/R_input.txt",sep=""))

REPfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.REP",sep=""))

 source("C:/SnowCrab/SnowCrabCode/Rscripts/error_bar.R")
 source("C:/SnowCrab/SnowCrabCode/Rscripts/plot.sizcomps.r.nosp.R")
 source("C:/SnowCrab/SnowCrabCode/Rscripts/plot.bubble.residuals.addn.R")

tmp<-grep("length bins",DATfile)[[5]]
LengthBins<-as.numeric(unlist(strsplit(DATfile[(tmp+1)],split=" ")))
LengthBins<-LengthBins[!is.na(LengthBins)]


  #  DO ALL OF THE MCMC AND THE RETROSPECTIVE PATTERN PLOTS HERE
  # sdfile      <-read.table(paste(TakeDir,"2016sc.std",sep=""))
  # corfile     <-readLines(paste(TakeDir,"2016sc.cor",sep=""),skip=1)
  # recruitsd   <-sdfile[sdfile[,2]=="recm_sd",]
  
  #==MCMC stuff==========================
  
MCMCpars<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
{
  PSV             <- file(paste(TakeDir,Scenarios[x],"/2016sc.psv",sep=""), "rb")
  nopar1          <- readBin(PSV, what=integer(), n=1)
  mcmc1           <- readBin(PSV, what=numeric(), n=nopar1 * 10000)
  MCMCpars[[x]]           <- matrix(mcmc1, byrow=TRUE, ncol=nopar1)
}  


 PlotTrace<-function(input)
  {
    trace <-rep(0,length(input))
    for(x in 1:length(Trace))
      Trace[x]<-as.numeric(unlist(strsplit(as.character(input[[x]][1]),split=" "))[1])
    return(Trace[!is.na(Trace)])
  }
 
#==pulling MLEs for management quantities
REPfileEnd<-rep(list(list()),length(Scenarios))
MgmtQuants<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
{
  REPfileEnd[[x]]       <-readLines(paste("C:/SnowCrab/",Scenarios[x],"/2016sc.REP",sep=""))
  MgmtQuants[[x]]       <-as.numeric(unlist(strsplit(as.character(REPfileEnd[[x]][1]),split=" ")))
  MgmtQuants[[x]]$Status<-as.numeric(MgmtQuants[[x]][5])/as.numeric(MgmtQuants[[x]][2])
  names(MgmtQuants[[x]])<-c("F","BMSY","Surv_MMB","Fish_MMB","Mate_MMB","F35","FOFL","OFL","Status")
  }

#==pulling posterior distributions for everything
mcEval<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  mcEval[[x]]  <-readLines(paste("C:/SnowCrab/",Scenarios[x],"/eval.csv",sep=""))

MCMCreps    <-4000
EvalOuts    <-rep(list(rep(list(list()),MCMCreps)),length(Scenarios))
EvalCounter <-seq(1,length(mcEval[[1]]),17)

for(z in 1:length(Scenarios))
 for(x in 1:MCMCreps)
  for(y in 0:16)
    EvalOuts[[z]][[x]][y+1]<-mcEval[[z]][EvalCounter[x]+y]

# inChop<-100
# outChop<-4000
# useEval<-EvalOuts[inChop:outChop]
# Thin<-1
# inSeq<-c(seq(1,length(useEval),Thin))
# useEval<-useEval[inSeq]
# par(mfrow=c(1,2),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
# plot(PlotTrace(EvalOuts))
# acf(PlotTrace(EvalOuts))

useEval<-EvalOuts

  #==B35 posterior==
  B35<-list()
  temp<-rep(0,length(useEval[[1]]))
  for(x in 1:length(useEval))
  {
    for(y in 1:length(temp))
      temp[y]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][[y]][1]),split=" "))[2])
    B35[[x]]<-temp
  }
  
  #==F35 posterior==
  F35<-list()
  temp<-rep(0,length(useEval[[1]]))
  for(x in 1:length(useEval))
  {
    for(y in 1:length(temp))
      temp[y]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][[y]][1]),split=" "))[3])
    F35[[x]]<-temp
  }
  
  #==FOFL posterior==
  FOFL<-list()
  temp<-rep(0,length(useEval[[1]]))
  for(x in 1:length(useEval))
  {
    for(y in 1:length(temp))
      temp[y]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][[y]][1]),split=" "))[4])
    FOFL[[x]]<-temp
  }
  
  #==OFL posterior==
  OFL<-list()
  temp<-rep(0,length(useEval[[1]]))
  for(x in 1:length(useEval))
  {
    for(y in 1:length(temp))
      temp[y]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][[y]][1]),split=" "))[5])
    OFL[[x]]<-temp
  }
 
  #==MMB posterior==
  MMB<-list()
  temp<-rep(0,length(useEval[[1]]))
  for(x in 1:length(useEval))
  {
    for(y in 1:length(temp))
      temp[y]<-as.numeric(unlist(strsplit(as.character(useEval[[x]][[y]][4]),split=" "))[SurvYrN+1])
    MMB[[x]]<-temp
  } 

 ABC<-rep(0,length(Scenarios))
 for(x in 1:length(ABC))
   ABC[x]<-  quantile(OFL[[x]],probs=0.49)*0.9
 
 #==Status posterior==
  Status<-list()
  for(x in 1:length(useEval))
   Status[[x]]<-MMB[[x]]/B35[[x]]

```


1. Stock: Eastern Bering Sea snow crab, *Chionoecetes opilio*.

2. Catches: trends and current levels

Retained catches increased from relatively low levels in the early 1980s (e.g. retained catch of `r round(snowad.rep[[1]]$"Observed retained catch biomass"[4],2)` t during 1981) to historical highs in the early and mid-nineties (retained catch during 1991, 1992, and 1998 were `r round(snowad.rep[[1]]$"Observed retained catch biomass"[14],2)`, `r round(snowad.rep[[1]]$"Observed retained catch biomass"[15],2)`, and `r round(snowad.rep[[1]]$"Observed retained catch biomass"[21],2)` t, respectively).  The stock was declared overfished in 1999 at which time retained catches dropped to levels similar to the early 1980s (e.g. retained catch during 2000 was `r round(snowad.rep[[1]]$"Observed retained catch biomass"[23],2)` t). Retained catches have slowly increased since 1999 as the stock rebuilt with a retained catch of `r round(snowad.rep[[1]]$"Observed retained catch biomass"[SurvYrN-1],2)` during 2016. 

Discard mortality is the next largest source of mortality after retained catch and approximately tracks the retained catch. The highest estimated discard mortality occurred during 1993 at `r round(snowad.rep[[1]]$"observed male discard mortality biomass"[15],2)` t which was `r round(as.numeric(round(snowad.rep[[1]]$"observed male discard mortality biomass"[15],2)) / as.numeric(round(snowad.rep[[1]]$"Observed retained catch biomass"[15],2)),2)`% of the retained catch.
The most recent estimated mortality was `r round(snowad.rep[[1]]$"observed male discard mortality biomass"[37],2)` t which was `r round(as.numeric(round(snowad.rep[[1]]$"observed male discard mortality biomass"[37],2)) / as.numeric(round(snowad.rep[[1]]$"Observed retained catch biomass"[37],2)),2)`% of the retained catch.

3. Stock Biomass: 

Observed mature male biomass (MMB) at the time of the survey has increased from an average of `r round(mean(snowad.rep[[1]]$"Observed survey male spawning biomass"[1:10]),2)` t in the early to mid-1980s to historical highs in the early and mid-nineties (observed MMB during 1990, 1991, and 1997 were `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[13],2)`, `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[14],2)`, and `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[20],2)` t, respectively).  The stock was declared overfished in 1999 in response to the total mature biomass dropping below the minimum stock size threshold.  MMB in that year decreased to `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[22],2)` t. Observed MMB has slowly increased since 1999 as the stock rebuilt, and the stock was declared rebuilt in 2011 when estimated MMB at mating was above B35%.  However, the observed MMB at the time of survey dropped to an all time low in 2016 of `r round(snowad.rep[[1]]$"Observed survey male spawning biomass"[SurvYrN],2)` t during `r SurveyYrs[SurvYrN]`.

4. Recruitment

Estimated recruitment shifts from a period of high recruitment to a period of low recruitment in the mid 1990s (late 1980s when lagged to fertilization). Recent estimated recruitments have been above the average of the 'low' period , but are still beneath the average of the 'high' recruitment period. Recent survey length frequency data reflect what may be the largest recruitment event seen since the early 1990s, but data informing the estimates of numbers in the smaller size classes are still uncertain. 

5. Management 


```{r,echo=F}

ManTable <-read.csv("C:/SnowCrab/ManagementTable.csv")
PlotTab<- data.frame(ManTable)
colnames(PlotTab)<-c("Year","MSST","Biomass (MMB)","TAC","Retained catch","Total catch", "OFL","ABC")

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10,caption="Historical status and catch specifications for snow crab (1,000t).")

# PoundTab<-PlotTab
# PoundTab[,c(2,3,4,5,6,7,8)]<-as.numeric(PoundTab[,c(2,3,4,5,6,7,8)])*2.20462
# pander(PoundTab,split.cells=10)
```


```{r,echo=F}
ManTable <-read.csv("C:/SnowCrab/ManagementTable.csv")
PlotTab<- data.frame(ManTable)
colnames(PlotTab)<-c("Year","MSST","Biomass (MMB)","TAC","Retained catch","Total catch", "OFL","ABC")

PlotTab[,c(2,3,4,5,6,7,8)]<-round((PlotTab[,c(2,3,4,5,6,7,8)])*2.20462,2)
pander(PlotTab,split.cells=10,caption="Historical status and catch specifications for snow crab (millions of lbs).")
```

6.  Basis for the OFL 

The OFL for `r SurveyYrs[SurvYrN]` for the chosen model was `r round(median(OFL[[ChosenInd]]),2)` t fishing at FOFL = `r round(median(FOFL[[ChosenInd]]),2)` (`r round(median(FOFL[[ChosenInd]])/median(F35[[ChosenInd]]),2)` % of the estimated F35%, `r round(median(F35[[ChosenInd]]),2)`).  The calculated OFL was a `r round((median(OFL[[ChosenInd]])-ManTable[nrow(ManTable),7])/ManTable[nrow(ManTable),7],2)*100`% change from the `r SurveyYrs[SurvYrN-1]` OFL of `r ManTable[nrow(ManTable),7]` t.  The current ratio of MMB at the time of mating to B~35%*~ is `r round(median(Status[[ChosenInd]]),2)`.   

7.	Probability Density Function of the OFL

The probabillity density function of the OFL was characterized by using a Markov Chain Monte Carlo algorithm to generate a posterior distribution of the OFL.  This allows all uncertainty in the data to which the model was fitted to be propagated forward into the OFL calculation. 

8.	Basis for ABC 

The ABC was specified as `r round(ABC[[ChosenInd]],2)` by calculating the 49th quantile of the posterior distribution of the OFL and subtracting a 10% buffer as recommended by the SSC.  

```{r,echo=F}


PlotTab<- data.frame(Model=ScenarioNames,
                     OFL=unlist(lapply(OFL,median)),
                     B35=unlist(lapply(B35,median)),
                     MMB=unlist(lapply(MMB,median)),
                     Status=unlist(lapply(Status,median)),
                     F35=unlist(lapply(F35,median)),
                     FOFL=unlist(lapply(FOFL,median)),
                     ABC=ABC)

rownames(PlotTab)<- NULL
PlotTab[,c(2:8)]<-round(PlotTab[,c(2:8)],2)
pander(PlotTab,split.cells=c(18,rep(10,7)),justify=c("left",rep("center",7)),caption="\\label{projManage}Projected status and catch specifications for snow crab (1,000t).")
  
```

```{r,echo=F}
NextPlot<-PlotTab
NextPlot[,c(2:4,8)]<-round(NextPlot[,c(2:4,8)]*2.20462,2)
pander(NextPlot,c(18,rep(10,7)),justify=c("left",rep("center",7)),caption="Projected status and catch specifications for snow crab (millions of lbs).")
```


\newpage
# A.  Summary of Major Changes 

1. Management: None 

2. Input data: 

Data added to the assessment included:  `r SurveyYrs[SurvYrN]` Bering Sea survey biomass and length frequency data;  `r SurveyYrs[SurvYrN-1]` directed fishery retained and discard catch and length frequencies for retained and discard catch;  and groundfish discard length frequency and discard catch from `r SurveyYrs[SurvYrN-1]`. Five additional data points for growth increment were also included and weight at length parameters for mature females were revised.

3. Assessment methodology: 

Four models are presented in this assessment with several incremental steps, each of which are illustrated. Model 0 represents the 2015 model with minor structural changes suggested by the CPT implemented and serves as a basis for comparison between previous years' assessments.  Model 1 addresses the way in which fishing mortality in the trawl fleet is estimated. Model 2 removes the priors on maturity. Model 3 changes the way maturity is estimated.  Model 3a was the selected model for which MCMC was implemented and on which presented management quantities are based because estimating discard selectivity for females resulted in a model in which no females were selected for discard.

The projection framework is now Bayesian (e.g. management quantities like MMB or the OFL are identified as the medians of posterior distributions resulting from a Markov Chain Monte Carlo algorithm).  This is preferable to the previous projection framework because it explicitly incorporates uncertainty in all parameters, rather than only numbers at length.

4. Assessment results

Comment on changes in MMB from last year and recruitment estimates.

\newpage
# B. CPT May 2016 comments, SSC comments, and author response:
## CPT and SSC comments

CPT comments were divided into two categories and there were no significant comments from the SSC.

* Changes to model structure and presentation of results
    + show fits to the pot CPUE data
    + Provide a retrospective analysis
    + Implement Francis weighting method and report weights
    + Provide plots of the observed and model-predicted mean lengths
    + Ensure catchability for all surveys is bounded at one
    + Document the jittering approach

* Model scenarios to be explored:
    + Model 0: (Base) A model with only the small structural changes from above implemented to provide a comparison to last year's model
    + Model 1: (TrawlF) A model modifying the way in which the fishing mortality in the groundfish trawl fishery is modeled, including the following changes:
        * Estimate average F for the groundfish trawl, rather than specifying it,
        * Remove penalties on F from 1992 to present
        * Estimate a separate vector of F_devs for 1978-90 and 1991-present
        * Estimate a constant of proportionality between fishing effort in the pot fishery and F for the females in the pot fishery
    + Model 2: (MaturePrior) A model in which the priors on probabillity of maturing for males and females are removed (in addition to the changes made in Model 1)
    + Model 3: (MatureSmooth) A model in which I:
        * Increase the weight on the second difference penalty for the probability of maturity 
        * Estimate the 50% selectivity parameter for female discard 

Several other changes were made to the code, including: rearranging the code to improve readability and functionality (e.g. deleting legacy code and adding space in arrays to allow for calculation of reference points, alllowing the weight at length parameters to be input, rather than included in the .DAT file as a prespecified vector), migrating constants to control file, correcting the conversion for tonnes to million pounds, and adding a rec_dev for the end year.

All changes were undertaken in a stepwise fashion and the resulting changes in the estimated MMB and parameters were recorded (Table X).  Only scenarios for which large changes in estimated parameters and MMB resulted from a given change in the model are presented in the figures and text.

## Authors response

Nearly all requests by the CPT were fulfilled and described below. Model scenarios include all CPT recommended models, save 1. Estimating a constant of proportionality between fishing effort in the pot fishery and fishing mortality in the trawl fishery was not performed because this is a stepbackwards from estimating a vector of deviations. 'Jittering' was not performed because the management advice produced from this assessment is Bayesian in nature--i.e. the estimated management quantities (e.g. MMB, B35%, OFL) are the medians of posterior distributions of these quantities. Consequently, 'jittering' would not influence the outcome of this assessment because it seeks to ensure the final maximum likelihood estimates of management quantities have converged to their most probable value. Finally, although functions to calculate Francis weights were included in the assessment, the prersented scenarios use only weight for survey composition data that are 20% of their previous values (i.e. 40 vs. 200).  During the application of the Francis weighting procedure, the algorithm lowered the weights beyond those presented here, but at the cost of a Hessian that was not positive definite.  Given the need for an invertible Hessian to perform MCMC, using weights at only 20% of the previously used values was a necessary compromise.

\newpage
# C. INTRODUCTION
## Distribution
Snow crab (Chionoecetes opilio) are distributed on the continental shelf of the Bering Sea, Chukchi Sea, and in the western Atlantic Ocean as far south as Maine.  In the Bering Sea, snow crab are distributed widely over the shelf and are common at depths less than about 200 meters (\autoref{femalemap} & \autoref{malemap} .  Juvenile crabs tend to occupy more inshore northern regions (\autoref({male78map}; up to about 63o N) and mature crabs deeper areas to the south of the juveniles (\autoref{male101ref}; Zheng et al. 2001). The eastern Bering Sea population within U.S. waters is managed as a single stock; however, the distribution of the population may extend into Russian waters to an unknown degree. 

## Life history characteristics
Below studies relevant to key population and fishery processes are presented to provide background for the model description presented in appendix A.

## Natural Mortality

Nevissi, et al. (1995) used radiometric techniques to estimate shell age from last molt.  The total sample size was 21 male crabs (a combination of Tanner and snow crab) from a collection of 105 male crabs from various hauls in the 1992 and 1993 NMFS Bering Sea survey.  Fishing mortality rates before and during the time period when these crab were collected were relatively high, and therefore maximum age would represent Z (total mortality) rather than M.  Representative samples for the 5 shell condition categories were collected that made up the 105 samples.  The oldest looking crab within shell conditions 4 and 5 were selected from the total sample of SC4 and SC5 crabs to radiometrically age (Orensanz, Univ. of Washington, pers comm.).  Shell condition 5 crab (SC5 = very, very old shell) had a maximum age of 6.85 years (s.d. 0.58, 95% CI approximately 5.69 to 8.01 years).  The average age of 6 crabs with SC4 (very old shell) and SC5, was 4.95 years.  The range of ages was 2.70 to 6.85 years for those same crabs.  Given the small sample size, this maximum age may not represent the 1.5% percentile of the population that is approximately equivalent to Hoenig’s method (1983).  Maximum life span defined for a virgin stock is reasonably expected to be longer than these observed maximum ages from exploited populations.  Radiometric ages estimated by Nevissi, et al. (1995) may be underestimated by several years, due to the continued exchange of material in crab shells even after shells have hardened (Craig Kastelle, pers. comm., Alaska Fisheries Science Center, Seattle, WA).  

Tag recovery evidence from eastern Canada reveal observed maximum ages in exploited populations of 17-19 years (Nevissi, et al. 1995, Sainte-Marie 2002).  A maximum time at large of 11 years for tag returns of terminally molted mature male snow crab in the North Atlantic has been recorded since tagging started about 1993 (Fonseca, et al. 2008).  Fonseca, et al. (2008) estimated a maximum age of 7.8 years post terminal molt using data on dactal wear.  

We reasoned that in a virgin population of snow crab, longevity would be at least 20 years.  Hence, we used 20 years as a proxy for longevity and assumed that this age would represent the 99th percentile of the distribution of ages in an unexploited population if observable.  Under negative exponential depletion, the 99th percentile corresponding to age 20 of an unexploited population corresponds to a natural mortality rate of 0.23.  Using Hoenig’s (1983) method an M=0.23 corresponds to a maximum age of 18 years.  M=0.23 was used for all female crab in the model.  Male natural mortality estimated in the model with a prior constraint of mean M=0.23 with a se = 0.054 estimated from using the 95% CI of  +-1.7 years on maximum age estimates from dactal wear and tag return analysis in Fonseca, et al. (2008).

### Weight to size relationship
Weight at length is calculated by a power function (see equation \autoref{dummyeq}).  Parameters were recalculated by the Kodiak lab in August 2016 and are specified here as INSERT CODE for juvenile females, INSERT CODE for mature females, and INSERT CODE for all males.  These parameter values changed from: a = 0.00000253 and b = 2.56472 (juvenile females), a = 0.000675 and b = 2.943352 (mature females), and a = 0.00000023 and b = 3.12948 (all males). New weight to size parameters were applied to all years of data, rather than just the most recent observations.  The net result was a slight decrease in the weight at size for males and increases in the size at weight for females.  To provide context for the change, a juvenile female crab of carapace width 52.5 mm was previously estimated to weigh 65 g and now 48 g; a mature female crab of carapce width 57.5 mm was estimated to previously weigh 102 g and now 67.7 g; and a male of carapace width 92.5 mm was previously estimated to weigh 450 g and now weighs 451 g.

## Maturity 
### Make a figure comparing observed and estimated maturity

How were data parsed into mature vs. immature?
How was maturity treated within the model? 

Maturity for both sexes is estimated within the model; the data that inform this process include the length frequencies for the survey, which are divided into mature and immature for each sex when fitting.  Maturity by sex by year can also be determined empirically using the survey data. Female maturity was determined by the shape of the abdomen, by the presence of brooded eggs, or egg remnants. Morphometric maturity for males is determined by chela height measurements, which are available starting from the 1989 survey (Otto 1998). Mature male biomass referenced throughout this document refers to a morphometrically mature male.  

One maturity curve for males was estimated using the average fraction mature based on chela height data and applied to all years of survey data to estimate mature survey numbers (Figure 48c).  The separation of mature and immature males by chela height at small widths may not be adequately refined given the current measurement to the nearest millimeter.  Chela height measured to the nearest tenth of a millimeter (by Canadian researchers on North Atlantic snow crab) shows a clear break in chela height at small and large widths and shows fewer mature animals at small widths than the Bering Sea data measured to the nearest millimeter.  Measurements taken in 2004-2005 on Bering Sea snow crab chela to the nearest tenth of a millimeter show a similar break in chela height to the Canadian data (Rugolo et al. 2005).  

The probability of a new shell crab maturing was estimated in the model at a smooth function to move crab from immature to mature (Figure 48).  The probability of maturing was estimated to match the observed fraction mature for all mature males and females observed in the survey data.  The probability of maturing by size for female crab was about 50% at about 48 mm and increased to 100% at 60mm (Figure 49).  The probability of maturing for male crab was about 15% to 20% at 60 mm to 90mm and increased sharply to 50% at about 98mm, and 100% at 108 mm.



## Molting probability

Bering Sea male snow crab appear to have a terminal molt to maturity based on data on hormone level data (Tamone et al. 2005) and findings from molt stage analysis via setagenesis.  The models presented here assume a terminal molt for both males and females. Many papers have dealt with the question of terminal molt for Atlantic Ocean mature male snow crab (e.g., Dawe, et al. 1991).  

Male snow crabs that do not molt (old shell) may be important in reproduction.  Paul et al. (1995) found that old shell mature male Tanner crab out-competed new shell crab of the same size in breeding in a laboratory study.  Recently molted males did not breed even with no competition and may not breed until after about 100 days from molting (Paul et al. 1995).  Sainte-Marie et al. (2002) states that only old shell males take part in mating for North Atlantic snow crab.  If molting precludes males from breeding for a three month period, then males that are new shell at the time of the survey (June to July), would have molted during the preceding spring (March to April), and would not have participated in mating.  The fishery targets new shell males, resulting in those animals that molted to maturity and to a size acceptable to the fishery of being removed from the population before the chance to mate.  Animals that molt to maturity at a size smaller than what is acceptable to the fishery may be subjected to fishery mortality from being caught and discarded before they have a chance to mate.  However, new shell males will be a mixture of crab less than 1 year from terminal molt and 1+ years from terminal molt due to the inaccuracy of shell condition as a measure of shell age.

Crabs in their first few years of life may molt more than once per year, however, the smallest crabs included in the model are approximately 3 to 4 years old and would be expected to molt annually. The growth transition matrix was applied to animals that grow, resulting in new shell animals.  Those animals that don’t molt become old shell animals.  Animals that are classified as new shell in the survey are assumed to have molted during the last year.  The assumption is that shell condition (new and old) is an accurate measure of whether animals have molted during the previous year.  The relationship between shell condition and time from last molt needs to be investigated further.  

## Mating ratio and reproductive success

Full clutches of unfertilized eggs may be extruded and appear normal to visual examination, and may be retained for several weeks or months by snow crab.  Resorption of eggs may occur if not all eggs are extruded resulting in less than a full clutch.  Female snow crab at the time of the survey may have a full clutch of eggs that are unfertilized, resulting in overestimation of reproductive potential.  Male snow crab are sperm conservers, using less than 4% of their sperm at each mating.  Females also will mate with more than one male.  The amount of stored sperm and clutch fullness varies with sex ratio (Sainte-Marie 2002).  If mating with only one male is inadequate to fertilize a full clutch, then females will need to mate with more than one male, necessitating a sex ratio closer to 1:1 in the mature population, than if one male is assumed to be able to adequately fertilize multiple females.

The fraction barren females and clutch fullness observed in the survey increased in the early 1990s then decreased in the mid- 1990s then increased again in the late 1990s (Figures 49 and 50).  The highest levels of barren females coincides with the peaks in catch and exploitation rates that occurred in 1992 and 1993 fishery seasons and the 1998 and 1999 fishery seasons.  While the biomass of mature females was high in the early 1990s, the rate of production from the stock may have been reduced due to the spatial distribution of the catch and the resulting sex ratio in areas of highest reproductive potential.   

Laboratory analysis determined that female snow crab collected in waters colder than 1.5 o C from the Bering Sea were biennial spawners (REFERENCE).  Future recruitment may be affected by the fraction of biennial spawning females in the population as well as the estimated fecundity of females, which may depend on water temperature. 

An index of reproductive potential for crab stocks needs to be defined that includes spawning biomass, fecundity, fertilization rates and frequency of spawning.  In most animals, spawning biomass is a sufficient index of reproductive potential because it addresses size related impacts on fecundity, and because the fertilization rates and frequency of spawning are relatively constant over time.  This is not necessarily the case for snow crab.

(Cold pool?)

The clutch fullness and fraction of unmated females however, may not account for the fraction of females that may have unfertilized eggs, since these cannot be detected by the naked eye at the time of the survey.   The fraction of barren females observed in the survey may not be an accurate measure of fertilization success because females may retain unfertilized eggs for months after extrusion.  To examine this hypothesis, RACE personnel sampled mature females from the Bering Sea in winter and held them in tanks until their eggs hatched in March of the same year (Rugolo et al. 2005).  All females then extruded a new clutch of eggs in the absence of males.  All eggs were retained until the crabs were sacrificed near the end of August.  Approximately 20% of the females had full clutches of unfertilized eggs.  The unfertilized eggs could not be distinguished from fertilized eggs by visual inspection at the time they were sacrificed.  Indices of fertilized females based on the visual inspection method of assessing clutch fullness and percent unmated females may overestimate fertilized females and not an accurate index of reproductive success.    

McMullen and Yoshihara (1969) examined female red king crab around Kodiak Island in 1968 and found high percentages of females without eggs in areas of most intense fishing (up to 72%).  Females that did not extrude eggs and mate were found to resorb their eggs in the ovaries over a period of several months.  One trawl haul captured 651 post-molt females and nine male red king crab during the period April to May 1968.  Seventy-six percent of the 651 females were not carrying eggs.  Ten females were collected that were carrying eggs and had firm post-molt shells.  The eggs were sampled 8 and 10 days after capture and were examined microscopically.  All eggs examined were found to be infertile.  This indicates that all ten females had extruded and held egg clutches without mating.   Eggs of females sampled in October of 1968 appear to have been all fertile from a table of results in McMullen and Yoshihara(1969), however the results are not discussed in the text, so this is unclear.  This may mean that extruded eggs that are unfertilized are lost between May and October.      

## Growth

Little information exists on growth for Bering Sea snow crab. Tagging experiments were conducted on snow crab in 1980 with recoveries occurring in the Tanner crab (Chionoecetes bairdi) fishery in 1980 to 1982 (Mcbride 1982).  However, data from the McBride study was not used due to uncertainty about the effect of tagging on growth. Currently, 40 data points from 5 studies are used to estimate the post-molt length from pre-molt length for females and males, several of which were used in Somerton's 2013 study on growth.  The studies include:

1.  Transit study (Rugolo unpublished data, 2003); 14 crab
2.	Cooperative seasonality study (Rugolo); 6 crab
3.	Dutch harbor holding study; 9 crab
4.	NMFS Kodiak holding study held less than 30 days;  6 crab
5.  NMFS Kodiak holding study 2016; 5 crab

In the "Transit study", pre- and post-molt measurements of 14 male crabs hat molted soon after being captured were collected.  The crabs were measured when shells were still soft because all died after molting, so measurements are probably underestimates of postmolt width (Rugolo, pers. com.).  The holding studies include only data for crab held less than 30 days because growth of crabs held until the next spring's molting was much lower. Females molting to maturity were excluded from all data sets, since the molt increment is usually smaller.  Crab missing more than two limbs were excluded due to other studies showing lower growth.  Crab from Rugolo’s seasonal study were excluded that were measured less than 3 days after molting due to difficulty in measuring soft crab accurately. In general, growth of snow crab in the Bering Sea appears to be greater than growth of some North Atlantic snow crab stocks (Sainte-Marie 1995).   


## Management history

## ADFG harvest strategy
Parameters for stocks with an approved harvest strategy should be provided in tables in both t and lbs.

## History of BMSY

## Fishery history

Snow crab were harvested in the Bering Sea by the Japanese from the 1960s until 1980 when the Magnuson Act prohibited foreign fishing.  Retained catch in the domestic fishery increased in the late 1980s to a high of about 149,110 t in 1991, declined to 29,820 t in 1996, increased to 110,410 t in 1998 then declined to 15,200 t in the 1999/2000 fishery (Table 1, Figure 1).  Due to low abundance and a reduced harvest rate, retained catches from 2000/01 to 2006/07 ranged from a low of about 10,860 t to 16,780 t.  In the 2014/15 fishery retained catch was 30,820 t and total catch was estimated at 34,300 t (0.30 mortality for pot fishery discard and 0.80 mortality for groundfish discard).  Total catch in the 2013/14 fishery was 27,700 t.
 
Discard from the directed pot fishery was estimated from observer data since 1992 and ranged from 11% to 64% (average 33%) of the retained catch of male crab biomass (Table 1).  Discard of male crab in the directed fishery increased in the last two years to 44% (2013/14) and 38% (2014/15) of the retained catch (no mortality applied).  Female discard catch is very low compared to male discard catch and not a significant source of mortality.  In 1991/92 trawl discard was about 1,950 t (no mortality applied), increased to about 3,550 t in 1994/95, then declined and ranged between 900 t and 1,500 t until 1998/99.  Trawl bycatch in 2012/13 and 2013/14 was 220 t and 120 t respectively.  Discard of snow crab in groundfish fisheries from highest to lowest is the yellowfin sole trawl fishery, flathead sole trawl fishery, Pacific cod bottom trawl fishery, rock sole trawl fishery, and the Pacific cod hook-and-line and pot fisheries.

Size frequency data and catch per pot have been collected by observers on snow crab fishery vessels since 1992.  Observer coverage has been 10% on catcher vessels larger than 125 ft (since 2001), and 100% coverage on catcher processors (since 1992). 

The average size of retained crabs has remained fairly constant over time ranging between 105 mm and 118 mm Carapace Width (CW), and most recently about 110 mm to 111 mm CW.  The percent new shell animals in the catch has varied between 69% (2002 fishery) to 98% (1999), and was 87% for the 2005/6 fishery and 93% in the 2007/8 fishery.  In the 2007/8 fishery 94% of the new shell males >101mm CW were retained, while 78% of the old shell males >101mm CW were retained.  Only 3% of crab were retained between 78mm and 101 mm CW.  The average weight of retained crab has varied between 0.5 kg (1983-1984) and 0.73 kg (1979), and 0.59 kg in the recent fisheries.

Several modifications to pot gear have been introduced to reduce bycatch mortality.  In the 1978/79 season, pots used in the snow crab fishery first contained escape panels to prevent ghost fishing.  Escape panels consisted of an opening with one-half the perimeter of the tunnel eye laced with untreated cotton twine.  The size of the cotton laced panel to prevent ghost fishing was increased in 1991 to at least 18 inches in length.  No escape mechanisms for undersized crab were required until the 1997 season when at least one-third of one vertical surface had to contain not less than 5 inches stretched mesh webbing or have no less than four circular rings of no less than 3 3/4 inches inside diameter.  In the 2001 season the escapement for undersize crab was increased to at least eight escape rings of no less than 4 inches placed within one mesh measurement from the bottom of the pot, with four escape rings on each side of the two sides of a four-sided pot, or one-half of one side of the pot must have a side panel composed of not less than 5 1/4 inch stretched mesh webbing.  

## Harvest rates

The harvest rate used to set the Guideline Harvest Level (GHL) of retained crab only previous to 2000 was 58% of the number of male crab over 101 mm CW estimated from the survey.  The minimum legal size limit for snow crab is 78 mm, however, the snow crab market generally accepts animals greater than 101 mm.  In 2000, due to the decline in abundance and the declaration of the stock as overfished, the harvest rate for calculation of the GHL was reduced to 20% of male crab over 101 mm.  After 2000, a rebuilding strategy was developed based on simulations by Zheng (2002).

The realized retained catch typically exceeded the GHL historically, resulting in exploitation rates for the retained catch on males >101mm ranging from about 10% to 80%  (Figure 2).  The exploitation rate for total catch divided by mature male biomass ranged from  6% to 46% and was estimated at 21% in 2014/15 (Table 6 and Figure 2).
 
Prior to adoption of Amendment 24, BMSY (921.6 million lbs (418,150 t)) was defined as the average total mature biomass (males and females) estimated from the survey for the years 1983 to 1997 (NPFMC 1998).  MSST was defined as 50% of the BMSY value (MSST=460 million lbs of total mature biomass (209,074 t)).  The harvest strategy since 2000/01 used a retained crab harvest rate on the mature male biomass of 0.10 on levels of total mature biomass greater than ½ MSST (230 million lbs), increasing linearly to 0.225 when biomass is equal to or greater than BMSY (921.6 million lbs) (Zheng et al. 2002).  The GHL was actually set as the number of retained crab allowed in the harvest, calculated by dividing the GHL in lbs by the average weight of a male crab > 101 mm.  If the GHL in numbers was greater than 58% of the estimated number of new shell crabs greater than 101 mm plus 25% of the old shell crab greater than 101 mm, the GHL is capped at 58%.  If natural mortality is 0.2, then this actually results in a realized exploitation rate cap for the retained catch of 66% at the time of the fishery, occurring approximately 7 months after the survey (if survey Q=1).  The fishing mortality rate that results from this harvest strategy depends on the relationship between mature male numbers less than 101 mm compared to greater than 101 mm.  

# D. DATA 

## New Data

HOW EXACTLY WERE DATA PULLED FROM AKFIN??

## Catch data

Catch data and size frequencies of retained crab from the directed snow crab pot fishery from 1978/79 to the `r SurveyYrs[SurvYrN-1]` season were used in this analysis.  Observers were placed on directed crab fishery vessels starting in 1990.  Size frequency data on the total catch (retained plus discarded) in the directed crab fishery were available from 1992/93 to `r SurveyYrs[SurvYrN-1]`.   Total discarded catch was estimated from observer data from 1992 to `r SurveyYrs[SurvYrN-1]` (Table 1).  The discarded male catch was estimated for 1978 to 1991 in the model using the estimated fishery selectivities based on the observer data for the period 1992 to `r SurveyYrs[SurvYrN-1]`.  The discard catch estimate was multiplied by the assumed mortality of discards from the pot fishery.  The mortality of discarded crab was 30% for all model scenarios.  This estimate differs from the current rebuilding harvest strategy used since 2001 to the present by ADFG to set the TAC, which assumes a discard mortality of 25% (Zheng, et al. 2002).  The discards prior to 1992 may be underestimated due to the lack of escape mechanisms for undersized crab in the pots before 1997.


The following table contains the various data components used in the model,

```{r,echo=FALSE,warning=FALSE,message=F}
Data<-c("Retained male crab pot fishery size frequency by shell condition",
         "Discarded Males and female crab pot fishery size frequencey",
         "Trawl fishery bycatch size frequencies by sex",
         "Survey size frequencies by sex and shell condition",
        "Retained catch estimates",
        "Discard catch estimates from crab pot fishery",
        "Trawl bycatch estimates",
        "Total survey biomass estimates and coefficients of variation",
        "2009 study area biomass estimates, CVs, and size frequencey for BSFRF and NMFS tows",
        "2010 study area biomass estimates, CVs, and size frequencey for BSFRF and NMFS tows"
         )
DataYears<-c(paste("1978/79 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1992/93 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1991/92 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1978 - ",SurveyYrs[SurvYrN],sep=""),
             paste("1978/79 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1992/93 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1973 - ",SurveyYrs[SurvYrN-1],sep=""),
             paste("1978 - ",SurveyYrs[SurvYrN],sep=""),
             "2009",
             "2010")

PlotTab<- data.frame(Data,DataYears)
colnames(PlotTab)<- c("Data component","Years")
rownames(PlotTab)<- NULL
kable(PlotTab)

```

## Survey biomass

Abundance is estimated from the annual eastern Bering Sea (EBS) bottom trawl survey conducted by NMFS (see Rugolo et al. 2003 for design and methods).  Since 1989, the survey has sampled stations farther north than previous years (61.2o N previous to 1989).  In 1982 the survey net was changed resulting in a potential change in catchability.  Consequently, survey selectivity is modeled in three 'eras' in the assessment. All survey data in this assessment use measured net widths instead of the fixed 50 ft net width based on Chilton et al.'s (2009) new survey estimates based on measured net width. 

A 'mature' male snow crab in this assessment means 'morphometrically' mature, i.e. indicated by a marked change in chelae size, after which males are assumed to be effective at mating.  Males are functionally mature at smaller sizes than when they become morphometrically mature, although the contribution of these “small-clawed” males to annual reproductive output is thought to be negligible.  The minimum legal size limit for the snow crab fishery is 78 mm, however the size for males that are generally accepted by the fishery is >101mm.  Historical quotas were based on the survey abundance of large males (>101mm).  

HOW IS HTE SURVEY BIOMASS CALCULATED?
survey numbers are fed to the model. they are broken out based on the size composititions
DESCRIBE PRECISELY WHERE THE DATA WERE TAKEN FROM. LESS ABOUT WHAT THEY 'MEAN'.


## Survey size composition

REFERENCE  FIGURES
HOW ARE THE DATA SPLIT
 females new old mature immature: new shel is anything <2; mature is anything with eggs
 males new shell is anything <2; mature is based on the probability of being mature given a size

Carapace width and shell conditions are measured for snow crab caught in the survey. Radiometric aging of shells from terminal molt male crabs (after the last molt of their lifetime) elucidated the relationship between shell condition and presumptive age, which will be discussed in a later section (Nevissi et al. 1995). 

The 2015 survey length composition data indicate a possible large recruitment to the model in 2015 (2010 lag 5 years to fertilization year).

## Spatial distribution of catch and survey abundance

The majority of the fishery catch occurs south of 58.5o N., even in years when ice cover did not restrict the fishery moving farther north.  In past years, most of the fishery catch occurred in the southern portion of the snow crab range possibly due to ice cover and proximity to port and practical constraints of meeting delivery schedules.  The majority of catch is west and north of the Pribilof Islands.  The majority of catch in 2014/15 has shifted to east of the Pribilof Islands (Figure 11).

CPUE of survey catch by tow for 2014 to 2015 are shown in Figures 12 through 25.  Immature female and small male (<78mm) distributions in 2014 and 2015 were farther south than in previous years with higher tows just north of the Pribilof Islands (Figures 12, 15, 20 and 22).  Legal males (>77mm) and large males (>101mm) are distributed farther south and east of the Pribilof Islands than in previous years (Figures 13, 14, 19, and 21).  Mature females with less than or equal to half clutch of eggs were mostly in the northern part of the survey area above 58 o N (Figures 18 and 24). 

The difference between the summer survey distribution of large males and the fishery catch distribution indicates that survey catchability may be less than 1.0 and/or some movement occurs between the summer survey and the winter fishery.  However, the exploitation rate on males south of 58.5o N latitude may exceed the target rate, possibly resulting in localized depletion of males from the southern part of their range.  Snow crab larvae probably drift north and east after hatching in spring.  Snow crab appear to move south and west as they age, however, no tagging studies have been conducted to fully characterize the ontogenetic or annual migration patterns of this stock(Murphy et al. 2010).  High exploitation rates in the southern area may have resulted in a northward shift in snow crab distribution.  The last few years of survey data indicate a shift to the south in distribution of snow crab, which reverses the trends seen in early 2000s.

Ernst, et al. (2005) found the centroids of survey summer distributions have moved to the north over time (Figures 26 and 27).  In the early 1980’s the centroids of mature female distribution were near 58.5 o N, in the 1990s the centroids were about 59.5 o N.  The centroids of old shell male distribution was south of 58 o N in the early 1980s, moved north in the late 1980s and early 1990s then shifted back to the south in the late 1990s.  The distribution of males>101 mm was about at 58 o N in the early 1980s, then was farther north (58.5 to 59 o N) in the late 1980s and early 1990s, went back south in 1996 and 1997 then has moved north with the centroid of the distribution in 2001 just north of 59 o N..  The centroids of the catch are generally south of 58 o N, except in 1987.  The centroids of catch also moved north in the late 1980s and most of the 1990s.  The centroids of the catch were about at 56.5 o N in 1997 and 1998, then moved north to above 58.5 o in 2002.

## 2009 and 2010 Study Area Data Additional survey data 

Bering Sea Fisheries Research Foundation (BSFRF) conducted a survey of 108 tows in 27 survey stations (10,827 nm2, hereafter referred to as the “study area”) in the Bering Sea in summer 2009 (Figure 28, see Somerton et al 2010 for more details).  The abundance estimated by the BSFRF survey in the study area was 66.9 million male crab >=100 mm compared to 36.7 million for the NMFS tows (Table 4).  The NMFS abundance of females >=50mm (121.5 million) was greater than the BSFRF abundance estimate in the study area (113.6 million) (Table 4).

The abundance of male crab in the entire Bering Sea survey for 2009 was greatest in the 30 – 60mm size range (Figures 29 and 30).  The abundance of crab in the 35 to 60mm size range for the BSFRF net in the study area was very low compared to the abundance of the same size range for the NMFS entire Bering Sea survey.  The differences in abundance by size for the NMFS entire Bering Sea survey and the BSFRF study area were due to availability of crab in the study area as well as capture probability.   While the abundance of larger male crab for the NMFS net in the study area is less than for the BSFRF, the abundance of females >45 mm is greater for the NMFS net than the BSFRF (Figure 29).  This difference may be due to different towing locations for the two nets within the study area, or to higher catchability of females possibly due to aggregation behavior.  The ratio of abundance of the NMFS net and BSFRF net in the study area are quite different for males and females (Figure 31).  The ratio of abundance indicates a catchability for mature females (mainly 45 – 65 mm) that is greater than 1.0 for the NMFS net.

The largest tows for small (<78mm) male crab in the entire Bering Sea area were north of the study area near St. Matthew Island (Figure 12 and 20).  Some higher tows for large males (>=100mm) and for mature females occurred in the study area as well as outside the study areas (Figures 5-18 and 22-24).  These distributions indicate that availability of crab of different sizes and sex varies spatial throughout the Bering Sea. The numbers by length and mature biomass by sex for the BSFRF tows and the NMFS tows within the study area were added to the model as an additional survey.

The 2009 estimated snow crab abundance by length in the study area had very low numbers of both male and female crab in the 35 mm to 70 mm range than observed in the Bering sea wide survey(Figures 29 and 30).   The ratio of abundance (NMFS/BSFRF) by length for 2009 was 0.2 at about 45 mm increasing gradually to 0.4 at 95mm then increasing steeply to 0.9 to 1.25 above 115 mm (Figure 31).  The mean size of crab retained by the fishery is about 110 mm, with minimum size retained about 102mm.  Ratios of abundance for female crab were above 1.0 from 45mm to 60mm then declined to 0.5 to 0.8 above 60mm to 80mm.  There were very few female crab above 80mm in the population.  

The 2010 study area covered a larger portion of the distribution of snow crab than the 2009 study area.  The abundance by length for the 2010 study area is very different from the 2009 data, with higher abundance in 2010 of small crab (Figure 32).  The expanded estimate (expanded to the study area) of male abundance from BSFRF data is higher than the Bering Sea wide abundance for length from 50mm to about 110mm. Female abundance shows a similar relationship (Figure 33).  The ratio of male abundance by length (NMFS/BSFRF) in 2010 increased to 0.6 at 40mm then decreased to about 0.2 at 65-70mm then increased and ranged between 0.3 and 0.4 up to about 112mm (Figure 34).  The ratios increased from 0.4 at 112 to about 0.7 at 122mm then to 1.55 at 132mm.  The ratio of female abundance by length in 2010 was 0.6 at about 45mm and declined to 0.4 at about 67mm then declined below 0.1 above about 77mm. 

Several processes influence net performance.  Somerton et al. (2010) accounted for area swept, sediment type, depth and crab size.  However, they did not correct for the probability of encountering crab.  The 2010 study area data have a number of paired tows where BSFRF caught no crab (within a particular size bin) or where NMFS caught no crab.   This creates problems with simply taking the ratio of catches since a number of ratios will be infinity (dividing by 0).  This occurs because the paired tows although near in space were not fishing on the same density of crab.  In addition, the BSFRF tow covered about 10% of the area of the NMFS tow, due to the narrower net width and the 5 minute tow duration compared to the 30 minute NMFS tow duration.   To analyze these data, first the ratio of the “NMFS density” (numbers per nm2) to the “sum of the density” of NMFS and BSFRF were calculated (Figure 35 males and Figure 38 females).  These values range from 0 to 1.0. The simple mean of these values was estimated by length bin and then transformed to estimate mean catchability by length bin (Figure 39 males Figure 40 females).  A value of 0.5 for the ratio of the “NMFS density” to the “sum of density” is equivalent to a catchability of 1.0, and a value of the ratio of 0.33 is equivalent to a catchability of 0.5. The size of the catch for each observation is plotted in Figure 36 (same data as Figure 35).  

The BSFRF study provides a rich data set to evaluate net performance.  In this survey the sample is the paired tows and the goal would be to evaluate net performance over a wide range of densities, sediment types and depths.  Somerton et al. (February 2011 Modeling Workshop) used catch to weight observations for estimation of the selectivity curve.  This assumes that trawl performance is influenced by local density of crab (an untested assumption).  No weighting of the observations assumes that there is no relationship between catch and the selectivity of crab.  If selectivity changes depending on whether catches are high or low, then further study and analysis is needed.  Further analysis needs to be done on whether data should be weighted in the initial estimation of the selectivity curve. The unweighted mean values by length bin are higher than the values estimated by Somerton et al..  Somerton weights again by survey abundance and adjusts for depth and sediment type in a separate step in the analysis to estimate a Bering Sea wide survey selectivity.  Simulation studies are needed to determine the influence of weighting (whether bias is introduced) and whether the distributional assumptions and likelihood equations used in the analysis of the paired tow data are correct and unbiased. 

The overall distribution of the ratio of “NMFS density” to the “sum of the densities” is skewed with about 140 - 0.0 values and 110 - 1.0 values (Figure 41).  The percentage of observations where NMFS caught crab and no crab were caught by the BSFRF tow increases by size bin for male crab (Figures 41 through 46).

Catches of male crab decrease with size simply because they are lower in abundance in the population.  At sizes of male crab greater than about 90 mm the fraction of observations where the ratio of NMFS density to the sum of densities was 1.0 and 1 crab was caught in the net was about 10% to 30%.  In other, words the majority of the tows involved more than 1 crab caught.

The mean values of the ratio of NMFS density to the sum of densities for female crab transformed to catchability increase from less than 0.1 at 25mm to about 0.5 at 55mm then decrease slightly above 70mm (Figures 38 and 40).  

## Selectivity

# E. ANALYTIC APPROACH

## History of modeling approaches for the stock

Catch trends historically followed survey abundance estimates of large males, as the survey estimates were the basis for calculating the Guideline Harvest Level (GHL ) for retained catch.  The TAC is currently set (starting in 2009) by Alaska Department of Fish and Game (ADFG) using the ADFG harvest strategy.  Retained catches increased from about 3,040 t at the beginning of the directed fishery in 1973 to a peak of 149,110 t in 1991, declined thereafter, then increased to another peak of 110,410 t in 1998.  Retained catch in the 1999/2000 fishery was reduced to 15,200 t due to the low abundance estimated by the 1999 survey.  A harvest strategy (Zheng et al. 2002) was developed using an earlier generation simulation model that pre-dated the current stock assessment model.  This early generation model has been used to set the GHL (TAC since 2009) since the 2000/01 fishery.  Retained catch in the 2014/15 fishery increased to 30,820 t from the 2013/14 fishery retained catch of 24,480 t.  The total catch in the 2014/15 fishery was estimated at 34,300 t (30% mortality on directed discards) and was well below the OFL of 69,000 t.  Discard in the directed fishery was 11,700 t (no mortality applied) in 2014/15, similar to the 10,880 t (no mortality applied) in 2013/14.

Estimated discard mortality (mostly undersized males and old shell males) in the directed pot fishery has averaged about 31% (no mortality applied) of the retained catch biomass since 1992 when observers were first placed on crab vessels.  Discards prior to 1992 were estimated based on fishery selectivities estimated for the period with observer data and the full selection fishing mortality estimated using the retained catch and retained fishery selectivities. 

## Model description

The model structure was developed following Fournier and Archibald’s (1982) methods, with many similarities to Methot (1990).  The model was implemented using automatic differentiation software developed as a set of libraries under C++ (ADModel Builder).  ADModel Builder can estimate a large number of parameters in a non-linear model using automatic differentiation software extended from Greiwank and Corliss (1991) and developed into C++ class libraries.  This software provides the derivative calculations needed for finding the objective function via a quasi-Newton function minimization routine (e.g., Press et al. 1992).   The model implementation language (ADModel Builder) gives simple and rapid access to these routines and provides the ability to estimate the variance-covariance matrix for all parameters of interest. See appendix A for a complete description of the population dynamics and projection framework.


## Model selection and evaluation
List the scenarios that are considered
This should include the model from the previous year as the 'base' model and then whatever other runs were requested after that.


## Results

### `r ScenarioNames[1]`
Mature male biomass for the `r ScenarioNames[1]` ranged from an estimated high of `r round(max(snowad.rep[[1]]$"Mature male biomass at mating"))` t in `r SurveyYrs[which(snowad.rep[[1]]$"Mature male biomass at mating" == max(snowad.rep[[1]]$"Mature male biomass at mating"))]` to a low of `r round(min(snowad.rep[[1]]$"Mature male biomass at mating"[1:SurvYrN]))` t in `r SurveyYrs[which(snowad.rep[[1]]$"Mature male biomass at mating" == min(snowad.rep[[1]]$"Mature male biomass at mating"[1:SurvYrN]))]`.  Mature female biomass ranged from an estimated high of `r round(max(snowad.rep[[1]]$"Mating time Female Spawning Biomass"))` t in `r SurveyYrs[which(snowad.rep[[1]]$"Mating time Female Spawning Biomass"==max(snowad.rep[[1]]$"Mating time Female Spawning Biomass"))]` to a low of `r round(min(snowad.rep[[1]]$"Mating time Female Spawning Biomass"[1:SurvYrN]))` t in `r SurveyYrs[which(snowad.rep[[1]]$"Mating time Female Spawning Biomass"== min(snowad.rep[[1]]$"Mating time Female Spawning Biomass"[1:SurvYrN]))]`.


Say something about fits?

MMB (high, low)
FMB (high, low)
Estimates of natural mortality, selectivity in all fisheries, recruitment, 


### Model 2

### Model 3

Write the code such that each scenario has it's own section
Does everyone get its own MCMC?
Then there is a section that compares them all at the end.
Or is there a 'base' model to which all of the others are compared?

### Winner winner chicken dinner

# F. Calculation of the OFL

# G. Calculation of the ABC

The acceptable biological catch (ABC) is calculated as the 49th quantile of the posterior distribution of the overfishing level (OFL). The OFL is calculated using proxies for biomass and fishing mortality reference points and a sloped control rule.  The distribution of the OFL is calculated via MCMC.  Proxies for biomass and fishing mortality reference points were calculated using spawner-per-recruit methods (e.g. Clark, 1991). After fitting the assessment model to the data and estimating population parameterse, the model was projected forward 100 years using the estimated parameters under no directed exploitation (bycatch exploitation was set to the average value) to determine 'virgin' mature male biomass per recruit.  Projections were repeated in which the bisection method was used to identify a fishing mortality that reduced the mature male biomass per recruit to 35% of the virgin level (i.e. F~35%~ and B~35%~).

Calculated values of F~35%~ and B~35%~ were used in conjunction with a control rule to adjust the proportion of F~35%~ that is applied based on the status of the population relative to B~35%~ (Amendment 24, NMFS).

\begin{equation}
 F_{OFL} =
 \begin{cases}
 Bycatch  & if \frac{MMB}{MMB_{35}} \leq \Omega \\[3ex]
 \frac {F_{35} ( \frac {MMB}{MMB_{35}} - \alpha}){1-\alpha}  & if \Omega < \frac {MMB}{MMB_{35}} < 1 \\[3ex]
 F_{35} & if MMB > MMB_{35}
\end{cases}
\end{equation}

Where MMB is the estimated current mature male biomaiss, MMB~*35%*~ is the mature male biomass at the time of mating resulting from fishign at F~*35%*, F~*35%*~ is the fishing mortality that reduces the mature male biomass per recruit to 35% of unfished levels, $\Omega$ is the fraction of MMB~*35%*~ below which directed fishing mortlaity is zero (here this is set to 0.25), and $\alpha$ determins the slop of the descneding limb of the harvest control rule (set to 0.05 here).

# H. Data gaps and research priorities
Incorporate weight at length data into the analysis
Standardize the .DAT file creation from files in AKFIN
Model fisheries for bycatch in the pot fishery and hook and line fishery as well (pot fishery was 25% of bycatch this year)
Think hard about what should be fit--total retained catch looks good, but when you look at the fits by shell condition, a lot of the catch is old shell in some years.
Better characterization of the CVs of everything (survey biomass in particular)
Use the 200 weights of the most uptodate model this year. Next year change the way that selectivity is estimated.

Is the retrospective bias caused by the way catch is taken out?
F happens over the whole year in the updating of the dynamics, but, it is calculated on a fraction of the population in the get catch at age function.

When doing it the way that it is currently done, the model just picks any shape it needs to match the survey selectivity.
This doesn't really inform selectivity well.

What's the point of the q in the BSFRF 'availability'? Should be taken out.

Revisit the weighting.
Several catches have the same 'sd', but are different magnitudes.
For example, the length comps have both 'weights' and 'sample sizes'. Just the sample sizes should be adjusted.
Priors: having a 'weight' and a 'variance' doesn't make any sense

Why does the two piece growth function only have one intercept for each sex, but two slopes?

Make the bounds for parameters read in in a CTL fiel

FIX IT SO RINPUT IS NOT OVERWRITTEN WITH EVALUATING THE CSV. CAN JUST RENAME IT AFTER RUNNING FOR NOW, BUT THAT IS DUMB.

Large claw male vs small claw male differences in weight at length

There is something wrong with the BSFRF data--the proportions are identical in one of the years for bothmature and immature (see EmpiricSurvDat.csv)

The pattern in the changes in survey q do not make sense to me.  There was less coverage in the early years, but the q is higher.  Survey qs should be nested--one should be estimated from 0-1, the rest should be estimated as that estimated parameter times an adjustment factor that ranges from 0-1. The one that all others are based off of should be the era that has the most coverage in the survey.

Should get the maturity data in there as priors on maturity--the model wants to mess with maturity to fit the index and that screws up the reference points.

# I. Ecosystem Considerations

# J. Literature cited



\newpage
# APPENDIX A: MODEL STRUCTURE

NEEDS:
 * List all of hte parameters esetimaed outside of the assessment and how they were estimated
 * List all of hte eparameters estimated conditionally on those above and indicate bounds and priors
 * List any constraints iposed on estimated parameters
 * Justify including fewere years for average recruitment
 * Define model outputs
    + biomass measures
    + recruitment
    + fishing mortality (exploitation rate vs instantaneous)
    The model estimates the abundance by length bin and sex in the first year (1978) as parameters rather than estimating the recruitments previous to 1978.  This results in 44 estimated parameters.   

List assumed time of fishery, survey, etc.
  
## Population dynamics  
    
The snow crab population dynamics model tracks the number of crab of sex *s*, shell condition *v*, maturity state *m*, in year *y* at length *l*, N~*s,v,m,y,l*~. A terminal molt occurs in which crab move from immature to mature, and then do not molt again. The mid-points of the size bins tracked in the model span from 27.5 to 132.5mm carapace width, with 5 mm size classes. For the base assessment, 331 parameters are estimated. Numbers of a given sex *s* of shell condition *v* and maturity state *m* at length *l* in the initial year of the assessment, N~*s,v,m,y=1,l*}, are calculated from an estimated vector of numbers at length *l* by sex *s* and shell condition *v*, $\lambda_{s,v,l}$. THERE ARE STRONG PRIORS ON A FEW THINGS HERE e.g. immmature old shell.
 
\begin{equation} N_{s,v,m,y=1,l} = 
  \begin{cases}
  \Omega_{s,l} \lambda_{s,v,l} & \text{if v = new; m = mat} \\
  1-\Omega_{s,l} \lambda_{s,v,l} & \text{if v = new; m = imat} \\
  \lambda_{s,v,l} & \text{if v = old; m = mat} \\
  0 & \text{if v = old; m = imat} 
  \end{cases}
  \end{equation}

The dynamics after the initial year are described by:

  \begin{equation} N_{s,v,m,y+1,l} = 
  \begin{cases}
  \Omega_{s,l}  \kappa_{s,l'} Q_{s,imat,y,l'} X_{s,l',l} & \text{if v = new; m = mat} \\[2ex] 
  1-\Omega_{s,l} \kappa_{s,l'} Q_{s,imat,y,l'} X_{s,l',l} + Rec^\epsilon_y Pr_{l} & \text{if v = new; m = imat} \\[2ex]
  Q_{s,mat,y,l'} & \text{if v = old; m = mat} \\[2ex]
  (1-\kappa_{s,l'}) Q_{s,imat,y,l'} & \text{if v = old; m = imat} 
  \end{cases}
  \end{equation}

Where $\Omega_{s,l}$ is the probability of maturing at length *l* for sex *s* (a freely estimated vector for both males and females constrained by penalties on smoothness), $\kappa_{s,l'}$ is the probability of molting for an immature crab of sex *s* at length *l'* (set to 1 for),  and X~*s,l,l'*~ is the size transition matrix describing the probability of transitioning from size *l'* to size *l* for sex *s*. Q~*s,m,y,l'*~ is the number of crab of sex *s*, maturity state *m*, and length *l'* surviving natural and fishing mortality during year *y*:

 \begin{equation}
  Q_{s,m,y,l} = \sum_v N_{s,v,m,y,l}e^{Z_{s,v,m,y,l}} 
 \end{equation}
 
 Where N~*s,v,m,y,l*~ represents the numbers, *N*, of sex *s* during year *y* of shell condition *v* and maturity state *m* at length *l*. Z~*x,v,m,y,l*~ represents the total mortality experienced by the population and consists of the sum of instantaneous rates of natural mortality by sex and maturity state, M~*s,m*~, and fishing mortality, F~*s,f,y,l*~ from each fishery. Each fishing mortality is subject to seletivity by length *l*, which varies between sexes *s* and fisheries *f* (and by year *y* if specified) . M~*s,m*~ is specified in the model and a multiplier $\gamma_{natM,m}$ is estimated subject to constraints (see table X; this formulation effectively specifies a mean and standard deviation for a prior distribution for M).
 
 \begin{equation} Z_{s,v,m,y,l} = \gamma_{natM,m} M_{s,m} + \sum_f S_{s,f,y,l} F_{s,f,y,l} \end{equation}
 
Selectivities in the directed and bycatch fisheries are estimated logistic functions of size.  Different selectivities are estimated for females and males in the directed fisheries (S~*fem,dir,l*~ and S~*male,dir,l*~, respectively), a single selectivity for both sexes is estimated for bycatch in the groundfish trawl fishery (S~*trawl,l*~), and a retention selectivity is estimated for the directed fishery for males (R~*dir,l*~; all females are discarded).
 
  \begin{align}
  S_{male,dir,l} = & \frac {1}{1+e^{-S_{slope,m,d}(L_{l}-S_{50,m,d}}}) \\
  S_{fem,dir,l} = & \frac {1}{1+e^{-S_{slope,f,d}(L_{l}-S_{50,f,d}}}) \\
  S_{trawl,l} = & \frac {1}{1+e^{-S_{slope,t}(L_{l}-S_{50,t}}}) \\
  R_{dir,l} = & \frac {1}{1+e^{-S_{slope,m,d}(L_{l}-S_{50,m,d}}})
  \end{align}

Where S~*slope,s,f*~ is the slope of the logistic curve for sex *s* in fishery *f* and S~*50,s,f*~ is the length at 50% selection for sex *s* in fishery *f*.  Catches for all fisheries are modeled as pulse fisheries in which all catch is removed instantaneously (i.e. no natural mortality occurs). Catch in fishery *f* during year *y* is calculated as the fraction of the total fishing mortality, F~*s,f,y,l*~, applied to a given sex *s* in a fishery *f* times the biomass removed by all fisheries for that sex.

 \begin{align}
 C_{male,dir,y}  = & \sum_{l} \sum_{v} \sum_{m} w_{male,l} \frac {R_l F_{male,dir,y,l}}{F_{male,dir,y,l + F_{trawl,y,l}}} N_{male,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{male,dir,y,l}+F_{trawl,y,l})}) \\
 C_{male,tot,y}  = & \sum_{l} \sum_{v} \sum_{m} w_{male,l} \frac {F_{male,dir,y,l}}{F_{male,dir,y,l + F_{trawl,y,l}}} N_{male,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{male,dir,y,l}+F_{trawl,y,l})}) \\
 C_{fem,dir,y}   = & \sum_{l} \sum_{v} \sum_{m} w_{fem,l} \frac {F_{fem,dir,y,l}}{F_{fem,dir,y,l + F_{trawl,y,l}}} N_{fem,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{fem,dir,y,l}+F_{trawl,y,l})})  \\
 C_{m+f,trawl,y}  = & \sum_{s} \sum_{l} \sum_{v} \sum_{m} w_{s,l} N_{s,v,m,y,l} e^{-\delta_y M_{s,m}} (1-e^{-(F_{trawl,y,l})})
 \end{align}
 
Where $\delta_y$ is the mid point of the fishery (all fisheries are assumed to occur concurrently and the midpoint is based on the directed fishery, which accounts for the vast majority of the fishing mortality) and w~*s,l*~ is the weight at length *l* for sex *s*. Trawl data and discard data are entered into the model with an assumed mortality of 80% and 30%, respectively.  Fully-selected fishing mortality parameters for fishery *f* are estimated as a logged average over a given time period ($F^{log}_{avg}$) with yearly deviations around that mean ($F^{log}_{dev,y}$).

\begin{equation}
 F_{f,y} = e^{F^{log}_{avg,f}+F^{log}_{dev,f,y}}
\end{equation}

Selectivity for the survey is estimated for 3 eras: 1978-1981, 1982-1988, and 1989-present. Selectivity is assumed to be logistic and separate parameters representing the length at which selection probability equal 50% and 95% (s~*50,s,e*~ and s~*95,s,e*~, respectively) are estimated for males and females in the third era (1989-present). Separate catchability coefficients (q~*s,e*~) are estimated for males and females in all eras.

  \begin{equation}
  S_{surv,s,l,e} =  \frac {q_{s,e}}{1+e^{-log(19)\frac{L_{l}-s_{50,s,e}}{s_{95,s,e}-s_{50,s,e}}}}) \\
  \end{equation}

Survey selectivity is informed by side-by-side experimental surveys during the years 2009 and 2010. A portion of the NMFS summer survey tows were accompanied by an industry vessel using nephrops trawls with an assumed selectivity of 1 for all size classes. To represent the proportion of the population covered by the experiment, a vector is freely estimated for males, $S^{free}_{y}$ (subject to a scaling parameter), and a logistic curve is estimated for females, INSERT NAME. 

  \begin{align}
  S_{IND,s=fem,l,y} = & \frac {q_{IND,s=fem,y}}{1+e^{-log(19)\frac{L_{l}-s_{50,s,y}}{s_{95,s,y}-s_{50,s,y}}}}) \\
  S_{IND,s=male,l,y} = &  q_{IND,s=male,y}S^{free}_{y} 
  \end{align}

Based on this logic, after identifying the fraction of the crab at length covered by the experimental surveys, the length frequencies of the NMFS data collected simultaneously with the experimental trawls can be calculated by multiplying the numbers at length 'available' to the experimental trawls by the overall survey selectivity, S~*surv,s,l,e=3*~. The predicted numbers at length for the NMFS and industry data from the selectivity experiment are calculated by multiplying the respective selectivities by the survey numbers at length.

  \begin{equation}
  S_{NMFS,s,l,expY} =  S_{IND,s,l,y}  S_{surv,s,l,e=3} 
  \end{equation}


The probability of maturing for both males and females is a freely estimated vector INSERT VECTOR. Mature male and female biomass (MMB and FMB, respectively) are fitted in the objective function and are the product of mature numbers at length during year *y* and the weight at length, w~*s,l*~:

  \begin{align}
  MMB_{y} = & \sum_{l,v} w_{male,l} N_{male,v,mat,y,l} \\
  FMB_{y} = & \sum_{l,v} w_{fem,l} N_{fem,v,mat,y,l} \\
  w_{s,l} = & \alpha_{wt,s}L_{l}^{\beta_{wt,s}}
  \end{align}

Parameters $\alpha_{wt,s}$ and $\beta_{wt,s}$ are estimated outside of the assessment model and specified in the control file.

Molting and growth occur before the survey.  Immmature crab are assumed to molt every year with an estimated probabillity of molting to maturity based on length *l* (a freely estimated vector of probabilities between 0 and 1). For crab that do molt, the growth increment within the size-transition matrix, X~*s,l,l'*~, is based on a piece-wise linear relationship between predicted pre- and post-molt length, $\hat{L}^{post}_{s,l}$ and the variabillity around that relationship is characterized by a discretized and renormalized gamma function.

 \begin{equation} X_{s,l,l'} = \frac{Y_{s,l,l'}}{ \sum_{l'} Y_{s,l,l'}}\end{equation}

 \begin{equation} Y_{s,l,l'} = (\Delta_{l,l'})^{\frac {\hat{L_{s,l}}-(\bar{L}_{l}-2.5)}{ \beta_{s}}} \end{equation}

 \begin{equation} \hat{L}^{post}_{s,l} = \frac {\hat{L}^{post}_{s,l,1} (1- \Phi (( \bar{L}_{s,l}^{pre} - \delta_{a,x}) / {stgr}))
 +  \hat{L}^{post}_{s,l,2} \Phi ((\bar{L}_{s,l}^{pre} - \delta_{a,x})/{stgr})}{2} \end{equation}

 \begin{equation} \Delta_{l,l'} = \bar{L}_{l'} + 2.5 - L_{l} \end{equation}


 Where EXPLAIN THINGS ABOVE THAT NEED EXPLAINING.
 
 An average recruitment for the assessment period (1978-present) and yearly deviations around this average are estimated within the assessment.  The sex ratio of recruitment is assumed to be 50/50 male to female.  Each year's estimated recruitment is allocated to length bins based on a discretized and renormalized gamma function.
 
 \begin{equation} Re_{y} = e^{(Rec_{avg} + Rec_{dev,y})} \end{equation}
 \begin{equation} Pr_l = \frac {(\Delta_{1,l})^{v^1/v^2}e^{-\Delta_{1,l'}/v^2}}{\sum_{l'} (\Delta_{1,l'})^{v^1/v^2}e^{(-\Delta_{1,l'}/v^2)}} \end{equation}
 

## Likelihood components

Three general types of likelihood components are used here to fit to the available data: multinomial likelihoods for size composition data, a log-normal likelihoods for indices of abundance data, and normal likelihoods for catch data, growth data, priors, and penalties. Multinomial likelihoods are implemented in the form:

\begin{equation} L_{x} = \lambda_{x} \sum_{y} N^{eff}_{x,y} \sum_{l} p^{obs}_{x,y,l} ln( \hat {p}_{x,y,l}/p^{obs}_{x,y,l})
\end{equation}

L~*x,a*` is the likelihood associated with data component x, where $\lambda_{x,y}$ represents an optional additional weighting factor for the likelihood, $N^{eff}_{x,y}$ is the effective sample sizes for the likelihood, $p^{obs}_{x,y,l}$ is the observed proportion in size bin *l* during year *y* for data component *x*, and $\hat {p}_{x,y,l}$ is the predicted proportion in size bin *l* during year *y* for data component *x*. XX multinomial likelihood components are included in the assessment (see table XX for descriptions, weighting factors, and effective sample sizes).

Iterative methods for determining appropriate effective samples sizes for composition data are suggested to avoid overweighting the size composition data and washing out the signal from the indices of abundance.  Talk about Francis method here. Talk about why it wasn't used.

Lognormal likelihoods were implemented in the form:

\begin{equation} L_{x} = \lambda_{x} \sum_{y} \frac {(ln(\hat{I}_{x,y}) - ln(I_{x,y}))^2}{2(ln(CV_{x,y}^2 + 1))}
\end{equation}

$L_{x}$ is the contritbution to the objective function of data component *x*, $\lambda_{x}$ is any additional weighting applied to the component, $\hat{I}_{x,y}$ is the predicted value of quantity *I* from data component *x* during year *y*, I~*x,y*~ is the observed value of quantity *I* from data component *x* during year *y* and CV~*x,y*~ is the coefficient of variation for data component *x* during year *y*.  XX lognormal likelihood components are included in this assessment (see table XX for descriptions, weighting factors, and CVs).

Normal likelihoods were implemented in the form:

\begin{equation} L_{x} = \lambda_{x} \sum_{y}  (\hat{I}_{x,y} - I_{x,y})^2
\end{equation}

$L_{x}$ is the contritbution to the objective function of data component *x*, $\lambda_{x}$ is represents the weight applied to the data component (and can be translated to a standard deviation), $\hat{I}_{x,y}$ is the predicted value of quantity *I* from data component *x* during year *y*, I~*x,y*~ is the observed value of quantity *I* from data component *x* during year *y*. XX normal likelihood components are included in this assessment (see table XX for descriptions, weighting factors, and translated standard deviations).


Crab were distributed into 5mm CW bins based on a pre-molt to post-molt transition matrix.  For immature crab, the number of crabs in length bin l in year t-1 that remain immature in year t is given by,

Code for this assessment can be found on github.com/szuwalski/SnowCrab.

\newpage

# APPENDIX B: PROJECTION MODEL STRUCTURE
The projection framework in the assessment is used to calculate reference points and project numbers at length to the time of fishery to calculate the OFL and associated total allowable catches.  Previously, parameters were estimated by fitting the model to the data, then the parameters were assumed known, and the final year's numbers at length were transferred to a projection model. Reference points were calculated by projecting the population into the future under no fishing mortalty (to find virgin biomass) and a fishing mortality was solved for that reduced the mature male biomass to 35% of virgin levels. The process was repeated to find the OFL, by adding lognormal error was to the initial numbers at length (i.e. those in the final year of assessment) and iteratively calculating the F~OFL~ based on the harvest control rule outlined above.  Many simulations with different lognormal error were carried out to develop a distribution of the OFL which was then used to determine an ABC.

This method does not propagate the uncertainty in all parameters forward, so a Bayesian methodology was adopted for this iteration of the assessment. In the Bayesian implementation of this assessment model, none of the equations changed (other than in the ways requested by the CPT), but the distributions for the OFL, MMB, B~35%~, and F~35%~ were developed by characterizing the posterior distributions of these quantities via a Markov Chain Monte Carlo algorithm built into ADMB.  Accomplishing this required building in functions to calculate reference points and extra storage space (see functions 'get_fut_mortality', 'find_OFL', 'find_F35' in the .TPL on github).


Previous
Current (MCMCMCMCMCMC)

\newpage

# Tables 

```{r,echo=FALSE,warning=FALSE,message=F}

# format all the above into a tabular format
tmpMat<-matrix(ncol=6,nrow=SurvYrN)
tmpMat[,1]<-SurveyYrs
tmpMat[match(RetCatchYrs,SurveyYrs),2]<-ObsCatchNumbers/10000
tmpMat[match(RetCatchYrs,SurveyYrs),3]<-ObsCatchPounds/10000
tmpMat[match(RetCatchYrs,SurveyYrs),4]<-ObsDiscF/10000
tmpMat[match(RetCatchYrs,SurveyYrs),5]<-ObsDiscM/10000
tmpMat[match(RetCatchYrs,SurveyYrs),6]<-TrawlBycatch/10000


PlotTab<- data.frame(round(tmpMat,2))
colnames(PlotTab)<- c("Survey year","Retained catch (numbers)","Retained catch (lbs)",
                      "Discarded females","Discarded males","Trawl bycatch (numbers)")

## break apart catch and survey numbers
## add cvs for survey

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10,caption="\\label{obscatch}Observed retained catches, discarded catch, and bycatch")
#TRY PANDER
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

# format all the above into a tabular format
tmpMat<-matrix(ncol=5,nrow=SurvYrN)
tmpMat[,1]<-SurveyYrs
tmpMat[,2]<-snowad.rep[[1]]$"Observed survey female spawning biomass"[1:SurvYrN]
tmpMat[,4]<-snowad.rep[[1]]$"Observed survey male spawning biomass"[1:SurvYrN]
tmpMat[,3]<-snowad.rep[[1]]$"survey CV"[1,]
tmpMat[,5]<-snowad.rep[[1]]$"survey CV"[2,]
PlotTab<- data.frame(round(tmpMat,2))
colnames(PlotTab)<- c("Survey year","Female mature biomass","Female CV",
                      "Mature male biomass","Male CV")
## break apart catch and survey numbers
## add cvs for survey

rownames(PlotTab)<- NULL
pander(PlotTab,split.cells=10,caption="\\label{obsbio}Observed mature male and female biomass at the time of the survey and coefficients of variation")
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}
#==================================
# Growth data
tmp       <-grep("growth data female",DATfile)
GrowthNfem<-as.numeric(DATfile[(tmp+1)])
tmp1      <-grep("growth data male",DATfile)
GrowthNm  <-as.numeric(DATfile[(tmp1+1)])
GrowthData<-matrix(NA,ncol=4,nrow=max(GrowthNm,GrowthNfem))

GrowthData[1:GrowthNfem,1]  <-as.numeric(unlist(strsplit(DATfile[(tmp+2)],split="\t")))
GrowthData[1:GrowthNfem,2] <-as.numeric(unlist(strsplit(DATfile[(tmp+3)],split="\t")))

GrowthData[1:GrowthNm,3]  <-as.numeric(unlist(strsplit(DATfile[(tmp1+2)],split="\t")))
GrowthData[1:GrowthNm,4] <-as.numeric(unlist(strsplit(DATfile[(tmp1+3)],split="\t")))

PlotTab<-data.frame(GrowthData)
colnames(PlotTab)<-c("Female premolt length (mm)","Female postmolt length (mm)",
                     "Male premolt length (mm)","Male postmolt length (mm)")
pander(PlotTab,split.cells=13,caption="\\label{growthdata}Observed growth increment data by sex")
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

LikeForm<-read.csv(paste(TakeDir,"Likelihood components and weightings.csv",sep=""),header=T)
CTLfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.CTL",sep=""))
DATfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.DAT",sep=""))

WeightVals<-rep(0,nrow(LikeForm))
PriorVal<-rep(NA,nrow(LikeForm))

#==
GetWeights<-function(VarName,VarLoc,VarInd)
{
  tmp<-grep(VarName,VarLoc)
  rawWeight<-as.numeric(unlist(strsplit(VarLoc[tmp+1],split=" ")))[2]
  if(is.na(rawWeight))
    rawWeight<-as.numeric(unlist(strsplit(VarLoc[tmp+1],split=" ")))[1]
  
  if(LikeForm[VarInd,3]=='normal')
    outWeight<-paste("sd = ",round(sqrt(1/(2*rawWeight)),2),sep="")
  if(LikeForm[VarInd,3]=='lognormal')
    outWeight<-paste("cv = ",rawWeight,sep="")
  if(LikeForm[VarInd,3]=='multinomial')
    outWeight<-paste("EffN = ",rawWeight,sep="")
  return(outWeight)
}

WeightVals[1]<-GetWeights("like_wght_recf",CTLfile,1)
PriorVal[1]<-0

WeightVals[2]<-GetWeights("old_shell_constraint",CTLfile,2)
PriorVal[1]<-0

WeightVals[3]<-GetWeights("nsamples weight for retained fishery",DATfile,3)
WeightVals[4]<-GetWeights("nsamples weight for retained fishery",DATfile,4)
WeightVals[5]<-GetWeights("nsamples weight for fishery female",DATfile,5)
WeightVals[6]<-GetWeights("put in larger sample size for initial",DATfile,6)
WeightVals[7]<-GetWeights("sample sizes trawl length data",DATfile,7)
WeightVals[8]<-GetWeights("assumed sample sizes",DATfile,8)
WeightVals[9]<-GetWeights("assumed sample sizes",DATfile,9)

#==ugh this is ridiculous...fix this
tmp<-grep("natm_mult_var",CTLfile)
rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[10]<-paste("sd = ",round(sqrt(rawVar),2))
PriorVal[10]<-1

# tmp<-grep("natm_Immult_var",CTLfile)
# rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
# WeightVals[11]<-paste("SD = ",round(sqrt(rawVar)))
# PriorVal[11]<-1

# tmp<-grep("smooth_mat_wght",CTLfile)
# rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
# WeightVals[11]<-paste("wt = ",round(sqrt(rawVar[1])))
WeightVals[11]<-GetWeights("mat_est_vs_obs_sd",CTLfile,11)

WeightVals[12]<-GetWeights("growth_data_wght_m",CTLfile,12)
WeightVals[13]<-GetWeights("growth_data_wght_f",CTLfile,13)

WeightVals[14]<-"cv = 1.64,1.79 (f,m)"
WeightVals[15]<-"cv = 0.46,0.32 (f,m)"
WeightVals[16]<-GetWeights("cput_cv",CTLfile,16)
WeightVals[17]<-GetWeights("weight for retained catch biomass",CTLfile,17)

tmp<-grep("weight for retained catch biomass",CTLfile)
wt1<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[18]<-paste("sd = ",round(sqrt(wt1)))

WeightVals[19]<-GetWeights("weight for retained catch biomass",CTLfile,19)

tmp<-grep("disc_catch_wght_fem",CTLfile)
wt2<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[20]<-paste("sd = ",round(sqrt(wt1*wt2)))

WeightVals[21]<-"cv = 0.14-0.57; 0.084-0.227 (f,m)"
WeightVals[22]<-GetWeights("like_wght_fph2",CTLfile,22)
PriorVal[22]<-1.15

WeightVals[23]<-"cv = 0.19,0.29 (f,m)"
WeightVals[24]<-"cv = 0.13,0.21 (f,m)"

WeightVals[25]<-GetWeights("sample sizes trawl length data",DATfile,25)
WeightVals[26]<-WeightVals[9]<-GetWeights("assumed sample sizes",DATfile,26)
WeightVals[27]<-WeightVals[9]<-GetWeights("assumed sample sizes",DATfile,27)

tmp<-grep("selsmo_wght",CTLfile)
rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[28]<-paste("wt = ",round(sqrt(rawVar[2])))

tmp<-grep("femSel_wght",CTLfile)
rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[29]<-paste("wt = ",round(sqrt(rawVar[2])))

tmp<-grep("init_yr_len_smooth_f",CTLfile)
rawVar<-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
WeightVals[30]<-paste("wt = ",round(sqrt(rawVar[2])))

inPanda<-cbind(LikeForm[,2:3],WeightVals,PriorVal)
colnames(inPanda)<-c("Likelihood component","Form","Weighting","Prior")
pander(inPanda,split.cells=c(25,10,15,10),justify=c("left",rep("center",3)),caption="\\label{likeform}Likelihoods form, weighting, and priors for the base model")

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

LikeNames<-read.csv(paste(TakeDir,"LikelihoodComponentNames.txt",sep=""),header=F)

OutLikes<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
 OutLikes[[x]]<-readLines(paste("C:/SnowCrab/",Scenarios[x],"/2016sc.REP",sep=""))[2]

# format all the above into a tabular format
tmpMat<-matrix(ncol=length(Scenarios)+1,nrow=nrow(LikeNames))
tmpMat[,1]<-LikeNames[,2]
for(x in 1:length(Scenarios))
  tmpMat[,1+x]<-round(as.numeric(unlist(strsplit(OutLikes[[x]],split=" ")))[2:(nrow(tmpMat)+1)],2)

PlotTab<- data.frame(tmpMat)
PlotTab[,1]<-inPanda[,1]
colnames(PlotTab)<- c("Likelihood component",ScenarioNames)
## break apart catch and survey numbers
## add cvs for survey

rownames(PlotTab)<- NULL

pander(PlotTab,split.cells=c(20,rep(length(Scenarios))),justify=c("left",rep("center",length(Scenarios))),caption="\\label{objfun}Contribution to the objective function by individual likelihood component by modeling scenario")
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

ParBounds<-read.csv(paste(TakeDir,"Parameter Bounds.csv",sep=""),header=T)
ParSymbol<- "$\\alpha_{f}$"
ParSymbol<-append(ParSymbol, "$\\alpha_{m}$")
ParSymbol<-append(ParSymbol, "$\\beta_{f,1}$")
ParSymbol<-append(ParSymbol, "$\\beta_{m,1}$")
ParSymbol<-append(ParSymbol, "$\\beta_{f,2}$")
ParSymbol<-append(ParSymbol, "$\\beta_{m,2}$")
ParSymbol<-append(ParSymbol, "$\\delta_{m}$")
ParSymbol<-append(ParSymbol, "$\\delta_{f}$")
ParSymbol<-append(ParSymbol, "stgr")
ParSymbol<-append(ParSymbol, "$\\beta_{g}$")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, "$\\Omega_{m,l}$")
ParSymbol<-append(ParSymbol, "$\\Omega_{f,l}$")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, "$\\kappa_{s,l'}$")
ParSymbol<-append(ParSymbol, "$\\kappa_{s,l'}$")
ParSymbol<-append(ParSymbol, "$Rec_{avg}$")
ParSymbol<-append(ParSymbol, " ")
ParSymbol<-append(ParSymbol, "$Rec_{f,dev,y}$")
ParSymbol<-append(ParSymbol, "$Rec_{m,dev,y}$")
ParSymbol<-append(ParSymbol, "$\\alpha_{rec}$")
ParSymbol<-append(ParSymbol, "$\\beta_{rec}$")
ParSymbol<-append(ParSymbol, "$\\lambda_{male,v,l}$")
ParSymbol<-append(ParSymbol, "$\\lambda_{fem,v,l}$")

ParSymbol<-append(ParSymbol, "$F^{log}_{avg,dir}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{dev,dir,y}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{avg,disc}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{dev,disc,y}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{avg,trawl}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{dev,trawl,era1}$")
ParSymbol<-append(ParSymbol, "$F^{log}_{dev,trawl,era2}$")

ParSymbol<-append(ParSymbol, "")
ParSymbol<-append(ParSymbol, "")

ParSymbol<-append(ParSymbol, "$S_{50,new,dir}$")
ParSymbol<-append(ParSymbol, "")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")
ParSymbol<-append(ParSymbol, "")

ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$") #44
ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")

ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")
ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")
ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")
ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")
ParSymbol<-append(ParSymbol, "$S_{slope,m,d}$")
ParSymbol<-append(ParSymbol, "$S_{50,old,dir}$")

ParSymbol<-append(ParSymbol, "$log(S_{50,f,disc,dev})$")

ParSymbol<-append(ParSymbol, "$S_{slope,trawl}$")
ParSymbol<-append(ParSymbol, "$S_{50,trawl}$")

ParSymbol<-append(ParSymbol, "$q_{m,era1,surv}$")
ParSymbol<-append(ParSymbol, "$q_{f,era1,surv}$")
ParSymbol<-append(ParSymbol, "$S_{95,era1,surv}$")
ParSymbol<-append(ParSymbol, "$S_{50,era1,surv}$")

ParSymbol<-append(ParSymbol, "$q_{m,era2,surv}$")
ParSymbol<-append(ParSymbol, "$q_{f,era2,surv}$")
ParSymbol<-append(ParSymbol, "$S_{95,era2,surv}$")
ParSymbol<-append(ParSymbol, "$S_{50,era2,surv}$")

ParSymbol<-append(ParSymbol, "$q_{m,era3,surv}$")
ParSymbol<-append(ParSymbol, "$S_{95,m,era2,surv}$")
ParSymbol<-append(ParSymbol, "$S_{50,m,era2,surv}$")

ParSymbol<-append(ParSymbol, "$q_{f,era3,surv}$")
ParSymbol<-append(ParSymbol, "$S_{95,f,era2,surv}$")
ParSymbol<-append(ParSymbol, "$S_{50,f,era2,surv}$")

ParSymbol<-append(ParSymbol, "$q_{m,09,ind}$")
ParSymbol<-append(ParSymbol, "$q_{f,09,ind}$")
ParSymbol<-append(ParSymbol, "$S_{95,f,09,ind}$")
ParSymbol<-append(ParSymbol, "$S_{50,f,09,ind}$")

ParSymbol<-append(ParSymbol, "$q_{m,10,ind}$")
ParSymbol<-append(ParSymbol, "$q_{f,10,ind}$")
ParSymbol<-append(ParSymbol, "$S_{95,f,10,ind}$")
ParSymbol<-append(ParSymbol, "$S_{50,f,10,ind}$")

ParSymbol<-append(ParSymbol, "SelVecMaleInd09")
ParSymbol<-append(ParSymbol, "SelVecMaleInd10")

ParSymbol<-append(ParSymbol, "$\\gamma_{natM,imm}$")
ParSymbol<-append(ParSymbol, "$\\gamma_{natM,mat,m}$")
ParSymbol<-append(ParSymbol, "$\\gamma_{natM,mat,f}$")
ParSymbol<-append(ParSymbol, "$q_{cpue}$")
ParSymbol<-append(ParSymbol, "$Pr_{l}$")


ParsAndSymbols<-cbind(ParBounds,ParSymbol)
PlotTab<-ParsAndSymbols[ParBounds$Include>0,c(1,2,3,6)]
rownames(PlotTab)<- NULL
colnames(PlotTab)<-c("Parameter","Lower","Upper","Symbol")
pander(PlotTab,split.cells=c(10,10,10,10),justify=c("left",rep("center",3)),caption="\\label{parbound}Parameter bounds and symbols")
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F}

#==pulling parameter values
#==this should be the medians of the posteriors for all of these eventually
PARvals<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  PARvals[[x]]  <-readLines(paste("C:/SnowCrab/",Scenarios[x],"/2016sc.PAR",sep=""))

TableParVals<-matrix(nrow=nrow(ParBounds),ncol=length(Scenarios))

PullPars<-function(getName,getInd=1,inParVals)
{
 tmp<-grep(paste("# ",getName,":",sep=""),inParVals)
 temp<-as.numeric(unlist(strsplit(inParVals[tmp+1],split=" ")))
 pull<-NA
 if(length(temp)==1)
  pull<-round(as.numeric(inParVals[tmp+getInd]),2)
 if(length(temp)>1)
  pull<-"vector"
 return(pull)
}

for(x in 1:nrow(ParBounds))
 for(y in 1:length(PARvals))  
   TableParVals[x,y]<-PullPars(getName=ParBounds[x,1],inParVals=PARvals[[y]])
  
PlotTab<-cbind(as.character(ParsAndSymbols$Parameter),TableParVals)
PlotTab<-PlotTab[ParBounds$Include>0,]

rownames(PlotTab)<- NULL
colnames(PlotTab)<-c("Parameter",ScenarioNames)
pander(PlotTab,split.cells=c(14,rep(8,length(Scenarios))),justify=c("left",rep("center",length(Scenarios))),caption="\\label{estpars}Estimated parameter values by scenario")
```

\newpage

```{r malemap, echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{malemap}Observed relative density of all males at the time of the 2016 NMFS summer survey"}
library(plotrix)
survDAT<-read.csv("C:/SnowCrab/EBSCrab_Haul.csv",header=T)

drvYear<-as.numeric(substr(survDAT$CRUISE,1,4))
SurvYR<-unique(drvYear)
AllStation<-unique(survDAT$GIS_STATION)

#==plot GIS stations
AllStnLoc<-matrix(ncol=2,nrow=length(AllStation))
for(w in 1:length(AllStation))
{
  temp<-survDAT[survDAT$GIS_STATION==AllStation[w],]
  AllStnLoc[w,1]<-temp$MID_LATITUDE[1]
  AllStnLoc[w,2]<-temp$MID_LONGITUDE[1]
}

# dev.new(width=15,height=10)
# par(mar=c(.1,.1,.1,.1))
# plot(0,ylim=c(min(AllStnLoc[,1]),max(AllStnLoc[,1])),xlim=c(min(AllStnLoc[,2]),max(AllStnLoc[,2])))
# for(w in 1:length(AllStation))
#   text(AllStation[w],x=AllStnLoc[w,2],y=AllStnLoc[w,1],cex=.5)

#========================
#==find survey densities (total)
#========================
nmiSurv<-140350
DensityM<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
DensityM78<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
DensityM101<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
DensityF<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
DensityFmat<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
StationYr<-matrix(nrow=length(SurvYR),ncol=length(AllStation))
for(y in 1:length(SurvYR))
{
  yrDAT<-survDAT[drvYear==SurvYR[y],]
  fileyr<-SurvYR[y]
  stationsUNQ<-(unique(yrDAT$GIS_STATION))
  #==density at station
  for(j in 1:length(stationsUNQ))
  {
    stationALL<-yrDAT[yrDAT$GIS_STATION==stationsUNQ[j],]
    StationYr[y,j]<-as.character(stationsUNQ[j])
    Hauls<-(unique(stationALL$HAUL))
    Males<-stationALL[stationALL$SEX==1,]
    Males78<-stationALL[stationALL$SEX==1 & stationALL$WIDTH>77,]
    Males101<-stationALL[stationALL$SEX==1& stationALL$WIDTH>101,]
    Females<-stationALL[stationALL$SEX==2,]
   
    #==densities across hauls in crabs per km^2
    tempDensM<-NULL
    tempDensM78<-NULL
    tempDensM101<-NULL
    tempDensF<-NULL
    for(k in 1:length(Hauls))
    {
      SampFactM<-Males$SAMPLING_FACTOR[which(Males$HAUL==Hauls[k])[1]] 
      AreaSweptM<-Males$AREA_SWEPT_VARIABLE[which(Males$HAUL==Hauls[k])[1]]
      tempDensM<-length(Males$HAUL==Hauls[k])*SampFactM/AreaSweptM
      
      SampFactM<-Males78$SAMPLING_FACTOR[which(Males78$HAUL==Hauls[k])[1]] 
      AreaSweptM<-Males78$AREA_SWEPT_VARIABLE[which(Males78$HAUL==Hauls[k])[1]]
      tempDensM78<-length(Males78$HAUL==Hauls[k])*SampFactM/AreaSweptM
      
      SampFactM<-Males101$SAMPLING_FACTOR[which(Males101$HAUL==Hauls[k])[1]] 
      AreaSweptM<-Males101$AREA_SWEPT_VARIABLE[which(Males101$HAUL==Hauls[k])[1]]
      tempDensM101<-length(Males101$HAUL==Hauls[k])*SampFactM/AreaSweptM
      
      SampFactF<-Females$SAMPLING_FACTOR[which(Females$HAUL==Hauls[k])[1]] 
      AreaSweptF<-Females$AREA_SWEPT_VARIABLE[which(Females$HAUL==Hauls[k])[1]]
      tempDensF<-length(Females$HAUL==Hauls[k])*SampFactF/AreaSweptF
    }
    DensityM[y,j]<-mean(tempDensM)
    DensityM78[y,j]<-mean(tempDensM78)
    DensityM101[y,j]<-mean(tempDensM101)
    DensityF[y,j]<-mean(tempDensF)
  }
}

#===========================
#  plot densities by year
#============================

library("maps")
library("lattice")
library(PBSmapping)
library(mapdata)    #some additional hires data
library(maptools)   #useful tools such as reading shapefiles
library(mapproj)

 y<-length(SurvYR)
  state.map <- map('worldHires', xlim=c(-175, -155.9), ylim=c(50, 65.5),
                   plot = FALSE, fill = TRUE,col='grey85')
  #  S of 58.39, W of 168
  # state.map <- map('worldHires', xlim=c(-173, -167.5), ylim=c(52, 58),
  #                  plot = FALSE, fill = TRUE,col='grey85')
  # 
  state.info <- data.frame(density = DensityM[y,],
                           long = AllStnLoc[match(StationYr[y,],AllStation,),2],
                           lat = AllStnLoc[match(StationYr[y,],AllStation,),1])
  state.info<-state.info[rowSums(is.na(state.info))!=3, ]
  state.info[is.na(state.info),1]<-0
  
  panel.3dmap <- function(..., rot.mat, distance, xlim,
                          ylim, zlim, xlim.scaled, ylim.scaled, zlim.scaled) {
    scaled.val <- function(x, original, scaled) {
      scaled[1] + (x - original[1]) * diff(scaled)/diff(original)
    }
    m <- ltransform3dto3d(rbind(scaled.val(state.map$x,
                                           xlim, xlim.scaled), scaled.val(state.map$y, ylim,
                                                                          ylim.scaled), zlim.scaled[1]), rot.mat, distance)
    panel.lines(m[1, ], m[2, ], col = "grey76")
  }
  
  pl <-cloud(density ~ long + lat, state.info, panel.3d.cloud = function(...) {
    panel.3dmap(...)
    panel.3dscatter(...)
  }, type = "h", scales = list(draw = TRUE), zoom = 1.1,
  xlim = state.map$range[1:2], ylim = state.map$range[3:4],
  xlab = NULL, ylab = NULL, zlab = NULL, aspect = c(diff(state.map$range[3:4])/diff(state.map$range[1:2]),
                                                    0.3), panel.aspect = 0.75, lwd = 3, screen = list(z = 30, x = -60), par.settings = list(axis.line = list(col = "transparent"),box.3d = list(col = "transparent", alpha = 0)))
  
  print(pl)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{male77map}Observed relative density of males >77mm carapace width at the time of the 2016 NMFS summer survey"}

  y<-length(SurvYR)
  state.map <- map('worldHires', xlim=c(-175, -155.9), ylim=c(50, 65.5),
                   plot = FALSE, fill = TRUE,col='grey85')
  #  S of 58.39, W of 168
  # state.map <- map('worldHires', xlim=c(-173, -167.5), ylim=c(52, 58),
  #                  plot = FALSE, fill = TRUE,col='grey85')
  # 
  state.info <- data.frame(density = DensityM78[y,],
                           long = AllStnLoc[match(StationYr[y,],AllStation,),2],
                           lat = AllStnLoc[match(StationYr[y,],AllStation,),1])
  state.info<-state.info[rowSums(is.na(state.info))!=3, ]
  state.info[is.na(state.info),1]<-0
  
  panel.3dmap <- function(..., rot.mat, distance, xlim,
                          ylim, zlim, xlim.scaled, ylim.scaled, zlim.scaled) {
    scaled.val <- function(x, original, scaled) {
      scaled[1] + (x - original[1]) * diff(scaled)/diff(original)
    }
    m <- ltransform3dto3d(rbind(scaled.val(state.map$x,
                                           xlim, xlim.scaled), scaled.val(state.map$y, ylim,
                                                                          ylim.scaled), zlim.scaled[1]), rot.mat, distance)
    panel.lines(m[1, ], m[2, ], col = "grey76")
  }
  
  pl <-cloud(density ~ long + lat, state.info, panel.3d.cloud = function(...) {
    panel.3dmap(...)
    panel.3dscatter(...)
  }, type = "h", scales = list(draw = TRUE), zoom = 1.1,
  xlim = state.map$range[1:2], ylim = state.map$range[3:4],
  xlab = NULL, ylab = NULL, zlab = NULL, aspect = c(diff(state.map$range[3:4])/diff(state.map$range[1:2]),
                                                    0.3), panel.aspect = 0.75, lwd = 3, screen = list(z = 30,
                                                                                                      x = -60), par.settings = list(axis.line = list(col = "transparent"),
                                                                                                                                    box.3d = list(col = "transparent", alpha = 0)))
  
  print(pl)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{male101map}Observed relative density of males >101mm carapace width at the time of the 2016 NMFS summer survey"}

  y<-length(SurvYR)
  state.map <- map('worldHires', xlim=c(-175, -155.9), ylim=c(50, 65.5),
                   plot = FALSE, fill = TRUE,col='grey85')
  #  S of 58.39, W of 168
  # state.map <- map('worldHires', xlim=c(-173, -167.5), ylim=c(52, 58),
  #                  plot = FALSE, fill = TRUE,col='grey85')
  # 
  state.info <- data.frame(density = DensityM101[y,],
                           long = AllStnLoc[match(StationYr[y,],AllStation,),2],
                           lat = AllStnLoc[match(StationYr[y,],AllStation,),1])
  state.info<-state.info[rowSums(is.na(state.info))!=3, ]
  state.info[is.na(state.info),1]<-0
  
  panel.3dmap <- function(..., rot.mat, distance, xlim,
                          ylim, zlim, xlim.scaled, ylim.scaled, zlim.scaled) {
    scaled.val <- function(x, original, scaled) {
      scaled[1] + (x - original[1]) * diff(scaled)/diff(original)
    }
    m <- ltransform3dto3d(rbind(scaled.val(state.map$x,
                                           xlim, xlim.scaled), scaled.val(state.map$y, ylim,
                                                                          ylim.scaled), zlim.scaled[1]), rot.mat, distance)
    panel.lines(m[1, ], m[2, ], col = "grey76")
  }
  
  pl <-cloud(density ~ long + lat, state.info, panel.3d.cloud = function(...) {
    panel.3dmap(...)
    panel.3dscatter(...)
  }, type = "h", scales = list(draw = TRUE), zoom = 1.1,
  xlim = state.map$range[1:2], ylim = state.map$range[3:4],
  xlab = NULL, ylab = NULL, zlab = NULL, aspect = c(diff(state.map$range[3:4])/diff(state.map$range[1:2]),
                                                    0.3), panel.aspect = 0.75, lwd = 3, screen = list(z = 30,
                                                                                                      x = -60), par.settings = list(axis.line = list(col = "transparent"),
                                                                                                                                    box.3d = list(col = "transparent", alpha = 0)))
  
  print(pl)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{femalemap}Observed relative density of all females at the time of the 2016 NMFS summer survey"}

  y<-length(SurvYR)
  state.map <- map('worldHires', xlim=c(-175, -155.9), ylim=c(50, 65.5),
                   plot = FALSE, fill = TRUE,col='grey85')
  #  S of 58.39, W of 168
  # state.map <- map('worldHires', xlim=c(-173, -167.5), ylim=c(52, 58),
  #                  plot = FALSE, fill = TRUE,col='grey85')
  # 
  state.info <- data.frame(density = DensityF[y,],
                           long = AllStnLoc[match(StationYr[y,],AllStation,),2],
                           lat = AllStnLoc[match(StationYr[y,],AllStation,),1])
  state.info<-state.info[rowSums(is.na(state.info))!=3, ]
  state.info[is.na(state.info),1]<-0
  
  panel.3dmap <- function(..., rot.mat, distance, xlim,
                          ylim, zlim, xlim.scaled, ylim.scaled, zlim.scaled) {
    scaled.val <- function(x, original, scaled) {
      scaled[1] + (x - original[1]) * diff(scaled)/diff(original)
    }
    m <- ltransform3dto3d(rbind(scaled.val(state.map$x,
                                           xlim, xlim.scaled), scaled.val(state.map$y, ylim,
                                                                          ylim.scaled), zlim.scaled[1]), rot.mat, distance)
    panel.lines(m[1, ], m[2, ], col = "grey76")
  }
  
  pl <-cloud(density ~ long + lat, state.info, panel.3d.cloud = function(...) {
    panel.3dmap(...)
    panel.3dscatter(...)
  }, type = "h", scales = list(draw = TRUE), zoom = 1.1, col="red",
  xlim = state.map$range[1:2], ylim = state.map$range[3:4],
  xlab = NULL, ylab = NULL, zlab = NULL, aspect = c(diff(state.map$range[3:4])/diff(state.map$range[1:2]),
                                                    0.3), panel.aspect = 0.75, lwd = 3, screen = list(z = 30,
                                                                                                      x = -60), par.settings = list(axis.line = list(col = "transparent"),
                                                                                                                                    box.3d = list(col = "transparent", alpha = 0)))
  
  print(pl)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{natlenF}Observed relative numbers at length at the time of the survey"}
LengthPlot<-function(LenDat,lenYrs,LengthBin,titled="",colrep=11,freq=T,transp=.5,shrink=5,chopX=NA)
{
if(freq==T)
 useLen<-LenDat/apply(LenDat,1,max,na.rm=T)
if(freq==F)
 useLen<-LenDat/shrink
yearN<-nrow(LenDat)
runDown<-seq(yearN,1,-1)
counter<-1
par(mar=c(3,1,1,4))
plot(0,ylim=c(0,yearN),xlim=c(0,min(length(LengthBin),chopX,na.rm=T)),type="l",axes=F,ylab="",xlab="",
main=titled)
useCol<-rep(topo.colors(colrep,alpha=transp),ceiling(yearN/colrep))
for(x in 1:yearN)
{
 tempY<-c(counter*rep(1,length(LengthBin)+1),rev(useLen[x,])+counter)
 tempX<-c(seq(1,length(LengthBin)),seq(length(LengthBin),1,-1))
 polygon(y=c(counter*rep(1,length(LengthBin)),rev(useLen[x,])+counter),
         x=c(seq(1,length(LengthBin)),seq(length(LengthBin),1,-1)),col=useCol[x],border='lightgrey')
 counter<-counter+1
}
axis(side=4,at=seq(1,yearN,3),labels=lenYrs[lenYrs%%3==1],las=1,cex=.65)
axis(side=1,at=seq(1,length(LengthBin)),labels=LengthBin,las=1,line=-1)
mtext(side=1,"Length",line=1)
}


# Bring in observed survey numbers
tmp<-grep("females survey immature new shell",DATfile)
SurvImmFemNew<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+2):(tmp+SurvYrN+1)],split=" "))),nrow=SurvYrN,byrow=T)
tmp<-grep("females survey mature new shell",DATfile)
SurvMatFemNew<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+2):(tmp+SurvYrN+1)],split=" "))),nrow=SurvYrN,byrow=T)
tmp<-grep("females survey mature old shell",DATfile)
SurvMatFemOld<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+2):(tmp+SurvYrN+1)],split=" "))),nrow=SurvYrN,byrow=T)

# LengthPlot(LenDat=SurvImmFemNew,lenYrs=SurveyYrs,LengthBin=LengthBins,titled="Immature females",colrep=11,freq=F,transp=.3,shrink=500,chopX=10)
LengthPlot(LenDat=SurvMatFemNew+SurvMatFemOld+SurvImmFemNew,lenYrs=SurveyYrs,LengthBin=LengthBins,titled="Total females",colrep=40,freq=F,transp=.3,shrink=1000,chopX=12)
```

\newpage
 
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{natlenM}Observed relative numbers at length at the time of the survey"}

# Bring in observed survey numbers
tmp<-grep("males new shell immature survey",DATfile)
SurvImmMalNew<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+3):(tmp+SurvYrN+2)],split=" "))),nrow=SurvYrN,byrow=T)
tmp<-grep("survey males new shell mature",DATfile)
SurvMatMalNew<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+3):(tmp+SurvYrN+2)],split=" "))),nrow=SurvYrN,byrow=T)
tmp<-grep("survey males old shell mature",DATfile)
SurvMatMalOld<-matrix(as.numeric(unlist(strsplit(DATfile[(tmp+2):(tmp+SurvYrN+1)],split=" "))),nrow=SurvYrN,byrow=T)

tmp<-grep("survey males old shell immature",DATfile)
temp<-unlist(strsplit(DATfile[(tmp+2):(tmp+SurvYrN+1)],split=" "))
temp<-unlist(strsplit(temp,split="\t"))
SurvImmMalOld<-matrix(as.numeric(temp),nrow=SurvYrN,byrow=T)

totMales<-SurvImmMalNew+SurvMatMalNew+SurvMatMalOld+SurvImmMalOld
LengthPlot(LenDat=totMales,lenYrs=SurveyYrs,LengthBin=LengthBins,titled="Total males",colrep=70,freq=F,transp=.3,shrink=300,chopX=20)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=6.5,fig.height=6,fig.cap="\\label{mmbfits}Model fits to the observed mature biomass at survey"}
##=======FITS TO THE DATA SOURCES=========================
#==mature male biomass==============
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,
     pch=20,ylab="Mature Male Biomass (1000 t)",
     xlab="Year",las=1,ylim=c(0,600),
     xaxt='n');

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j],
		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j])
}
for(x in 1:length(Scenarios))
 lines(as.numeric(unlist(snowad.rep[[x]]$"Predicted Male survey mature Biomass"))[1:SurvYrN]~SurveyYrs,type="l",lty=x,lwd=1)
legend("topleft",bty='n',"Males")

#==mature female biomass==============
plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20,ylab="Mature Female Biomass (1000 t)",xlab="Year",las=1,ylim=c(0,700));

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j],
		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j])
}

for(x in 1:length(Scenarios))
 lines(as.numeric(unlist(snowad.rep[[x]]$"Predicted Female survey mature Biomass"))[1:SurvYrN]~SurveyYrs,type="l",lty=x,lwd=1)
legend("topleft",bty='n',"Females")
mtext(side=2,outer=T,text=c("Mature biomass at survey (1000 t)"),line=3)
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=ScenarioNames)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=8,fig.cap="\\label{growthfits}Model fits to the growth data"}

#==Growth data
   flength <- (snowad.rep[[1]]$"af"+snowad.rep[[1]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
              (snowad.rep[[1]]$"af2"+snowad.rep[[1]]$"bf1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");
   mlength <- (snowad.rep[[1]]$"am"+snowad.rep[[1]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
              (snowad.rep[[1]]$"am2"+snowad.rep[[1]]$"b1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");

flength<-rep(list(list()),length(Scenarios))
mlength<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
{
  tempF<-(snowad.rep[[x]]$"af"+snowad.rep[[x]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[x]]$"delta male") / snowad.rep[[x]]$"st_gr")) + (snowad.rep[[x]]$"af2"+snowad.rep[[x]]$"bf1"*(20:135))*pnorm(((20:135) -snowad.rep[[x]]$"delta male")/snowad.rep[[x]]$"st_gr")
  flength[[x]]<-tempF
  tempM<-(snowad.rep[[x]]$"am"+snowad.rep[[x]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[x]]$"delta male") / snowad.rep[[x]]$"st_gr"))+ (snowad.rep[[x]]$"am2"+snowad.rep[[x]]$"b1"*(20:135))*pnorm(((20:135) -snowad.rep[[x]]$"delta male")/snowad.rep[[x]]$"st_gr")
  mlength[[x]]<-tempM
  
}

par(mfrow=c(2,1),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
Finc<-GrowthData[,2]-GrowthData[,1]
plot(Finc~GrowthData[,1],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey',xaxt='n')
legend(bty='n',"topleft","Female")

for(x in 1:length(Scenarios))
 lines(flength[[x]]-c(20:135)~c(20:135),lty=x)

Minc<-GrowthData[,4]-GrowthData[,3]
plot(Minc~GrowthData[,3],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey')
legend(bty='n',"topleft","Male")
mtext(side=2,"Growth increment (mm)",outer=T,line=2)
mtext(side=1,"Premolt length (mm)",outer=T,line=2)
for(x in 1:length(Scenarios))
 lines(mlength[[x]]-c(20:135)~c(20:135),lty=x)
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{catchfits}Model fits to catch data"}

#==pull in weights used as SD
# Read data file
CTLfile <-readLines(paste("C:/SnowCrab/",Scenarios[1],"/2016sc.CTL",sep=""))
tmp<-grep("weight for retained catch biomass",CTLfile)
RetCatWt <-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
sdRetCat<-sqrt(1/(2*RetCatWt))

tmp<-grep("wght_total_catch ",CTLfile)
TotCatWt <-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
sdTotCat<-sqrt(1/(2*TotCatWt))

tmp<-grep("disc_catch_wght_fem ",CTLfile)
FemDiscWt <-as.numeric(unlist(strsplit(CTLfile[tmp+1],split=" ")))
sdFemDisc <-sqrt(1/(RetCatWt*FemDiscWt*2))

#==retained catch biomass
par(mfrow=c(4,1),mar=c(.1,.1,.3,.1),oma=c(4,4.5,1,1))
plot(snowad.rep[[1]]$"Observed retained catch biomass"~RetCatchYrs,las=1,ylab="Retained catch biomass (t)", xaxt="n",ylim=c(0,175))
for(x in 1:length(Scenarios))
 lines(snowad.rep[[x]]$"Predicted retained catch biomas"~RetCatchYrs,lty=x)
legend("topright",bty='n',pch=c(NA,1),lty=c(1,NA),legend=c("Predicted","Observed"))
legend("topleft",bty='n',"Retained")

for(j in 1:length(RetCatchYrs))
{
 segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed retained catch biomass"))[j]  +   1.96*sdRetCat,
		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed retained catch biomass"))[j] - 1.96*sdRetCat)
}

#===discard female biomass
plot(snowad.rep[[1]]$"observed female discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n",ylim=c(0,0.2))
for(x in 1:length(Scenarios))
  lines(snowad.rep[[x]]$"predicted female discard mortality biomass"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Discard (female)")

for(j in 1:length(RetCatchYrs))
{
 segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"observed female discard mortality biomass"))[j]  +   1.96*sdFemDisc,
		y1=as.numeric(unlist(snowad.rep[[1]]$"observed female discard mortality biomass"))[j] - 1.96*sdFemDisc)
}

#===discard male biomass
plot(snowad.rep[[1]]$"observed male discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n",ylim=c(0,30))
for(x in 1:length(Scenarios))
 lines(snowad.rep[[x]]$"predicted discard male catch biomass"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Discard (male)")

for(j in 1:length(RetCatchYrs))
{
 segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"observed male discard mortality biomass"))[j]  +   1.96*sdTotCat,
		y1=as.numeric(unlist(snowad.rep[[1]]$"observed male discard mortality biomass"))[j] - 1.96*sdTotCat)
}


#===trawl catch biomass
plot(snowad.rep[[1]]$"observed trawl catch biomass"[1:CatchYrN]~RetCatchYrs,las=1,ylab="Trawl bycatch (t)",xlab="Year",ylim=c(0,5))
for(x in 1:length(Scenarios))
  lines(snowad.rep[[x]]$"predicted trawl catch biomass"[1:CatchYrN]~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Trawl")
mtext(side=2,outer=T,line=3,"Biomass (t)")
mtext(side=1,outer=T,line=2.5,"Year")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
for(j in 1:length(RetCatchYrs))
{
 segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"observed trawl catch biomass"))[j]  +   1.96*sdRetCat,
		y1=as.numeric(unlist(snowad.rep[[1]]$"observed trawl catch biomass"))[j] - 1.96*sdRetCat)
}


```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=6,fig.cap="\\label{cpuefits}Model fits to pot CPUE data"}
plot(snowad.rep[[1]]$"observed pot fishery cpue"~ SurveyYrs[1:(length(SurveyYrs)-1)],ylim=c(0,450),las=1,ylab="",xlab="")
for(x in 1:length(Scenarios))
lines(snowad.rep[[x]]$"predicted pot fishery cpue"~SurveyYrs[1:(length(SurveyYrs)-1)],lty=x)
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

for(j in 1:length(SurveyYrs))
{
 segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
		y0=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j]  +   1.96*5,
		y1=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j] - 1.96*5)
}

mtext(side=1,"Year",line=2)
mtext(side=2,"CPUE",line=2)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="\\label{selfits}Model fits to side by side survey experiments (2009 & 2010)"}

#===industry survey
ObsIndustry2009<-c(snowad.rep[[1]]$"Observed industry survey mature biomass",snowad.rep[[1]]$"observed trawl catch biomass")
ObsIndustry2010<-c(snowad.rep[[1]]$"Observed 2010 industry survey mature biomass",snowad.rep[[1]]$"observed trawl catch biomass")

#==length proportions from side by side surveys (2009, 2010)
par(mfrow=c(2,2))
par(mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
setYlim<-.2
plot(LengthBins,snowad.rep[[1]]$"bserved Prop industry survey female",ylim=c(0,setYlim),ylab="",pch=15,las=1,xaxt='n')
for(x in 1:length(Scenarios))
 lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry survey female",lty=x);
par(new=T)

plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry survey male",xaxt='n',ylab="",ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
   lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry survey male",lty=x,col=2);
legend("topleft",bty='n',"Industry 2009")

plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry nmfs survey female",ylim=c(0,setYlim),yaxt='n',ylab="",pch=15,las=1,xaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop industry nmfs survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop industry nmfs survey male",xaxt='n',ylab="",yaxt='n',ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"redicted Prop industry nmfs survey male",lty=x,col=2);
legend("topleft",bty='n',"NMFS 2009")
legend("topright",bty='n',col=c(1,2),pch=c(15,16),legend=c("Females","Males"))

plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry survey female",ylim=c(0,setYlim),ylab="",pch=15,las=1)
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry survey male",xaxt='n',ylab="",ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry survey male",lty=x,col=2);
legend("topleft",bty='n',"Industry 2010")

plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry nmfs survey female",ylim=c(0,setYlim),yaxt='n',ylab="",pch=15,las=1)
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry nmfs survey female",lty=x);

par(new=T)
plot(LengthBins,snowad.rep[[1]]$"Observed Prop 2010 industry nmfs survey male",xaxt='n',ylab="",yaxt='n',ylim=c(0,setYlim),pch=16,col=2,yaxt='n')
for(x in 1:length(Scenarios))
  lines(LengthBins,snowad.rep[[x]]$"Predicted Prop 2010 industry nmfs survey male",lty=x,col=2);
legend("topleft",bty='n',"NMFS 2010")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{survcomp_fits_f}Model fits to female survey length proportion data"}

#==survey proportions (mature and immature by sex)
#==PUT THE SAMPLE SIZE IN THE FIGURE SOMEHOW==

PlotLenProps<-function(obs,obs2=NA,pred,pred2=NA,inYears,xquant,chopX,chopY,pointsize=1,YaxisN,XaxisN,addRow=NA)
{
 Nobs<-nrow(obs)
 inRow<-ceiling(sqrt(Nobs))
 incol<-ceiling(sqrt(Nobs))
 if(!is.na(addRow))
  inRow<-inRow+1
 par(mfcol=c(inRow,incol),mar=c(0.1,.1,.1,.1),oma=c(4,4,1,1))
 for(x in 1:Nobs)
 {
  plot(obs[x,]~xquant,pch=15,ylim=c(0,chopY),xlim=c(xquant[1],chopX),xaxt='n',yaxt='n',cex=pointsize)
   if(x==YaxisN)
     axis(side=2,las=1)
   if(x==XaxisN)
     axis(side=1,las=1)
  for(y in 1:length(Scenarios))
   lines(pred[[y]][x,-1]~xquant,lty=y)
  if(!is.na(obs2))
  {
   points(obs2[x,]~xquant,pch=16,col=2,cex=pointsize)
  for(y in 1:length(Scenarios))
   lines(pred2[[y]][x,-1]~xquant,lty=y,col=2)
  }
  legend("topright",legend=inYears[x],bty='n')
 }
}
 
#==this sucks, butwriting a function to do this has too many moving parts....
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion survey immature new female" + snowad.rep[[x]]$"Predicted proportion survey immature old female"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion survey mature new female" + snowad.rep[[x]]$"Predicted proportion survey mature old female"

PlotLenProps(obs =(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")[,-1],
             obs2=(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")[,-1],
             pred =inPred,
             pred2=inPred2,
             inYears = SurveyYrs,
             xquant = LengthBins,
             chopX = 80,
             chopY = 0.18,
             XaxisN = 7,
             YaxisN = 7)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Females","Immature","Mature"),bty='n')
                          plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
             
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for immature female survey length proportion data"}
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))

tempInObs<-(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey immature new female" + snowad.rep[[1]]$"Predicted proportion survey immature old female"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=12,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for mature female survey length proportion data"}
tempInObs<-(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey mature new female" + snowad.rep[[1]]$"Predicted proportion survey mature old female"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=12,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{survcomp_fits_m}Model fits to male survey proportion at length data"}


#==this sucks, butwriting a function to do this has too many moving parts....
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion survey immature new male" + snowad.rep[[x]]$"Predicted proportion survey immature old male"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion survey mature new male" + snowad.rep[[x]]$"Predicted proportion survey mature old male"

PlotLenProps(obs =(snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male")[,-1],
             obs2=(snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male")[,-1],
             pred =inPred,
             pred2=inPred2,
             inYears = SurveyYrs,
             xquant = LengthBins,
             chopX = 140,
             chopY = 0.08,
             pointsize = .7,
             XaxisN = 7,
             YaxisN = 7)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Males","Immature","Mature"),bty='n')
             plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
             
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for fits to immature male survey proportion at length data"}
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))
tempInObs<-snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male"
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey immature new male" + snowad.rep[[1]]$"Predicted proportion survey immature old male"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=22,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for fits to mature male survey proportion at length data"}
tempInObs<-snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male"
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey mature new male" + snowad.rep[[1]]$"Predicted proportion survey mature old male"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=22,sampsize=rep(200,12),maxres=10)
```               
           
\newpage
  
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{avgsize}Observed and predicted average size in the survey composition data"}
## check things are summing as theyshould be
tempFimm<-(snowad.rep[[1]]$"Observed proportion survey immature new female" + snowad.rep[[1]]$"Observed proportion survey immature old female")[,-1]
Fi<-apply(tempFimm,1,sum)
tempFmat<-(snowad.rep[[1]]$"Observed proportion survey mature new female" + snowad.rep[[1]]$"Observed proportion survey mature old female")[,-1]
FM<-apply(tempFmat,1,sum)
tempMimm<-(snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male")[,-1]
Mi<-apply(tempMimm,1,sum)
tempMmat<-(snowad.rep[[1]]$"Observed proportion survey mature new male" + snowad.rep[[1]]$"Observed proportion survey mature old male")[,-1]
MM<-apply(tempMmat,1,sum)

# Fi+FM+Mi+MM

tempFimm<-(snowad.rep[[1]]$"Predicted proportion survey immature new female" + snowad.rep[[1]]$"Predicted proportion survey immature old female")[,-1]
Fi<-apply(tempFimm,1,sum)
tempFmat<-(snowad.rep[[1]]$"Predicted proportion survey mature new female" + snowad.rep[[1]]$"Predicted proportion survey mature old female")[,-1]
FM<-apply(tempFmat,1,sum)
tempMimm<-(snowad.rep[[1]]$"Predicted proportion survey immature new male" + snowad.rep[[1]]$"Predicted proportion survey immature old male")[,-1]
Mi<-apply(tempMimm,1,sum)
tempMmat<-(snowad.rep[[1]]$"Predicted proportion survey mature new male" + snowad.rep[[1]]$"Predicted proportion survey mature old male")[,-1]
MM<-apply(tempMmat,1,sum)

 par(mfrow=c(3,2),mar=c(.1,.1,.1,.1),oma=c(4,6,2,1))
 for(x in c(1,2,5,6,7,8))
  {
   plot(snowad.rep[[1]]$"Observed Lbar"[x,]~SurveyYrs, pch=16,col=1,las=1,ylim=c(20,100),xaxt='n',yaxt='n')
   if(x==7 | x==1 |x==5)
     axis(side=2,las=1)
 
   if(x==7 | x==8)
     axis(side=1)
  for(y in 1:length(Scenarios))
  {
   inputPreds<-rbind(snowad.rep[[y]]$"Predicted Lbar new shell",snowad.rep[[y]]$"Predicted Lbar old shell")
   if(length(inputPreds)>0)
   {
     inputPreds<-inputPreds[c(1,2,5,6,3,4,7,8),]
     lines(inputPreds[x,]~SurveyYrs,lty=y)
   }
  }
 } 
 mtext(outer=T,side=2,"Average size (mm)",line=2.5,adj=.5)
 mtext(outer=T,side=3,adj=.25,"Females")
 mtext(outer=T,side=3,adj=.75,"Males")
 mtext(outer=T,side=1,"Year",line=2)
 mtext(outer=TRUE,side=2,adj=.1,"New shell immature",line=4)
 mtext(outer=TRUE,side=2,adj=.5,"New shell mature",line=4)
 mtext(outer=TRUE,side=2,adj=.9,"Old shell mature",line=4)
 legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{catchcomps}Model fits to retained catch proportion at length data"}
#==this sucks, butwriting a function to do this has too many moving parts....
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion fishery retained new male" + snowad.rep[[x]]$"Predicted proportion fishery retained old male"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion fishery retained old male" 

PlotLenProps(obs =(snowad.rep[[1]]$"Observed proportion fishery retained new male" +snowad.rep[[1]]$"Observed proportion fishery retained old male")[,-1],
             #obs2=snowad.rep[[1]]$"Observed proportion fishery retained old male"[,-1],
             pred =inPred,
             #pred2=inPred2,
             inYears = SurveyYrs,
             xquant = LengthBins,
             chopX = 140,
             chopY = 0.25,
             pointsize = .7,
             XaxisN = 7,
             YaxisN = 7)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Males","New shell","Old shell"),bty='n')
             plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
 
#==these are fit added together, but when split, the fit is really crummy             
# inPred<-rep(list(list()),length(Scenarios))
# for(x in 1:length(Scenarios))
#   inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion fishery retained new male" 
# 
# inPred2<-rep(list(list()),length(Scenarios))
# for(x in 1:length(Scenarios))
#   inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion fishery retained old male" 
# 
# PlotLenProps(obs =snowad.rep[[1]]$"Observed proportion fishery retained new male" [,-1],
#              obs2=snowad.rep[[1]]$"Observed proportion fishery retained old male"[,-1],
#              pred =inPred,
#              pred2=inPred2,
#              inYears = SurveyYrs,
#              xquant = LengthBins,
#              chopX = 140,
#              chopY = 0.25,
#              pointsize = .7,
#              XaxisN = 7,
#              YaxisN = 7)
#              plot.new()
#              legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Males","New shell","Old shell"),bty='n')
#              plot.new()
#              legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')            

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=10,fig.cap="\\label{trawlcomps}Model fits to trawl catch proportion at length data"}

#==these are fit added together, but when split, the fit is really crummy             
inPred<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred[[x]]<-snowad.rep[[x]]$"Predicted proportion trawl male"

inPred2<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  inPred2[[x]]<-snowad.rep[[x]]$"Predicted proportion trawl female"

PlotLenProps(obs =snowad.rep[[1]]$"Observed proportion trawl male" [,-1],
             obs2=snowad.rep[[1]]$"Observed proportion trawl female"[,-1],
             pred =inPred,
             pred2=inPred2,
             inYears = SurveyYrs[(SurvYrN-TrawlYrN):(SurvYrN-1)],
             xquant = LengthBins,
             chopX = 140,
             chopY = 0.25,
             pointsize = .7,
             XaxisN = 6,
             YaxisN = 6,
             addRow = 1)
             plot.new()
             legend("center",pch=c(NA,15,16),col=c(NA,1,2),legend=c("Males","New shell","Old shell"),bty='n')
             plot.new()
             legend("center",lty=seq(1,length(Scenarios)),legend=Scenarios,bty='n')
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="Residuals for fits to immature male survey proportion at length data"}
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))
tempInObs<-snowad.rep[[1]]$"Observed proportion survey immature new male" + snowad.rep[[1]]$"Observed proportion survey immature old male"
tempInPred<-snowad.rep[[1]]$"Predicted proportion survey immature new male" + snowad.rep[[1]]$"Predicted proportion survey immature old male"
tempInObs[,1]<-tempInObs[,1]/2
tempInPred[,1]<-tempInPred[,1]/2
plot.bubble.fun(datao=,tempInObs,datap=tempInPred,nlen=22,sampsize=rep(200,12),maxres=10)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{predmmb}Model predicted mature male biomass at mating time"}
#=========================================================
#  Plot derived quantities
#=========================================================
# estimated male, female, mature male, total and effective mature biomass (indicate proxy bmsy)
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"Mature male biomass at mating"[1:(SurvYrN-1)]~SurveyYrs[-SurvYrN],type="l",ylim=c(0,550),las=1,xaxt='n')
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"Mature male biomass at mating"[1:(SurvYrN-1)]~SurveyYrs[-SurvYrN],type="l",lty=x)
legend("topleft",bty='n',"Males")

plot(snowad.rep[[1]]$"Mating time Female Spawning Biomass"[1:(SurvYrN-1)]~SurveyYrs[-SurvYrN],type="l",ylim=c(0,550),las=1)
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"Mating time Female Spawning Biomass"[1:(SurvYrN-1)]~SurveyYrs[-SurvYrN],type="l",lty=x)
legend("topleft",bty='n',"Females")
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=9,fig.cap="\\label{predfmort}Model predicted fishing mortalities and selectivities for all sources of mortality"}
## estimated quanties
# fishing mortality and fishery selectivities
par(mfrow=c(3,2),mar=c(.1,.1,.3,.1),oma=c(4,5,2,4))
plot(snowad.rep[[1]]$"estimated annual total fishing mortality"~RetCatchYrs, type="l",las=1,xaxt='n',xlim=c(min(RetCatchYrs),max(RetCatchYrs)),ylim=c(0,4))
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual total fishing mortality"~RetCatchYrs,lty=x)
legend("topright",bty='n',"Directed")

plot(snowad.rep[[1]]$"selectivity fishery retained old male"[1,]~LengthBins,type='l',yaxt='n',xaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity fishery retained old male"[1,]~LengthBins,lty=x)
axis(side=4,las=1)
for(x in 1:length(Scenarios))
  {
   lines(snowad.rep[[x]]$ "selectivity fishery total new male"[1,]~LengthBins,lty=x,col=2) 
   lines(snowad.rep[[x]]$ "retention curve new male" ~LengthBins,lty=x,col=3) 
   }
legend("topleft",lty=c(1,2),bty='n',c("Total","Retained")) ## CHANGE THIS

 
plot(snowad.rep[[1]]$"estimated annual fishing mortality trawl bycatch"~RetCatchYrs,type="l",las=1,xaxt='n',xlim=c(min(RetCatchYrs),max(RetCatchYrs)))
legend("topright",bty='n',"Trawl")
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual fishing mortality trawl bycatch"~RetCatchYrs,lty=x)
plot(snowad.rep[[1]]$"selectivity trawl female"~LengthBins,type='l',yaxt='n',xaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity trawl female"~LengthBins,lty=x)
axis(side=4,las=1)
legend("topleft",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

plot(snowad.rep[[1]]$"estimated annual fishing mortality females pot"~RetCatchYrs, type="l",las=1,xlim=c(min(RetCatchYrs),max(RetCatchYrs)))
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"estimated annual fishing mortality females pot"~RetCatchYrs,lty=x)
legend("topleft",bty='n',"Female discard")
plot(snowad.rep[[1]]$"selectivity discard female"[1,]~LengthBins,type='l',yaxt='n')
for(x in 2:length(Scenarios))
  lines(snowad.rep[[x]]$"selectivity discard female"[1,]~LengthBins,lty=x)
axis(side=4,las=1)

mtext(side=2,outer=T,expression(y^-1),line=3.25)
mtext(side=4,outer=T,"Probability",line=2.5)
mtext(side=3,outer=T,"Estimated fishing mortality",adj=.1)
mtext(side=3,outer=T,"Selectivity",adj=.8)
mtext(side=1,outer=T,"Year",adj=.2,line=2)
mtext(side=1,outer=T,"Length (mm)",adj=.8,line=2)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{predselect}Estimated survey selectivity"}
#=========================================================
# survey selectivities, molting probability, weight at length
#=======================================================
par(mfrow=c(3,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"selectivity survey female Era 1"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 1"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 1"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}

legend("topleft",legend=c("1978-1981"),bty='n')
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

plot(snowad.rep[[1]]$"selectivity survey female Era 2"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 2"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 2"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",legend=c("1982-1988"),bty='n')
legend("bottomright",col=c(2,4),legend=c("Female","Male"),bty='n',pch=16)


plot(snowad.rep[[1]]$"selectivity survey female Era 3"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="")
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity survey female Era 3"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity survey male Era 3"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",legend=c("1989-present"),bty='n')
mtext(side=1,"Length (mm)",line=2)
mtext(side=2,"Survey selectivity",line=2.5,outer=T)



# observed numbers experimental surveys
SurveyExpmntData09<-matrix(ncol=length(LengthBins),nrow=8)
TakeSeq<-c(2,4,6,8,11,13,15,17)
tmp<-grep("BSFRF",DATfile)[2]
for(t in 1:length(TakeSeq))
  SurveyExpmntData09[t,]<-as.numeric(unlist(strsplit(DATfile[(tmp+TakeSeq[t])],split="\t")))

SurveyExpmntData10<-matrix(ncol=length(LengthBins),nrow=8)
tmp<-grep("BSFRF",DATfile)[5]
for(t in 1:length(TakeSeq))
  SurveyExpmntData10[t,]<-as.numeric(unlist(strsplit(DATfile[(tmp+TakeSeq[t])],split="\t")))

DatNames<-c("FemImmInd","FemMatInd","MalImmInd","MalMatInd","FemImmNmfs","FemMatNmfs","MalImmNmfs","MalMatNmfs")

points((SurveyExpmntData09[5:6,]/(SurveyExpmntData09[1:2,]))~matrix(rep(LengthBins,2),nrow=2,byrow=T),pch=16,col="#ff000088")
points((SurveyExpmntData09[7:8,]/(SurveyExpmntData09[3:4,]))~matrix(rep(LengthBins,2),nrow=2,byrow=T),pch=16,col="#0000ff88")
points((SurveyExpmntData10[5,]/(SurveyExpmntData10[1,]))~LengthBins,pch=16,col="#ff000088")
points((SurveyExpmntData10[7,]/(SurveyExpmntData10[3,]))~LengthBins,pch=16,col="#0000ff88")

in09<-SurveyExpmntData10[5:8,]/(SurveyExpmntData10[1:4,])
in10<-SurveyExpmntData09[5:8,]/(SurveyExpmntData09[1:4,])
in09[in09=="NaN"]<- -1
in10[in10=="NaN"]<- -1
#write.csv(in10,"C:/Users/Cody/Desktop/10dat.csv")
#write.csv(in09,"C:/Users/Cody/Desktop/09dat.csv")


```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{predBSFRF}Estimated experimental survey selectivity"}
#=========================================================
# BSFRF survey selectivities, molting probability, weight at length
#=======================================================
par(mfrow=c(2,2),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"selectivity industry survey females 2009"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity industry survey females 2009"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity industry survey males 2009"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",col=c(4,2),legend=c("Male","Female"),bty='n',lty=1)
# points((SurveyExpmntData09[5:8,]/(SurveyExpmntData09[1:4,]+SurveyExpmntData09[5:8,]))~matrix(rep(LengthBins,4),nrow=4,byrow=T),pch=16,col="#cfcfcf88")

plot(snowad.rep[[1]]$"selectivity industry survey females 2010"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n', yaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity industry survey females 2010"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity industry survey males 2010"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
# points((SurveyExpmntData10[5:8,]/(SurveyExpmntData10[1:4,]+SurveyExpmntData10[5:8,]))~matrix(rep(LengthBins,4),nrow=4,byrow=T),pch=16,col="#cfcfcf88")

plot(snowad.rep[[1]]$"selectivity nmfs industry survey females 2009"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="")
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity nmfs industry survey females 2009"~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity nmfs industry survey males 2009"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
# points((SurveyExpmntData09[5:8,]/(SurveyExpmntData09[1:4,]+SurveyExpmntData09[5:8,]))~matrix(rep(LengthBins,4),nrow=4,byrow=T),pch=16,col="#cfcfcf88")

plot(snowad.rep[[1]]$"selectivity nmfs industry survey females 2010"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",yaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"selectivity nmfs industry survey females 2010" ~LengthBins,col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"selectivity nmfs industry survey males 2010"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
# points((SurveyExpmntData10[5:8,]/(SurveyExpmntData10[1:4,]+SurveyExpmntData10[5:8,]))~matrix(rep(LengthBins,4),nrow=4,byrow=T),pch=16,col="#cfcfcf88")
mtext(outer=t,side=2,adj=.2,"NMFS",line=2.5)
mtext(outer=t,side=2,adj=.8,"Industry",line=2.5)
mtext(outer=t,side=3,adj=.2,2009)
mtext(outer=t,side=3,adj=.8,2010)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=6,fig.cap="\\label{predmat}Predicted probability of maturity"}

# molting probabillities, weight at length
par(mfrow=c(1,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
#DATfile
plot(snowad.rep[[1]]$"Predicted probability of maturing female"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
for(x in 1:length(Scenarios))
{
lines(snowad.rep[[x]]$"Predicted probability of maturing female"~LengthBins, col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
lines(snowad.rep[[x]]$"Predicted probability of maturing male"~LengthBins,col=4,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
}
legend("topleft",col=c(4,2),legend=c("Female","Male"),bty='n',pch=16)
legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)


# plot(snowad.rep[[1]]$"Molting probability female"~LengthBins,type='l',ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n')
# for(x in 1:length(Scenarios))
# {
# lines(snowad.rep[[1]]$"Molting probability femal"~LengthBins, col=2,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
# lines(snowad.rep[[1]]$"Molting probability male"~LengthBins,ylim=c(0,1),ylab='',las=1,xlab="",xaxt='n',lty=x)
# }
# legend("bottomleft",col=c(1,2),legend=c("Female","Male"),"Molting",bty='n')
# legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=7,fig.cap="\\label{Kobe}Kobe plot for the chosen model"}
# estimated fishing mortality vs estimated spawning stock biomass (kobe plot)
par(mfrow=c(1,1),mar=c(4,4,1,1),oma=c(0,0,0,0))
plot(-100000,type="l",las=1,
     ylim=c(0,max(snowad.rep[[1]]$"estimated annual total fishing mortality")),
     xlim=c(0,max(snowad.rep[[1]]$"Mature male biomass at mating"[1:CatchYrN])),
     ylab="",xlab="")
text(labels=RetCatchYrs, y=snowad.rep[[1]]$"estimated annual total fishing mortality",x=snowad.rep[[1]]$"Mature male biomass at mating"[1:CatchYrN],cex=.5)
mtext(side=1,"Mature male biomass at mating (t)",line=2)
mtext(side=2,"Fully-selected fishing mortality",line=2.3)
# abline(h=F35,lty=2)
# abline(v=B35,lty=2)
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=6,fig.height=9,fig.cap="\\label{recruits}Estimated recruitment, fits to stcok recruit curve (MMB lagged 4 years), and estimated proportions recruiting to length bin"}
# fit of stock recruitment relationship
par(mfrow=c(3,1),mar=c(4,4,1,1),oma=c(1,2,1,1))
LagRecs<-4

plot(snowad.rep[[1]]$"estimated number of recruits female"/10000~SurveyYrs[1:length(SurveyYrs)-1],ylab="",type="l",las=1,xlab="")
 mtext(side=1,"Year",line=3)
 mtext(side=2,"Recruits (10000)",line=3)

if(length(Scenarios)>1)
for(y in 2:length(Scenarios))
 lines(snowad.rep[[y]]$"estimated number of recruits female"/10000~SurveyYrs[1:length(SurveyYrs)-1],lty=y)

 Recruits<-matrix(ncol=(CatchYrN-LagRecs+1),nrow=length(Scenarios))
 inMMB<-matrix(ncol=(CatchYrN-LagRecs+1),nrow=length(Scenarios))
 
 for(y in 1:length(Scenarios))
{
Recruits[y,]<-snowad.rep[[y]]$"estimated number of recruits female"[LagRecs:length(snowad.rep[[y]]$"estimated number of recruits female")]
inMMB[y,]<-snowad.rep[[y]]$"Mature male biomass at mating"[1:(CatchYrN-LagRecs+1)]
 }
 
 plot(Recruits[1,]~inMMB[1,],
     ylab="",xlab="",
     ylim=c(0,max(Recruits)),
     xlim=c(0,max(inMMB)),
     las=1,pch=16)
mtext(side=1,"Mature male biomass (t)",line=3)
mtext(side=2,"Recruits (10000)",line=3)

for(y in 2:length(Scenarios))
   points(Recruits[y,]~inMMB[y,],col=y,pch=16)

legend("topright",bty='n',col=seq(1,length(Scenarios)),pch=16,legend=Scenarios)

#==fit a stock recruit relationship
Ricker<-function(x,SpBio,Rec)
{
  alpha<-abs(x[1])
  beta<-abs(x[2])
  sigma<-abs(x[3])
  Pred<-SpBio*exp(alpha-beta*SpBio)
  loglike<- log(1/(sqrt(2*3.1415*sigma^2))) - ((log(Pred)-log(Rec))^2)/(2*sigma^2)
  return(sum(-1*loglike))
}

for(y in 1:length(Scenarios))
{
x<-c(1,1,0.5)
outs<-nlminb(x,Ricker,SpBio=inMMB[y,],Rec=Recruits[y,])
x<-outs$par
  alpha<-abs(x[1])
  beta<-abs(x[2])
  sigma<-abs(x[3])
  plotSpbio<-seq(1,max(inMMB),10)
  Pred<-plotSpbio*exp(alpha-beta*plotSpbio)
  lines(Pred~plotSpbio,lty=y)
}

for(y in 1:length(Scenarios))
{
  if(y==1)
 {
  plot(snowad.rep[[y]]$"distribution of recruits to length bins"~LengthBins,yaxt='n',type='l',xlab="",ylab='n')
  axis(side=2,las=1)
  mtext(side=1,"Length (mm)",line=3)
  mtext(side=4,line=2.5,"Proportion recruiting")
 }
 if(y>1)
  lines(snowad.rep[[y]]$"distribution of recruits to length bins"~LengthBins,lty=y)
}
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)


```  
    
\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=9,fig.cap="\\label{catchratio]Model predicted ratio of catch to mature male biomass"}
#=========================================================
#  Plot derived quantities
#=========================================================
# estimated male, female, mature male, total and effective mature biomass (indicate proxy bmsy)
par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
plot(snowad.rep[[1]]$"estimated total catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs, type="l",ylim=c(0,.6),las=1,xaxt='n')
legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
legend("topleft",bty='n',"Total catch")
for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"estimated total catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs,type="l",lty=x)

plot(snowad.rep[[1]]$"estimated retained catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs, type="l",ylim=c(0,.6),las=1)

for(x in 2:length(Scenarios))
lines(snowad.rep[[x]]$"estimated retained catch div by male spawning biomass at fishtime"[1:SurvYrN]~SurveyYrs,type="l",lty=x)
legend("topleft",bty='n',"Retained catch")
mtext(outer=T,side=2,"Proportion",line=2.5)
```
  
  \newpage
  
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=6,fig.cap="\\label{retro}Retrospective pattern in MMB for chosen model"}
retro<-0
Chosen<-"Model 2a MatPrior_200"

if(retro==1)
{
  RetroN<-4

  # pull out MMB (or other quantities)
  RetroMMB<-matrix(ncol=length(SurveyYrs)-1,nrow=RetroN+1)
  REPfile <-readLines(paste(TakeDir,Chosen,"/2016sc.REP",sep=""))
  tmp<-grep("male spawning biomass at matetime",REPfile)[2]
  tmpMMB<-as.numeric(unlist(strsplit(REPfile[tmp+1]," ")))
  RetroMMB[1,]<-tmpMMB[!is.na(tmpMMB)]
  for(x in 1:RetroN)
  { 
    REPfile <-readLines(paste(TakeDir,Chosen,"/Retro_",x,"/2016sc.REP",sep=""))
    tmp<-grep("male spawning biomass at matetime",REPfile)[2]
    tmpMMB<-as.numeric(unlist(strsplit(REPfile[tmp+1]," ")))
    tmpMMB<-tmpMMB[!is.na(tmpMMB)]
    for(y in 1:(length(tmpMMB)-x))
      RetroMMB[x+1,y]<-tmpMMB[y]
  }
  
  # plot quantities
  plot(RetroMMB[1,]~SurveyYrs[-length(SurveyYrs)],type="l",las=1,ylab='MMB (t)',xlab="Year")
  for(x in 2:nrow(RetroMMB))
    lines(RetroMMB[x,]~SurveyYrs[-length(SurveyYrs)],col=x)
}
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="\\label{OFLposterior}Posterior densities for management quantities by scenario"}

  PlotMCMC<-function(input,inputY=1,colrep=10,inLabel=NA,inLegend=0,transp=1,inPoly=0)
  {
   Densities<-lapply(input,density)
   xlim <- range(input)
   ylim <- range(0,inputY)
   inCol<-rep(topo.colors(colrep,alpha=transp),ceiling(length(input)/colrep))
   plot(Densities[[1]], xlim = xlim, ylim = ylim, xlab='inLabel',
     main = '',col=inCol[1],las=1,yaxt='n',bty='n') 
   for(x in 2:length(Densities))
    lines(Densities[[x]],col=inCol[x]) 

   if(inPoly>0)
   {
     for(x in 1:length(Densities))
        polygon(Densities[[x]], density = -1, col = inCol[x],border=F)  
   }

   medians<-lapply(input,median)
   for(x in 1:length(medians))
    abline(v=unlist(medians)[[x]],col=inCol[x])
   if(inLegend>0)
    legend('topright',legend=ScenarioNames,col = inCol, bty = 'n', pch=15,cex=1.5)
   legend("topleft",bty='n',inLabel)
  }

  par(mfrow=c(3,2),mar=c(3,.1,.1,.1),oma=c(2,2,1,1))
  chooseCol<-8
  inPoly<-1
  PlotMCMC(OFL,inputY=0.22,colrep=chooseCol,inLabel="OFL",inPoly=inPoly,trans=.3)
  PlotMCMC(MMB,inputY=0.12,colrep=chooseCol,inLabel="MMB",inPoly=inPoly,trans=.3)
  PlotMCMC(B35,inputY=0.12,colrep=chooseCol,inLabel=expression(B[35]),inPoly=inPoly,trans=.3)
  PlotMCMC(Status,inputY=15,colrep=chooseCol,inLabel="Status",inPoly=inPoly,trans=.3)
  PlotMCMC(F35,inputY=2,colrep=chooseCol,inLabel=expression(F[35]),inPoly=inPoly,trans=.3)
  PlotMCMC(FOFL,inputY=3,colrep=chooseCol,inLabel=expression(F[OFL]),inPoly=inPoly,trans=.3,inLegend=1)  
  
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10.5,fig.cap="\\label{posteriorpar1}Posterior densities for estimated parameters by scenario"}

corrFiles<-rep(list(list()),length(Scenarios))
for(x in 1:length(Scenarios))
  corrFiles[[x]]     <-readLines(paste(TakeDir,Scenarios[x],"/2016sc.cor",sep=""),skip=1)

VariableNames<-rep(list(list()),length(Scenarios))
for(y in 1:length(Scenarios))
{
  inCor<-corrFiles[[y]]
  for(x in 1:length(inCor))
  {
   temp<-unlist(strsplit((inCor[x+2]),split=" "))
   if(x<10)
   VariableNames[[y]][x]<-temp[9]
   if(x>=10&x<100)
    VariableNames[[y]][x]<-temp[8]
   if(x>=100 & x <1000)
    VariableNames[[y]][x]<-temp[7]
   if(x>=1000)
    VariableNames[[y]][x]<-temp[6]
  }
}
    
inCol<-rep(topo.colors(chooseCol,alpha=0.3),ceiling(length(MCMCpars)/chooseCol))
counter<-0
sqRow<-3
par(mfrow=c(5,3),mar=c(3,1,0,.5))

# 31, 53, 69, 87
for(y in 1:32)
 {
  if(ParsAndSymbols$Include[y]>0 & ParsAndSymbols$Estimated[y]>0)
  { 
   tempPars<-rep(list(list()),length(Scenarios)) 
   for(z in 1:length(Scenarios))
   {
   takeInd<-which(VariableNames[[z]]==ParsAndSymbols$Parameter[y])
   tempPars[[z]]<-MCMCpars[[z]][,takeInd]
   }
   
   takers<-which(lapply(tempPars,length)!=0)
   intempPars<-tempPars[takers]
   if(length(intempPars)>0)
   { 
    # this is for single parameters
   if(length(intempPars[[1]])==MCMCreps)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
      {
       Densities<-density(unlist(intempPars))
       xlim <- range(intempPars)
       ylim <- range(Densities$y)
       plot(Densities, xlim = xlim, ylim = ylim, xlab='',
        main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
      if(inPoly>0)
        polygon(Densities, density = -1, col = inCol[takers],border=F) 
      abline(v=median(unlist(intempPars)),col=inCol[takers])
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
      } 
        
      
    if(length(intempPars)>1)
    {
      Densities<-lapply(intempPars,density)
      xlim <- range(intempPars)
      tmpRng<-NULL
     for(z in 1:length(intempPars))
      tmpRng<-append(tmpRng,range(Densities[[z]]$y)) 
      ylim<-c(0,max(tmpRng,na.rm=T))
   
    plot(Densities[[1]], xlim = xlim, ylim = ylim, xlab='',
     main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
    for(x in 2:length(Densities))
     lines(Densities[[x]],col=inCol[takers[x]]) 
    if(inPoly>0)
    {
     for(x in 1:length(Densities))
      polygon(Densities[[x]], density = -1, col = inCol[x],border=F)  
    }
    
    medians<-lapply(tempPars,median)
    for(x in 1:length(medians))
     abline(v=unlist(medians)[[x]],col=inCol[x])
    legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
   }
   
   }
   
   if(length(takeInd)>1) # this checks for parameters that are vectors (like F devs)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
     {
      boxplot(intempPars,col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
     } 
   if(length(intempPars)>1)
    {    
     boxplot(intempPars[[1]],col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
     for(z in 2:length(MCMCpars))
      boxplot(intempPars[[1]],col=inCol[takers[z]],add=T,las=1,bty='n',frame=F,alpha=.3,outline=F)
     legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
    }

   }
 }
}
}
 
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10.5,fig.cap="\\label{posteriorpar2}Posterior densities for estimated parameters by scenario"}

par(mfrow=c(5,3),mar=c(3,1,0,.5))

# 31, 53, 69, 87
for(y in 33:61)
 {
  if(ParsAndSymbols$Include[y]>0 & ParsAndSymbols$Estimated[y]>0)
  { 
   tempPars<-rep(list(list()),length(Scenarios)) 
   for(z in 1:length(Scenarios))
   {
   takeInd<-which(VariableNames[[z]]==ParsAndSymbols$Parameter[y])
   tempPars[[z]]<-MCMCpars[[z]][,takeInd]
   }
   
   takers<-which(lapply(tempPars,length)!=0)
   intempPars<-tempPars[takers]
   if(length(intempPars)>0)
   { 
    # this is for single parameters
   if(length(intempPars[[1]])==MCMCreps)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
      {
       Densities<-density(unlist(intempPars))
       xlim <- range(intempPars)
       ylim <- range(Densities$y)
       plot(Densities, xlim = xlim, ylim = ylim, xlab='',
        main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
      if(inPoly>0)
        polygon(Densities, density = -1, col = inCol[takers],border=F) 
      abline(v=median(unlist(intempPars)),col=inCol[takers])
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
      } 
        
      
    if(length(intempPars)>1)
    {
      Densities<-lapply(intempPars,density)
      xlim <- range(intempPars)
      tmpRng<-NULL
     for(z in 1:length(intempPars))
      tmpRng<-append(tmpRng,range(Densities[[z]]$y)) 
      ylim<-c(0,max(tmpRng,na.rm=T))
   
    plot(Densities[[1]], xlim = xlim, ylim = ylim, xlab='',
     main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
    for(x in 2:length(Densities))
     lines(Densities[[x]],col=inCol[takers[x]]) 
    if(inPoly>0)
    {
     for(x in 1:length(Densities))
      polygon(Densities[[x]], density = -1, col = inCol[x],border=F)  
    }
    
    medians<-lapply(tempPars,median)
    for(x in 1:length(medians))
     abline(v=unlist(medians)[[x]],col=inCol[x])
    legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
   }
   
   }
   
   if(length(takeInd)>1) # this checks for parameters that are vectors (like F devs)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
     {
      boxplot(intempPars,col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
     } 
   if(length(intempPars)>1)
    {    
     boxplot(intempPars[[1]],col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
     for(z in 2:length(MCMCpars))
      boxplot(intempPars[[1]],col=inCol[takers[z]],add=T,las=1,bty='n',frame=F,alpha=.3,outline=F)
     legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
    }

   }
 }
}
}
 
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10.5,fig.cap="\\label{posteriorpar3}Posterior densities for estimated parameters by scenario"}

par(mfrow=c(5,3),mar=c(3,1,0,.5))

for(y in 61:75)
 {
  if(ParsAndSymbols$Include[y]>0 & ParsAndSymbols$Estimated[y]>0)
  { 
   tempPars<-rep(list(list()),length(Scenarios)) 
   for(z in 1:length(Scenarios))
   {
   takeInd<-which(VariableNames[[z]]==ParsAndSymbols$Parameter[y])
   tempPars[[z]]<-MCMCpars[[z]][,takeInd]
   }
   
   takers<-which(lapply(tempPars,length)!=0)
   intempPars<-tempPars[takers]
   if(length(intempPars)>0)
   { 
    # this is for single parameters
   if(length(intempPars[[1]])==MCMCreps)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
      {
       Densities<-density(unlist(intempPars))
       xlim <- range(intempPars)
       ylim <- range(Densities$y)
       plot(Densities, xlim = xlim, ylim = ylim, xlab='',
        main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
      if(inPoly>0)
        polygon(Densities, density = -1, col = inCol[takers],border=F) 
      abline(v=median(unlist(intempPars)),col=inCol[takers])
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
      } 
        
      
    if(length(intempPars)>1)
    {
      Densities<-lapply(intempPars,density)
      xlim <- range(intempPars)
      tmpRng<-NULL
     for(z in 1:length(intempPars))
      tmpRng<-append(tmpRng,range(Densities[[z]]$y)) 
      ylim<-c(0,max(tmpRng,na.rm=T))
   
    plot(Densities[[1]], xlim = xlim, ylim = ylim, xlab='',
     main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
    for(x in 2:length(Densities))
     lines(Densities[[x]],col=inCol[takers[x]]) 
    if(inPoly>0)
    {
     for(x in 1:length(Densities))
      polygon(Densities[[x]], density = -1, col = inCol[x],border=F)  
    }
    
    medians<-lapply(tempPars,median)
    for(x in 1:length(medians))
     abline(v=unlist(medians)[[x]],col=inCol[x])
    legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
   }
   
   }
   
   if(length(takeInd)>1) # this checks for parameters that are vectors (like F devs)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
     {
      boxplot(intempPars,col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
     } 
   if(length(intempPars)>1)
    {    
     boxplot(intempPars[[1]],col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
     for(z in 2:length(MCMCpars))
      boxplot(intempPars[[1]],col=inCol[takers[z]],add=T,las=1,bty='n',frame=F,alpha=.3,outline=F)
     legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
    }

   }
 }
}
}
 
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10.5,fig.cap="\\label{posteriorpar4}Posterior densities for estimated parameters by scenario"}

par(mfrow=c(5,3),mar=c(3,1,0,.5))

for(y in 76:87)
 {
  if(ParsAndSymbols$Include[y]>0 & ParsAndSymbols$Estimated[y]>0)
  { 
   tempPars<-rep(list(list()),length(Scenarios)) 
   for(z in 1:length(Scenarios))
   {
   takeInd<-which(VariableNames[[z]]==ParsAndSymbols$Parameter[y])
   tempPars[[z]]<-MCMCpars[[z]][,takeInd]
   }
   
   takers<-which(lapply(tempPars,length)!=0)
   intempPars<-tempPars[takers]
   if(length(intempPars)>0)
   { 
    # this is for single parameters
   if(length(intempPars[[1]])==MCMCreps)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
      {
       Densities<-density(unlist(intempPars))
       xlim <- range(intempPars)
       ylim <- range(Densities$y)
       plot(Densities, xlim = xlim, ylim = ylim, xlab='',
        main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
      if(inPoly>0)
        polygon(Densities, density = -1, col = inCol[takers],border=F) 
      abline(v=median(unlist(intempPars)),col=inCol[takers])
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
      } 
        
      
    if(length(intempPars)>1)
    {
      Densities<-lapply(intempPars,density)
      xlim <- range(intempPars)
      tmpRng<-NULL
     for(z in 1:length(intempPars))
      tmpRng<-append(tmpRng,range(Densities[[z]]$y)) 
      ylim<-c(0,max(tmpRng,na.rm=T))
   
    plot(Densities[[1]], xlim = xlim, ylim = ylim, xlab='',
     main = '',col=inCol[takers[1]],las=1,yaxt='n',bty='n') 
    for(x in 2:length(Densities))
     lines(Densities[[x]],col=inCol[takers[x]]) 
    if(inPoly>0)
    {
     for(x in 1:length(Densities))
      polygon(Densities[[x]], density = -1, col = inCol[x],border=F)  
    }
    
    medians<-lapply(tempPars,median)
    for(x in 1:length(medians))
     abline(v=unlist(medians)[[x]],col=inCol[x])
    legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
   }
   
   }
   
   if(length(takeInd)>1) # this checks for parameters that are vectors (like F devs)
   {
    if(length(intempPars)==1) # this checks to see if only a single scenario estimates that parameter
     {
      boxplot(intempPars,col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
      legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
     } 
   if(length(intempPars)>1)
    {    
     boxplot(intempPars[[1]],col=inCol[takers[1]],las=1,bty='n',frame=F,alpha=.3,outline=F)
     for(z in 2:length(MCMCpars))
      boxplot(intempPars[[1]],col=inCol[takers[z]],add=T,las=1,bty='n',frame=F,alpha=.3,outline=F)
     legend("topleft",bty='n',legend=ParsAndSymbols$Parameter[y])
    }

   }
 }
}
}
 
```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=6.5,fig.height=6,fig.cap="Model fits to the observed mature biomass at survey"}
  # ##=======FITS TO THE DATA SOURCES=========================
  # #==mature male biomass==============
  # mcmcMMBsrv<-matrix(nrow=length(useEval),ncol=(SurvYrN))
  # mcmcMFBsrv<-matrix(nrow=length(useEval),ncol=(SurvYrN))
  # 
  # for(x in 1:length(useEval))
  # {
  #   mcmcMFBsrv[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][2]),split=" ")))[2:(SurvYrN+1)]
  #   mcmcMMBsrv[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][3]),split=" ")))[2:(SurvYrN+1)]
  # }
  # 
  # par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
  # plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,
  #      pch=20,ylab="Mature Male Biomass (1000 t)",
  #      xlab="Year",las=1,ylim=c(0,600),
  #      xaxt='n');
  # 
  # sortQuant<-apply(mcmcMMBsrv,2,sort)
  # TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
  # 
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
  # points(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20)
  # 
  # for(j in 1:length(SurveyYrs))
  # {
  #   segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
  #            y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j],
  #            y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[2,]^2)))[j])
  # }
  # 
  # #==mature female biomass==============
  # plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20,ylab="Mature Female Biomass (1000 t)",xlab="Year",las=1,ylim=c(0,700));
  # 
  # sortQuant<-apply(mcmcMFBsrv,2,sort)
  # TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
  # 
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
  # points(as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20)
  # for(j in 1:length(SurveyYrs))
  # {
  #   segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
  #            y0=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j]  /   exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j],
  #            y1=as.numeric(unlist(snowad.rep[[1]]$"Observed survey female spawning biomass"))[j] * exp(1.96*sqrt(log(1+snowad.rep[[1]]$"survey CV"[1,]^2)))[j])
  # }
  
  
```
  
  \newpage
  
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=8,fig.cap="Model fits to the growth data"}
  
  # #==mature male biomass==============
  # femGrowth<-matrix(nrow=length(useEval),ncol=(SurvYrN))
  # maleGrowth<-matrix(nrow=length(useEval),ncol=(SurvYrN))
  # 
  # for(x in 1:length(useEval))
  # {
  #   mcmcMFBsrv[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][2]),split=" ")))[2:(SurvYrN+1)]
  #   mcmcMMBsrv[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][3]),split=" ")))[2:(SurvYrN+1)]
  # }
  # 
  # par(mfrow=c(2,1),mar=c(.1,.1,.3,.1),oma=c(4,4,1,1))
  # plot(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,
  #      pch=20,ylab="Mature Male Biomass (1000 t)",
  #      xlab="Year",las=1,ylim=c(0,600),
  #      xaxt='n');
  # 
  # sortQuant<-apply(mcmcMMBsrv,2,sort)
  # TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
  # 
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
  # polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
  # points(as.numeric(unlist(snowad.rep[[1]]$"Observed survey male spawning biomass"))[1:SurvYrN]~SurveyYrs,pch=20)
  # 
  # #==Growth data
  # flength <- (snowad.rep[[1]]$"af"+snowad.rep[[1]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
  #   (snowad.rep[[1]]$"af2"+snowad.rep[[1]]$"bf1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");
  # mlength <- (snowad.rep[[1]]$"am"+snowad.rep[[1]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr"))+
  #   (snowad.rep[[1]]$"am2"+snowad.rep[[1]]$"b1"*(20:135))*pnorm(((20:135)-snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr");
  # 
  # flength<-rep(list(list()),length(Scenarios))
  # mlength<-rep(list(list()),length(Scenarios))
  # for(x in 1:length(Scenarios))
  # {
  #   tempF<-(snowad.rep[[x]]$"af"+snowad.rep[[x]]$"bf"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[x]]$"delta male") / snowad.rep[[x]]$"st_gr")) + (snowad.rep[[x]]$"af2"+snowad.rep[[x]]$"bf1"*(20:135))*pnorm(((20:135) -snowad.rep[[x]]$"delta male")/snowad.rep[[x]]$"st_gr")
  #   flength[[x]]<-tempF
  #   tempM<-(snowad.rep[[1]]$"am"+snowad.rep[[1]]$"bm"*(20:135))*(1-pnorm(((20:135)-snowad.rep[[1]]$"delta male") / snowad.rep[[1]]$"st_gr"))+ (snowad.rep[[1]]$"am2"+snowad.rep[[1]]$"b1"*(20:135))*pnorm(((20:135) -snowad.rep[[1]]$"delta male")/snowad.rep[[1]]$"st_gr")
  #   mlength[[x]]<-tempM
  #   
  # }
  # 
  # par(mfrow=c(2,1),mar=c(.1,.1,.1,.1),oma=c(4,4,1,1))
  # Finc<-GrowthData[,2]-GrowthData[,1]
  # plot(Finc~GrowthData[,1],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey',xaxt='n')
  # legend(bty='n',"topleft","Female")
  # 
  # for(x in 1:length(Scenarios))
  #   lines(flength[[x]]-c(20:135)~c(20:135),lty=x)
  # 
  # Minc<-GrowthData[,4]-GrowthData[,3]
  # plot(Minc~GrowthData[,3],ylim=c(0,20),xlim=c(20,90),pch=16,col='grey')
  # legend(bty='n',"topleft","Male")
  # mtext(side=2,"Growth increment (mm)",outer=T,line=2)
  # mtext(side=1,"Premolt length (mm)",outer=T,line=2)
  # for(x in 1:length(Scenarios))
  #   lines(mlength[[x]]-c(20:135)~c(20:135),lty=x)
  # legend("bottomright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
```
  
  \newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=10,fig.cap="Model fits to catch data"}
#==mature male biomass==============
#   mcmcRetCat<-matrix(nrow=length(useEval),ncol=(SurvYrN))
#   mcmcTotCat<-matrix(nrow=length(useEval),ncol=(SurvYrN))
#   mcmcDiscCat<-matrix(nrow=length(useEval),ncol=(SurvYrN))
#   mcmcTrawlCat<-matrix(nrow=length(useEval),ncol=(SurvYrN))
#   
#   for(x in 1:length(useEval))
#   {
#     mcmcRetCat[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][16]),split=" ")))[2:(SurvYrN+1)]
#     mcmcTotCat[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][13]),split=" ")))[2:(SurvYrN+1)]
#     mcmcDiscCat[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][14]),split=" ")))[2:(SurvYrN+1)]
#     mcmcTrawlCat[x,]<-as.numeric(unlist(strsplit(unlist(useEval[[x]][17]),split=" ")))[2:(SurvYrN+1)]
#   }
#   
#   mcmcDiscMCat<-mcmcTotCat-mcmcRetCat
# 
#   #==retained catch biomass
#   par(mfrow=c(4,1),mar=c(.1,.1,.3,.1),oma=c(4,4.5,1,1))
#   plot(snowad.rep[[1]]$"Observed retained catch biomass"~RetCatchYrs,las=1,ylab="Retained catch biomass (t)", xaxt="n",pch=20,ylim=c(0,175))
#   legend("topright",bty='n',pch=c(NA,20),lty=c(1,NA),legend=c("Predicted","Observed"))
#   legend("topleft",bty='n',"Retained")
#   
#   sortQuant<-apply(mcmcRetCat,2,sort)
#   TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
#   
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
#   points(snowad.rep[[1]]$"Observed retained catch biomass"~RetCatchYrs,pch=20)
# 
# for(j in 1:length(RetCatchYrs))
# {
#  segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
# 		y0=as.numeric(unlist(snowad.rep[[1]]$"Observed retained catch biomass"))[j]  +   1.96*sdRetCat,
# 		y1=as.numeric(unlist(snowad.rep[[1]]$"Observed retained catch biomass"))[j] - 1.96*sdRetCat)
# }
# 
# 
#     #===discard female biomass
#   plot(snowad.rep[[1]]$"observed female discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n",pch=20,ylim=c(0,0.2))
#   legend("topleft",bty='n',"Discard (female)")
#   
#   sortQuant<-apply(mcmcDiscCat,2,sort)
#   TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
#   
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
#   points(snowad.rep[[1]]$"observed female discard mortality biomass"~RetCatchYrs,pch=20)
# for(j in 1:length(RetCatchYrs))
# {
#  segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
# 		y0=as.numeric(unlist(snowad.rep[[1]]$"observed female discard mortality biomass"))[j]  +   1.96*sdFemDisc,
# 		y1=as.numeric(unlist(snowad.rep[[1]]$"observed female discard mortality biomass"))[j] - 1.96*sdFemDisc)
# }
# 
#   
#   #===discard male biomass
#   plot(snowad.rep[[1]]$"observed male discard mortality biomass"~RetCatchYrs,las=1,ylab="Female discard (t)",xaxt="n",ylim=c(0,30),pch=20)
#   legend("topleft",bty='n',"Discard (male)")
# 
#   sortQuant<-apply(mcmcDiscMCat,2,sort)
#   TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
#   
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
#   points(snowad.rep[[1]]$"observed male discard mortality biomass"~RetCatchYrs,pch=20)
# 
#   for(j in 1:length(RetCatchYrs))
# {
#  segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
# 		y0=as.numeric(unlist(snowad.rep[[1]]$"observed male discard mortality biomass"))[j]  +   1.96*sdTotCat,
# 		y1=as.numeric(unlist(snowad.rep[[1]]$"observed male discard mortality biomass"))[j] - 1.96*sdTotCat)
# }
# 
#   
#   #===trawl catch biomass
#   plot(snowad.rep[[1]]$"observed trawl catch biomass"[1:CatchYrN]~RetCatchYrs,las=1,ylab="Trawl bycatch (t)",xlab="Year",pch=20,ylim=c(0,5))
#   mtext(side=2,outer=T,line=3,"Biomass (t)")
#   mtext(side=1,outer=T,line=2.5,"Year")
# 
#   sortQuant<-apply(mcmcTrawlCat,2,sort)
#   TakeInd<-round(nrow(sortQuant)*c(0.05,.25,.75,.95))
#   
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[1],],rev(sortQuant[TakeInd[4],])),col='light grey',border=F)
#   polygon(x=c(SurveyYrs,rev(SurveyYrs)),y=c(sortQuant[TakeInd[2],],rev(sortQuant[TakeInd[3],])),col='grey',border=F)
#   points(snowad.rep[[1]]$"observed trawl catch biomass"[1:CatchYrN]~RetCatchYrs,pch=20)
#     legend("topleft",bty='n',"Trawl")
#     
# for(j in 1:length(RetCatchYrs))
# {
#  segments(x0=RetCatchYrs[j],x1=RetCatchYrs[j],
# 		y0=as.numeric(unlist(snowad.rep[[1]]$"observed trawl catch biomass"))[j]  +   1.96*sdRetCat,
# 		y1=as.numeric(unlist(snowad.rep[[1]]$"observed trawl catch biomass"))[j] - 1.96*sdRetCat)
# }
  
```
  
  \newpage
  
```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=6,fig.cap="Model fits to pot CPUE data"}
  # plot(snowad.rep[[1]]$"observed pot fishery cpue"~ SurveyYrs[1:(length(SurveyYrs)-1)],ylim=c(0,450),las=1,ylab="",xlab="")
  # for(x in 1:length(Scenarios))
  #   lines(snowad.rep[[x]]$"predicted pot fishery cpue"~SurveyYrs[1:(length(SurveyYrs)-1)],lty=x)
  # legend("topright",bty='n',lty=seq(1,length(Scenarios)),legend=Scenarios)
  # 
  # for(j in 1:length(SurveyYrs))
  # {
  #   segments(x0=SurveyYrs[j],x1=SurveyYrs[j],
  #            y0=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j]  +   1.96*5,
  #            y1=as.numeric(unlist(snowad.rep[[1]]$"observed pot fishery cpue"))[j] - 1.96*5)
  # }
  # 
  # mtext(side=1,"Year",line=2)
  # mtext(side=2,"CPUE",line=2)
  
```
  
































